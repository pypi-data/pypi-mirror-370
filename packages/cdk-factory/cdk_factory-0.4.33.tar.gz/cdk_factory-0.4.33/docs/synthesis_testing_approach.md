# Synthesis-Based Testing Approach

## Overview

This document describes the synthesis-based testing approach for CDK stacks in the cdk-factory project. This approach focuses on testing the actual CloudFormation templates generated by CDK stacks rather than relying heavily on mocking internal methods.

## Why Synthesis Testing?

Traditional unit testing with mocks has several limitations when testing CDK constructs:

1. **Limited Coverage**: Mocking internal methods only verifies that methods are called, not that they produce correct CloudFormation resources.
2. **Fragility**: Tests break when internal implementation details change, even if the resulting CloudFormation template is still correct.
3. **JSII Issues**: CDK constructs often use JSII, which can cause issues with Python mocking frameworks.
4. **Maintenance Burden**: Heavy mocking requires updating tests whenever internal implementation changes.

Synthesis testing addresses these issues by focusing on the actual output of the CDK synthesis process - the CloudFormation template.

## Synthesis Testing Approach

### Core Principles

1. **Test the Output, Not the Implementation**: Focus on verifying the CloudFormation resources and their properties.
2. **Minimal Mocking**: Avoid mocking internal methods; instead, create real CDK constructs and synthesize them.
3. **Verify Resource Properties**: Check that resources have the expected properties based on the input configuration.
4. **Test Configuration Variations**: Test different configurations to ensure they produce the expected resources.

### Testing Process

1. Create a CDK App and the stack to be tested
2. Configure the stack with the desired configuration
3. Build the stack
4. Synthesize the stack to generate a CloudFormation template
5. Verify the template contains the expected resources and properties

### Helper Utilities

The `synth_test_utils.py` module provides helper functions for synthesis testing:

- `get_resources_by_type()`: Find resources of a specific type in the template
- `assert_resource_count()`: Assert that the template contains a specific number of resources of a given type
- `assert_has_resource_with_properties()`: Assert that the template contains a resource with specific properties
- `assert_has_tag()`: Assert that a resource has a specific tag
- `find_tag_value()`: Find the value of a specific tag on a resource
- `print_template_summary()`: Print a summary of the template for debugging

## Example: Testing a VPC Stack

```python
def test_vpc_stack_synth(dummy_workload):
    # Create the app and stack
    app = App()
    stack = VpcStack(app, "TestVpcStack")
    
    # Build the stack with configuration
    stack.build(stack_config, deployment, dummy_workload)
    
    # Synthesize the stack to CloudFormation
    template = app.synth().get_stack_by_name("TestVpcStack").template
    
    # Verify the template has the expected resources
    vpc_resources = get_resources_by_type(template, "AWS::EC2::VPC")
    assert len(vpc_resources) == 1
    
    # Check VPC properties
    vpc_resource = vpc_resources[0]["resource"]
    assert vpc_resource["Properties"]["CidrBlock"] == "10.0.0.0/16"
    
    # Check tags
    tags = vpc_resource["Properties"]["Tags"]
    assert_has_tag(tags, "Name", "test-vpc")
```

## Example: Testing a Security Group Stack

```python
def test_security_group_stack_synth(dummy_workload):
    # Create the app and stack
    app = App()
    stack = SecurityGroupStack(app, "TestSecurityGroupStack")
    
    # Build the stack with configuration
    stack.build(stack_config, deployment, dummy_workload)
    
    # Synthesize the stack to CloudFormation
    template = app.synth().get_stack_by_name("TestSecurityGroupStack").template
    
    # Verify the template has the expected resources
    sg_resources = get_resources_by_type(template, "AWS::EC2::SecurityGroup")
    assert len(sg_resources) == 1
    
    # Check security group properties
    sg_resource = sg_resources[0]["resource"]
    assert sg_resource["Properties"]["GroupDescription"] == "Test security group"
    
    # Check ingress rules
    ingress_rules = sg_resource["Properties"]["SecurityGroupIngress"]
    assert len(ingress_rules) == 1
    assert ingress_rules[0]["FromPort"] == 80
```

## Best Practices

1. **Test Configuration Variations**: Create tests for minimal, typical, and maximal configurations.
2. **Focus on Resource Properties**: Verify that resources have the expected properties based on the input configuration.
3. **Test Resource Relationships**: Verify that resources are correctly linked together (e.g., subnets are in the correct VPC).
4. **Use Helper Functions**: Use the helper functions in `synth_test_utils.py` to simplify tests.
5. **Keep Tests Independent**: Each test should create its own CDK App and stack to avoid interference.

## Migrating from Mock-Based Tests

When migrating from mock-based tests to synthesis-based tests:

1. Create a new test file with the suffix `_synth.py` (e.g., `test_vpc_stack_synth.py`)
2. Create tests that follow the synthesis testing approach
3. Verify that the new tests provide adequate coverage
4. Gradually phase out the mock-based tests

## Limitations

1. **Slower Execution**: Synthesis tests are slower than mock-based tests because they create real CDK constructs and synthesize them.
2. **Memory Usage**: Synthesis tests use more memory because they create real CDK constructs.
3. **Less Granular**: Synthesis tests verify the final output, not intermediate steps or internal logic.

## Conclusion

Synthesis-based testing provides a more robust way to test CDK stacks by focusing on the actual CloudFormation templates generated. This approach reduces the maintenance burden of tests and provides better confidence that the stacks will deploy correctly in production.
