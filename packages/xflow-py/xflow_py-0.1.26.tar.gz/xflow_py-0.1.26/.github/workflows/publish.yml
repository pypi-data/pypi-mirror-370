name: Publish Python Package

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'    # e.g., v0.1.9

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # required for setuptools_scm

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build tools
        run: python -m pip install --upgrade pip build twine setuptools_scm

      - name: "Guard: must be a tag"
        run: |
          if [ "${GITHUB_REF_TYPE}" != "tag" ]; then
            echo "Not a tag build" 
            exit 1
          fi
          echo "Ref: ${GITHUB_REF_NAME}"

      - name: Set version from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Release version: $VERSION"
          echo "SETUPTOOLS_SCM_PRETEND_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Clean build artifacts
        run: rm -rf dist build *.egg-info

      - name: Build distributions
        run: python -m build  # creates dist/*.whl and dist/*.tar.gz

      - name: "Sanity check: wheel name contains tag version"
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          FILE=$(ls dist/*.whl | head -n1)
          echo "Built wheel: $FILE"
          echo "$FILE" | grep -q "$VERSION" || { echo "Version mismatch (expected $VERSION)"; exit 1; }

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: python -m twine upload dist/*