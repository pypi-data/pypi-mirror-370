# ImageOperations

**ImageOperations** ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –Ω–∞–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ —Å —É—á—ë—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
(CPU/GPU/MPS-–∑–∞–≥–ª—É—à–∫–∞). –ú–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ **–±–µ–∑ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏**, –ª–∏–±–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –Ω–µ–±–æ–ª—å—à–∏–º
—Ñ–∞—Å–∞–¥–æ–º —Å **—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ ‚Äî –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
**–ø—Ä–æ–∑—Ä–∞—á–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ CPU**.

- ‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –æ–±—ä–µ–∫—Ç–Ω—ã–π API
- ‚úÖ –í—ã–±–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ (`device="cpu"|"gpu"|"mps"`)
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ñ–æ–ª–±—ç–∫ (GPU/MPS ‚Üí CPU)
- ‚úÖ –¢–∏–ø—ã (PEP 561, `py.typed`)
- ‚úÖ –ß–∏—Å—Ç–∞—è –º–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (`ops/`, `registry`, `device`, `types`)
- üîß –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å: –¥–æ–±–∞–≤–ª—è–π—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –±—ç–∫–µ–Ω–¥—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ API

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** MPS (Apple Metal) –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω –≤ `ComputeDevice`, –Ω–æ —Å–µ–π—á–∞—Å –≤—Å–µ–≥–¥–∞ –ø–∞–¥–∞–µ—Ç –Ω–∞ CPU.

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
poetry add img-ops
# –∏–ª–∏ pip:
# pip install img-ops
```

**Headless-–æ–∫—Ä—É–∂–µ–Ω–∏—è:** –∑–∞–º–µ–Ω–∏—Ç–µ `opencv-python` –Ω–∞ `opencv-python-headless`, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω—ã GUI-—Ñ—É–Ω–∫—Ü–∏–∏.

---

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π API

```python
from img_ops import bgr_to_hsv, in_range, gauss_blur, ComputeDevice

hsv = bgr_to_hsv(img, device="gpu")  # –µ—Å–ª–∏ –µ—Å—Ç—å CUDA; –∏–Ω–∞—á–µ CPU
mask = in_range(hsv, (0, 80, 80), (10, 255, 255))  # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é CPU
blur = gauss_blur(img, (5, 5), 1.2, device=ComputeDevice.CPU)
```

### –≠–∫–∑–µ–º–ø–ª—è—Ä —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

```python
from img_ops import ImageProcessor

proc = ImageProcessor(default_device="gpu")
hsv = proc.bgr_to_hsv(img)  # GPU (—Ñ–æ–ª–±—ç–∫ ‚Üí CPU)
mask = proc.in_range(hsv, (0, 80, 80), (10, 255, 255))  # –∏—Å–ø–æ–ª—å–∑—É–µ—Ç default_device
blur = proc.gauss_blur(img, (5, 5), 1.2, device="cpu")  # –ª–æ–∫–∞–ª—å–Ω—ã–π override ‚Üí CPU
```

---

## –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–Ω–∞—á–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä)

- **–¶–≤–µ—Ç:** `bgr_to_rgb`, `bgr_to_hsv`, `in_range`
- **–§–∏–ª—å—Ç—Ä—ã:** `gauss_blur`
- **–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ CPU):** `find_contours`, `connected_components`
- **–£—Ç–∏–ª–∏—Ç—ã:** `sum_masks` (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–µ–µ—Å—Ç—Ä)

–ù–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `registry.py` + —Ç–æ–Ω–∫–∏–µ –æ–±—ë—Ä—Ç–∫–∏ –≤ `ops/`.

---

## –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

```python
from img_ops import ComputeDevice
# ComputeDevice.GPU  -> CUDA (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
# ComputeDevice.MPS  -> –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ (—Ñ–æ–ª–±—ç–∫ –Ω–∞ CPU)
# ComputeDevice.CPU  -> –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω
```

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ —Ñ–æ–ª–±—ç–∫–∞
- –ó–∞–ø—Ä–æ—Å–∏–ª–∏ `GPU`, –Ω–æ CUDA –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ñ–æ–ª–±—ç–∫ –Ω–∞ `CPU`.
- `MPS` –ø–æ–∫–∞ –≤—Å–µ–≥–¥–∞ —Ñ–æ–ª–±—ç–∫ –Ω–∞ `CPU` (–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä).

---

## –¢–∏–ø—ã

–ü–∞–∫–µ—Ç –ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–∏–ø—ã –∏ `py.typed`.

```python
from img_ops import CvImage, PointHSV

# CvImage: NDArray[uint8 | float32]  # —Ñ–æ—Ä–º–∞ (H,W,3) –∏–ª–∏ (H,W)
# PointHSV: tuple[int, int, int]     # (H, S, V)
```

–§–æ—Ä–º—É (shape) —Ç–∏–ø–∞–º–∏ –Ω–µ —Ñ–∏–∫—Å–∏—Ä—É–µ–º ‚Äî –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–µ–º—Å—è —Å–æ–≥–ª–∞—à–µ–Ω–∏–π.

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ‚Üí `ValueError` —Å–æ —Å–ø–∏—Å–∫–æ–º –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.
- –ù–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–∂–µ –Ω–∞ CPU ‚Üí `NotImplementedError` (–ø–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ —Ñ–æ–ª–±—ç–∫–∞).

---

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

### –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –æ–ø–µ—Ä–∞—Ü–∏—é
1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å CPU/GPU/MPS-–≤–∞—Ä–∏–∞–Ω—Ç—ã –≤ `registry.py` (`_cpu()`, `_gpu()`, `_mps()`).
2. –°–æ–∑–¥–∞—Ç—å —Ç–æ–Ω–∫—É—é –æ–±—ë—Ä—Ç–∫—É –≤ `ops/<category>.py` —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π `device` –∏ –≤—ã–∑–æ–≤–æ–º `dispatch(...)`.
3. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ `ops/__init__.py` –∏ –∫–æ—Ä–Ω–µ–≤–æ–º `__init__.py`.

### –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
1. –†–∞—Å—à–∏—Ä–∏—Ç—å `ComputeDevice` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `OPENCL`, `TORCH`).
2. –î–æ–±–∞–≤–∏—Ç—å —Å–±–æ—Ä—â–∏–∫ —Ä–µ–µ—Å—Ç—Ä–∞ (`_opencl()`), –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫ `REGISTRY`.
3. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤ `device.py` –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –≤ `ops/*.py`.

---

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- GPU –ø–æ–ª–µ–∑–µ–Ω –Ω–∞ –±–æ–ª—å—à–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö/—Ç—è–∂—ë–ª—ã—Ö —è–¥—Ä–∞—Ö; –Ω–∞ –º–µ–ª–∫–∏—Ö –∫–∞–¥—Ä–∞—Ö CPU –º–æ–∂–µ—Ç –±—ã—Ç—å –±—ã—Å—Ç—Ä–µ–µ –∏–∑‚Äë–∑–∞
  –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ upload/download.
- –î–ª—è —Å–ª–æ–∂–µ–Ω–∏—è –º–∞—Å–æ–∫ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ `cv2.add`, –∞ –Ω–µ `a + b` (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å–∞—Ç—É—Ä–∞—Ü–∏—è).

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
poetry run pytest
poetry run mypy src/img_ops
poetry run ruff check .
```

---

## Author

[![Telegram](https://img.shields.io/badge/-Telegram-26A5E4?style=flat&logo=telegram&logoColor=white)](https://t.me/omigutin)
[![GitHub](https://img.shields.io/badge/-GitHub-181717?style=flat&logo=github&logoColor=white)](https://github.com/omigutin)

**–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–µ–∫—Ç:** <https://github.com/omigutin/img_ops>

**–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–µ–∫—Ç–Ω—ã–µ —Ä–∞–±–æ—Ç—ã:** <https://github.com/users/omigutin/projects/4>

**–ö–æ–Ω—Ç–∞–∫—Ç:** [migutin83@yandex.ru](mailto:migutin83@yandex.ru)

---

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT ‚Äî —Å–º. [LICENSE](LICENSE).
