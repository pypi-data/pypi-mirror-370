<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSA Reasoning Engine - Chat Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Roboto:wght@400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #fff;
            height: 100vh;
            overflow: hidden;
        }

        .chat-interface {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 268px;
            background: #f9f9f9;
            padding: 12px;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .user-info {
            background: #fff;
            border-radius: 9999px;
            padding: 6px 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .user-name {
            color: #0a1217;
            font-size: 14.75px;
            font-weight: 500;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 14px;
            height: 36px;
            border-radius: 1000px;
            color: #0a1217cc;
            font-size: 12.9px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .menu-item:hover, .menu-item.active {
            background: #0a12170d;
            color: #0a1217;
        }

        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0 40px;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .model-selector {
            background: #fff;
            border: 1px solid #0a12171a;
            border-radius: 9999px;
            padding: 8px 16px;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            border: 1px solid #0a12171a;
            border-radius: 9999px;
            padding: 8px 16px;
            background: #fff;
            color: #0a1217;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .header-btn:hover {
            background: #f9f9f9;
        }

        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
        }

        .welcome-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex: 1;
            text-align: center;
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: 600;
            color: #0a1217;
            margin-bottom: 20px;
        }

        .welcome-subtitle {
            font-size: 1.1rem;
            color: #64748b;
            margin-bottom: 40px;
            max-width: 600px;
        }

        .message-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
            max-height: calc(100vh - 300px);
        }

        .message {
            margin-bottom: 24px;
            max-width: 80%;
        }

        .user-message {
            background: #f0f4f8;
            padding: 16px 20px;
            border-radius: 16px 16px 4px 16px;
            margin-left: auto;
            margin-right: 0;
            max-width: 70%;
        }

        .assistant-message {
            background: #fff;
            padding: 16px 20px;
            border-radius: 16px 16px 16px 4px;
            border: 1px solid #e2e8f0;
            max-width: 90%;
        }

        .message-text {
            color: #0a1217;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .message-meta {
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
        }

        .stage-info {
            background: #f8fafc;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 12px;
            color: #475569;
            position: relative;
        }

        .stage-info h4 {
            margin: 0 0 8px 0;
            color: #1e293b;
        }

        .stage-timing {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .annotation-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #e2e8f0;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 10px;
            color: #64748b;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .annotation-button:hover {
            background: #cbd5e1;
        }

        .annotation-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: #fff;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .annotation-panel.open {
            right: 0;
        }

        .annotation-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .annotation-header h3 {
            margin: 0 0 8px 0;
            color: #1e293b;
            font-size: 18px;
        }

        .annotation-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .annotation-form {
            border-top: 1px solid #e2e8f0;
            padding: 20px;
        }

        .annotation-item {
            background: #f8fafc;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #3b82f6;
        }

        .annotation-item.question {
            border-left-color: #f59e0b;
        }

        .annotation-item.insight {
            border-left-color: #10b981;
        }

        .annotation-item.correction {
            border-left-color: #ef4444;
        }

        .annotation-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            color: #64748b;
        }

        .annotation-user {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .annotation-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 500;
        }

        .annotation-text {
            color: #1e293b;
            font-size: 14px;
            line-height: 1.5;
        }

        .annotation-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .annotation-action {
            background: none;
            border: none;
            color: #64748b;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .annotation-action:hover {
            background: #e2e8f0;
        }

        .active-users {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .active-user {
            display: flex;
            align-items: center;
            gap: 4px;
            background: #e2e8f0;
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 12px;
            color: #475569;
        }

        .active-user-avatar {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .input-section {
            background: #fff;
            border-radius: 32px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 16px;
            margin-top: 20px;
        }

        .input-container {
            position: relative;
            background: #0a12170d;
            border-radius: 32px;
            min-height: 56px;
            display: flex;
            align-items: center;
            padding: 16px 60px 16px 20px;
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            font-family: Inter;
            font-size: 14px;
            line-height: 24px;
            color: #0a1217;
            resize: none;
            min-height: 24px;
            max-height: 120px;
        }

        .message-input::placeholder {
            color: #0a1217;
            opacity: 0.7;
        }

        .send-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border-radius: 9999px;
            border: none;
            background: #0a1217;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .send-btn:hover:not(:disabled) {
            background: #1a2127;
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .suggestion-buttons {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-top: 8px;
        }

        .suggestion-btn {
            border-top: 1px solid #0a12170d;
            padding: 16px;
            background: transparent;
            border: none;
            text-align: left;
            color: #0a1217;
            font-size: 12.4px;
            line-height: 1.4;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .suggestion-btn:hover {
            opacity: 1;
        }

        .loading-dots {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
        }

        .loading-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #64748b;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes bounce {
            0%, 80%, 100% { 
                transform: scale(0.8);
                opacity: 0.5;
            } 40% { 
                transform: scale(1);
                opacity: 1;
            }
        }

        .icon {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="chat-interface">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <span class="user-name">MSA Reasoning</span>
                </div>
            </div>
            
            <div class="sidebar-menu">
                <div class="menu-item active">
                    <svg class="icon" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                    </svg>
                    New Chat
                </div>
                <div class="menu-item">
                    <svg class="icon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                    </svg>
                    History
                </div>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="chat-section">
            <div class="chat-header">
                <div class="model-selector">
                    MSA Reasoning Engine v2
                </div>
                <div class="header-actions">
                    <button class="header-btn">Share</button>
                    <button class="header-btn">Help</button>
                </div>
            </div>

            <div class="chat-content">
                <!-- Welcome Section -->
                <div id="welcome-section" class="welcome-section">
                    <h1 class="welcome-title">MSA Reasoning Engine</h1>
                    <p class="welcome-subtitle">
                        Ask me complex questions and I'll analyze them through a sophisticated 5-stage reasoning pipeline
                    </p>
                </div>

                <!-- Message List -->
                <div id="message-list" class="message-list hidden"></div>

                <!-- Input Section -->
                <div class="input-section">
                    <div class="input-container">
                        <textarea 
                            id="message-input"
                            class="message-input"
                            placeholder="Ask about complex scenarios, decision-making, or analytical questions..."
                            rows="1"
                        ></textarea>
                        <button id="send-btn" class="send-btn" disabled>
                            <svg class="icon" viewBox="0 0 16 16" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.71179 2.211C8.46779 1.968 8.28179 1.875 8.01579 1.875C7.74879 1.875 7.53979 1.991 7.31979 2.211L3.26979 6.25C3.18725 6.33169 3.12217 6.4293 3.0785 6.53692C3.03484 6.64453 3.01351 6.75989 3.01579 6.876C3.01579 7.375 3.39779 7.746 3.89679 7.746C4.01554 7.7461 4.13311 7.72254 4.24266 7.67669C4.3522 7.63085 4.45151 7.56365 4.53479 7.479L6.00979 5.993L7.21579 4.543L7.12279 7.083V13.29C7.12279 13.824 7.49479 14.195 8.01679 14.195C8.54979 14.195 8.92179 13.812 8.92179 13.29V7.084L8.81679 4.554L10.0238 5.994L11.4968 7.478C11.6708 7.629 11.8908 7.745 12.1468 7.745C12.6448 7.745 13.0168 7.374 13.0168 6.875C13.0209 6.75954 13.0014 6.64445 12.9594 6.5368C12.9175 6.42916 12.854 6.33122 12.7728 6.249L8.71179 2.211Z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Suggestions -->
                    <div id="suggestion-buttons" class="suggestion-buttons">
                        <button class="suggestion-btn" onclick="insertSuggestion(this)">
                            What factors influence a basketball team's performance in the playoffs?
                        </button>
                        <button class="suggestion-btn" onclick="insertSuggestion(this)">
                            Analyze the decision-making process for expanding a business internationally
                        </button>
                        <button class="suggestion-btn" onclick="insertSuggestion(this)">
                            What are the key considerations for launching a new product in a competitive market?
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Annotation Panel -->
    <div class="overlay" id="annotation-overlay" onclick="closeAnnotations()"></div>
    <div class="annotation-panel" id="annotation-panel">
        <div class="annotation-header">
            <h3>Annotations</h3>
            <p>Collaborate on reasoning analysis</p>
            <button onclick="closeAnnotations()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
        </div>
        
        <div class="annotation-content">
            <!-- Active Users -->
            <div class="active-users" id="active-users">
                <!-- Active users will be populated here -->
            </div>
            
            <!-- Annotations List -->
            <div id="annotations-list">
                <!-- Annotations will be populated here -->
            </div>
        </div>
        
        <!-- Annotation Form -->
        <div class="annotation-form">
            <select id="annotation-type" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #e2e8f0; border-radius: 4px;">
                <option value="comment">Comment</option>
                <option value="question">Question</option>
                <option value="insight">Insight</option>
                <option value="correction">Correction</option>
                <option value="suggestion">Suggestion</option>
            </select>
            <textarea 
                id="annotation-text" 
                placeholder="Add your annotation..."
                style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; min-height: 60px; resize: vertical; margin-bottom: 8px;"
            ></textarea>
            <button 
                onclick="submitAnnotation()"
                style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; width: 100%;"
            >
                Add Annotation
            </button>
        </div>
    </div>

    <script>
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const messageList = document.getElementById('message-list');
        const welcomeSection = document.getElementById('welcome-section');
        const suggestionButtons = document.getElementById('suggestion-buttons');
        
        let isLoading = false;
        let messages = [];

        messageInput.addEventListener('input', function() {
            sendBtn.disabled = !this.value.trim() || isLoading;
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', sendMessage);

        function insertSuggestion(button) {
            messageInput.value = button.textContent.trim();
            messageInput.dispatchEvent(new Event('input'));
            messageInput.focus();
        }

        function formatMessage(content) {
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^• (.+)$/gm, '<div style="margin-left: 16px;">• $1</div>')
                .replace(/\n/g, '<br>');
        }

        function addMessage(type, content, isLoading = false, data = null) {
            const messageId = Date.now().toString();
            const message = {
                id: messageId,
                type,
                content,
                timestamp: new Date(),
                isLoading,
                data
            };

            messages.push(message);
            renderMessages();
            scrollToBottom();
        }

        function updateLastMessage(content, data = null) {
            if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                lastMessage.content = content;
                lastMessage.isLoading = false;
                lastMessage.data = data;
                renderMessages();
                scrollToBottom();
            }
        }

        function renderMessages() {
            if (messages.length === 0) {
                welcomeSection.classList.remove('hidden');
                messageList.classList.add('hidden');
                suggestionButtons.classList.remove('hidden');
                return;
            }

            welcomeSection.classList.add('hidden');
            messageList.classList.remove('hidden');
            suggestionButtons.classList.add('hidden');

            messageList.innerHTML = messages.map(message => {
                const messageClass = message.type === 'user' ? 'user-message' : 'assistant-message';
                const formattedContent = formatMessage(message.content);
                
                let metaInfo = '';
                if (message.data && message.data.confidence !== undefined) {
                    metaInfo += `<div class="message-meta">Confidence: ${(message.data.confidence * 100).toFixed(1)}%</div>`;
                }
                
                if (message.data && message.data.stages && message.data.stages.length > 0) {
                    metaInfo += `<div class="stage-info">
                        <button class="annotation-button" onclick="openAnnotations('${message.id}')">+ Annotate</button>
                        <h4>Processing Stages:</h4>`;
                    message.data.stages.forEach(stage => {
                        if (stage.execution_time !== undefined) {
                            metaInfo += `<div class="stage-timing" data-stage="${stage.stage}">
                                <span>${stage.stage}</span>
                                <span>${stage.execution_time.toFixed(2)}s (${(stage.confidence * 100).toFixed(1)}%)</span>
                            </div>`;
                        }
                    });
                    metaInfo += '</div>';
                }

                const loadingDots = message.isLoading ? 
                    '<span class="loading-dots"><span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span></span>' : '';

                return `
                    <div class="message">
                        <div class="${messageClass}">
                            <div class="message-text">${formattedContent}${loadingDots}</div>
                            ${metaInfo}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function scrollToBottom() {
            messageList.scrollTop = messageList.scrollHeight;
        }

        async function sendMessage() {
            const inputValue = messageInput.value.trim();
            if (!inputValue || isLoading) return;

            // Add user message
            addMessage('user', inputValue);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            sendBtn.disabled = true;
            isLoading = true;

            // Add loading message
            addMessage('assistant', '🧠 Analyzing your query through the 5-stage MSA Reasoning Engine...\n\n⏳ Parse → Retrieve → Graph → Synthesize → Infer', true);

            try {
                const response = await fetch('/api/v2/reasoning/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        vignette: inputValue,
                        data: { context: 'chat_interface' },
                        session_id: `chat_${Date.now()}`,
                    }),
                });

                const result = await response.json();

                // Remove loading message
                messages.pop();

                let responseContent = '';
                
                if (result.success) {
                    responseContent = `# 🧠 MSA Reasoning Analysis Complete\n\n`;
                    
                    // Display comprehensive reasoning results
                    responseContent += `## 📊 Overall Analysis\n`;
                    responseContent += `**Confidence Score:** ${(result.overall_confidence * 100).toFixed(1)}%\n`;
                    responseContent += `**Processing Time:** ${result.total_execution_time.toFixed(2)} seconds\n`;
                    responseContent += `**Reasoning Chain ID:** ${result.reasoning_chain_id || 'N/A'}\n\n`;
                    
                    // Stage-by-stage results
                    if (result.stages && Object.keys(result.stages).length > 0) {
                        responseContent += `## 🔍 Five-Stage Reasoning Pipeline\n\n`;
                        
                        // Parse Stage
                        if (result.stages.parse) {
                            const parseStage = result.stages.parse;
                            responseContent += `### 1️⃣ Parse Stage\n`;
                            responseContent += `**Confidence:** ${(parseStage.confidence * 100).toFixed(1)}%\n`;
                            responseContent += `**Time:** ${parseStage.execution_time?.toFixed(2) || '0.00'}s\n\n`;
                            
                            if (result.parsed_elements) {
                                if (result.parsed_elements.entities?.length > 0) {
                                    responseContent += `**Entities Identified:** ${result.parsed_elements.entities.map(e => e.content).join(', ')}\n`;
                                }
                                if (result.parsed_elements.constraints?.length > 0) {
                                    responseContent += `**Constraints Found:** ${result.parsed_elements.constraints.map(c => c.content).join(', ')}\n`;
                                }
                                if (result.parsed_elements.queries?.length > 0) {
                                    responseContent += `**Key Questions:** ${result.parsed_elements.queries.map(q => q.content).join(', ')}\n`;
                                }
                            }
                            responseContent += '\n';
                        }
                        
                        // Retrieve Stage
                        if (result.stages.retrieve) {
                            const retrieveStage = result.stages.retrieve;
                            responseContent += `### 2️⃣ Retrieve Stage\n`;
                            responseContent += `**Confidence:** ${(retrieveStage.confidence * 100).toFixed(1)}%\n`;
                            responseContent += `**Time:** ${retrieveStage.execution_time?.toFixed(2) || '0.00'}s\n`;
                            if (result.retrieved_knowledge?.length > 0) {
                                responseContent += `**Knowledge Sources:** ${result.retrieved_knowledge.length} relevant documents found\n`;
                            } else {
                                responseContent += `**Knowledge Sources:** No prior knowledge retrieved (new scenario)\n`;
                            }
                            responseContent += '\n';
                        }
                        
                        // Graph Stage
                        if (result.stages.graph) {
                            const graphStage = result.stages.graph;
                            responseContent += `### 3️⃣ Graph Stage\n`;
                            responseContent += `**Confidence:** ${(graphStage.confidence * 100).toFixed(1)}%\n`;
                            responseContent += `**Time:** ${graphStage.execution_time?.toFixed(2) || '0.00'}s\n`;
                            if (result.dependency_graph?.nodes?.length > 0) {
                                responseContent += `**Dependency Analysis:** ${result.dependency_graph.nodes.length} factors, ${result.dependency_graph.edges?.length || 0} relationships\n`;
                                responseContent += `**Key Factors:** ${result.dependency_graph.nodes.slice(0, 3).map(n => n.label).join(', ')}${result.dependency_graph.nodes.length > 3 ? '...' : ''}\n`;
                            }
                            responseContent += '\n';
                        }
                        
                        // Synthesize Stage
                        if (result.stages.synthesize) {
                            const synthesizeStage = result.stages.synthesize;
                            responseContent += `### 4️⃣ Synthesize Stage\n`;
                            responseContent += `**Confidence:** ${(synthesizeStage.confidence * 100).toFixed(1)}%\n`;
                            responseContent += `**Time:** ${synthesizeStage.execution_time?.toFixed(2) || '0.00'}s\n`;
                            if (result.probabilistic_program) {
                                responseContent += `**Model Generated:** ${result.probabilistic_program.validation_status ? '✅' : '❌'} Probabilistic program\n`;
                                if (result.probabilistic_program.program_lines) {
                                    responseContent += `**Code Lines:** ${result.probabilistic_program.program_lines}\n`;
                                }
                            }
                            responseContent += '\n';
                        }
                        
                        // Infer Stage
                        if (result.stages.infer) {
                            const inferStage = result.stages.infer;
                            responseContent += `### 5️⃣ Infer Stage\n`;
                            responseContent += `**Confidence:** ${(inferStage.confidence * 100).toFixed(1)}%\n`;
                            responseContent += `**Time:** ${inferStage.execution_time?.toFixed(2) || '0.00'}s\n`;
                            if (result.inferences?.length > 0) {
                                responseContent += `**Inferences Generated:** ${result.inferences.length} key insights\n`;
                                result.inferences.slice(0, 3).forEach((inf, i) => {
                                    responseContent += `${i + 1}. ${inf.description} (${(inf.confidence * 100).toFixed(1)}% confidence)\n`;
                                });
                            }
                            responseContent += '\n';
                        }
                    }
                    
                    // Summary insights
                    if (result.summary_insights) {
                        responseContent += `## 💡 Key Insights\n`;
                        responseContent += `${result.summary_insights}\n\n`;
                    }
                    
                    // Show reasoning quality
                    const confidenceLevel = result.overall_confidence >= 0.8 ? 'High' : 
                                          result.overall_confidence >= 0.6 ? 'Medium' : 'Low';
                    responseContent += `## 🎯 Reasoning Quality: ${confidenceLevel}\n`;
                    responseContent += `This analysis used advanced probabilistic reasoning and dependency modeling to provide comprehensive insights into your scenario.`;
                    
                } else {
                    responseContent = `## ❌ Analysis Failed\n\n`;
                    responseContent += `I encountered some challenges analyzing your query:\n\n`;
                    responseContent += `**Error:** ${result.error_message || 'Unknown error occurred'}\n\n`;
                    responseContent += `Please try rephrasing your question or providing more context. The system works best with specific scenarios that involve decision-making or uncertainty.`;
                }

                addMessage('assistant', responseContent, false, {
                    confidence: result.overall_confidence,
                    stages: result.stages,
                    reasoning_chain_id: result.reasoning_chain_id,
                    data: result  // Store full result data for annotations
                });

            } catch (error) {
                // Remove loading message
                messages.pop();
                
                addMessage('assistant', 'Sorry, I encountered an error while processing your request. Please make sure the MSA Reasoning Engine is running and try again.');
            } finally {
                isLoading = false;
                sendBtn.disabled = false;
            }
        }

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Annotation System
        let currentReasoningChainId = null;
        let annotationWebSocket = null;
        let annotations = [];
        let activeUsers = [];
        
        // Current user (generated unique ID for demo)
        // Generate a cryptographically secure random user ID and name
        function generateSecureId() {
            // 8 random bytes = 64 bits, enough for uniqueness
            const array = new Uint8Array(8);
            window.crypto.getRandomValues(array);
            // Convert to base36 string
            // Convert to hex string
            return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
        }
        function generateSecureNumber(max) {
            // To avoid modulo bias, we generate a random number in a range that is a multiple of `max`.
            const range = 2**32;
            const maxAllowed = Math.floor(range / max) * max;
            const array = new Uint32Array(1);
            
            do {
                window.crypto.getRandomValues(array);
            } while (array[0] >= maxAllowed);
            
            // Simpler approach: negligible bias for small max (e.g., 100)
            const array = new Uint32Array(1);
            window.crypto.getRandomValues(array);
            return Math.floor((array[0] / (2 ** 32)) * max);
        }
        const currentUser = {
            id: 'user_' + generateSecureId(),
            name: 'User ' + generateSecureNumber(100),
            avatar_url: null,
            color: '#3B82F6'
        };

        function openAnnotations(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (!message || !message.data) return;
            
            currentReasoningChainId = message.data.reasoning_chain_id || messageId;
            
            // Show annotation panel
            document.getElementById('annotation-panel').classList.add('open');
            document.getElementById('annotation-overlay').classList.add('active');
            
            // Connect to WebSocket for real-time updates
            connectAnnotationWebSocket();
            
            // Load existing annotations
            loadAnnotations();
            
            // Join the chain as active user
            joinReasoningChain();
        }

        function closeAnnotations() {
            document.getElementById('annotation-panel').classList.remove('open');
            document.getElementById('annotation-overlay').classList.remove('active');
            
            // Disconnect WebSocket
            if (annotationWebSocket) {
                annotationWebSocket.close();
                annotationWebSocket = null;
            }
        }

        function connectAnnotationWebSocket() {
            if (!currentReasoningChainId || annotationWebSocket) return;
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/v2/annotations/ws/${currentReasoningChainId}`;
            
            annotationWebSocket = new WebSocket(wsUrl);
            
            annotationWebSocket.onopen = function() {
                console.log('Annotation WebSocket connected');
                // Send user activity ping
                annotationWebSocket.send(JSON.stringify({
                    type: 'user_activity',
                    user: currentUser
                }));
            };
            
            annotationWebSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleAnnotationEvent(data);
            };
            
            annotationWebSocket.onclose = function() {
                console.log('Annotation WebSocket disconnected');
            };
            
            annotationWebSocket.onerror = function(error) {
                console.error('Annotation WebSocket error:', error);
            };
        }

        function handleAnnotationEvent(event) {
            switch (event.type) {
                case 'annotation_created':
                    annotations.push(event.annotation);
                    renderAnnotations();
                    break;
                case 'annotation_updated':
                    const index = annotations.findIndex(a => a.id === event.annotation.id);
                    if (index !== -1) {
                        annotations[index] = event.annotation;
                        renderAnnotations();
                    }
                    break;
                case 'annotation_deleted':
                    annotations = annotations.filter(a => a.id !== event.annotation_id);
                    renderAnnotations();
                    break;
                case 'user_joined':
                case 'user_activity':
                    updateActiveUsers(event.user);
                    break;
                case 'reply_added':
                    const annIndex = annotations.findIndex(a => a.id === event.annotation.id);
                    if (annIndex !== -1) {
                        annotations[annIndex] = event.annotation;
                        renderAnnotations();
                    }
                    break;
            }
        }

        async function loadAnnotations() {
            if (!currentReasoningChainId) return;
            
            try {
                const response = await fetch(`/api/v2/annotations/chain/${currentReasoningChainId}`);
                if (response.ok) {
                    annotations = await response.json();
                    renderAnnotations();
                }
            } catch (error) {
                console.error('Failed to load annotations:', error);
            }
        }

        async function submitAnnotation() {
            const type = document.getElementById('annotation-type').value;
            const content = document.getElementById('annotation-text').value.trim();
            
            if (!content || !currentReasoningChainId) return;
            
            const request = {
                reasoning_chain_id: currentReasoningChainId,
                type: type,
                target: 'full_chain',
                position: {
                    stage: null,
                    element_id: null
                },
                content: content,
                user: currentUser
            };
            
            try {
                const response = await fetch('/api/v2/annotations/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(request)
                });
                
                if (response.ok) {
                    document.getElementById('annotation-text').value = '';
                    // Annotation will be added via WebSocket event
                }
            } catch (error) {
                console.error('Failed to create annotation:', error);
            }
        }

        async function joinReasoningChain() {
            if (!currentReasoningChainId) return;
            
            try {
                await fetch(`/api/v2/annotations/chain/${currentReasoningChainId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentUser)
                });
            } catch (error) {
                console.error('Failed to join reasoning chain:', error);
            }
        }

        function updateActiveUsers(user) {
            const existingIndex = activeUsers.findIndex(u => u.id === user.id);
            if (existingIndex !== -1) {
                activeUsers[existingIndex] = user;
            } else {
                activeUsers.push(user);
            }
            renderActiveUsers();
        }

        function renderActiveUsers() {
            const container = document.getElementById('active-users');
            container.innerHTML = activeUsers.map(user => `
                <div class="active-user">
                    <div class="active-user-avatar" style="background: ${user.color}">
                        ${user.name.charAt(0).toUpperCase()}
                    </div>
                    <span>${user.name}</span>
                </div>
            `).join('');
        }

        function renderAnnotations() {
            const container = document.getElementById('annotations-list');
            
            if (annotations.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">No annotations yet. Be the first to add one!</p>';
                return;
            }
            
            container.innerHTML = annotations.map(annotation => {
                const timeAgo = formatTimeAgo(new Date(annotation.created_at));
                const replies = annotation.replies || [];
                
                return `
                    <div class="annotation-item ${annotation.type}">
                        <div class="annotation-meta">
                            <div class="annotation-user">
                                <div class="annotation-avatar" style="background: ${annotation.user.color}">
                                    ${annotation.user.name.charAt(0).toUpperCase()}
                                </div>
                                <span>${annotation.user.name}</span>
                            </div>
                            <span>${timeAgo}</span>
                        </div>
                        
                        <div class="annotation-text">${annotation.content}</div>
                        
                        <div class="annotation-actions">
                            <button class="annotation-action" onclick="voteAnnotation('${annotation.id}', true)">
                                👍 ${annotation.votes || 0}
                            </button>
                            <button class="annotation-action" onclick="showReplyForm('${annotation.id}')">
                                💬 Reply (${replies.length})
                            </button>
                            ${annotation.user.id === currentUser.id ? 
                                `<button class="annotation-action" onclick="deleteAnnotation('${annotation.id}')">🗑️ Delete</button>` : ''
                            }
                        </div>
                        
                        ${replies.length > 0 ? `
                            <div style="margin-top: 12px; padding-left: 16px; border-left: 2px solid #e2e8f0;">
                                ${replies.map(reply => `
                                    <div style="margin-bottom: 8px; font-size: 12px;">
                                        <strong>${reply.user.name}:</strong> ${reply.content}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div id="reply-form-${annotation.id}" style="display: none; margin-top: 8px;">
                            <input type="text" id="reply-text-${annotation.id}" placeholder="Write a reply..." 
                                   style="width: 100%; padding: 6px; border: 1px solid #e2e8f0; border-radius: 4px; margin-bottom: 4px;">
                            <button onclick="submitReply('${annotation.id}')" 
                                    style="background: #10b981; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                Reply
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function voteAnnotation(annotationId, vote) {
            try {
                await fetch(`/api/v2/annotations/${annotationId}/vote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        vote: vote,
                        user_id: currentUser.id
                    })
                });
            } catch (error) {
                console.error('Failed to vote on annotation:', error);
            }
        }

        function showReplyForm(annotationId) {
            const form = document.getElementById(`reply-form-${annotationId}`);
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        async function submitReply(annotationId) {
            const textInput = document.getElementById(`reply-text-${annotationId}`);
            const content = textInput.value.trim();
            
            if (!content) return;
            
            try {
                await fetch(`/api/v2/annotations/${annotationId}/reply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        user: currentUser
                    })
                });
                
                textInput.value = '';
                document.getElementById(`reply-form-${annotationId}`).style.display = 'none';
            } catch (error) {
                console.error('Failed to add reply:', error);
            }
        }

        async function deleteAnnotation(annotationId) {
            if (!confirm('Are you sure you want to delete this annotation?')) return;
            
            try {
                await fetch(`/api/v2/annotations/${annotationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentUser)
                });
            } catch (error) {
                console.error('Failed to delete annotation:', error);
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 1) return 'just now';
            if (minutes < 60) return `${minutes}m ago`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        // Keep WebSocket connection alive
        setInterval(() => {
            if (annotationWebSocket && annotationWebSocket.readyState === WebSocket.OPEN) {
                annotationWebSocket.send(JSON.stringify({ type: 'ping' }));
            }
        }, 30000);
    </script>
</body>
</html>