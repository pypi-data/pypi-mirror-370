import{r as e,j as t,a}from"./react-Blzc5Mwu.js";import{R as s}from"./react-dom-CqFGak3y.js";import{l as r,s as i,W as o,i as n,a as l}from"./@waldiez-CVEviApX.js";import{i as c,T as m,U as d,V as p,W as u,X as h,Y as f,Z as j,_ as w,$ as g,a0 as y,a1 as x,a2 as v,a3 as k,a4 as b,a5 as N,a6 as C,a7 as I,a8 as E,a9 as R,aa as S,ab as z,ac as P,ad as U,ae as D,af as M,x as T,ag as $}from"./react-icons-D3IIfPOd.js";import{a as F}from"./axios-DpIj8wd6.js";import{u as A}from"./react-use-websocket-Cs7L8JZN.js";import"./es-toolkit-DjuajZ5e.js";import"./scheduler-6ULW7vKx.js";import"./strip-ansi-C8ZQUz1t.js";import"./ansi-regex-BsH-3-MG.js";import"./nanoid-DjdYu-xF.js";import"./jszip-tC6HmzaA.js";import"./@xyflow-DPPZQ5VV.js";import"./classcat-Dkggfwne.js";import"./d3-zoom-BGyjh1fS.js";import"./d3-transition-B69S2akk.js";import"./d3-timer-CJv_AqWU.js";import"./d3-dispatch-Q6TpkW-B.js";import"./d3-interpolate-BVPFJ5Mw.js";import"./d3-color-DoYtpBXr.js";import"./d3-selection-DXmtSzok.js";import"./d3-ease-Cx6bG2vu.js";import"./d3-drag-BF3c7Yc5.js";import"./use-sync-external-store-CgY8d70i.js";import"./react-error-boundary-CeM4sHcf.js";import"./react-hotkeys-hook-7qYZ9wf6.js";import"./@monaco-editor-iKZ8mwPW.js";import"./state-local-DHPJ_3N6.js";import"./zustand-BNK_jdYz.js";import"./microdiff-DL1uJ6tv.js";import"./zundo-B8IY5gof.js";import"./react-select-C6gawzTk.js";import"./@babel-BRcaFajx.js";import"./@emotion-BdPyG1Qg.js";import"./hoist-non-react-statics-CmA2CWkd.js";import"./stylis-h7b_IEWc.js";import"./@floating-ui-Bpiu8gA8.js";import"./use-isomorphic-layout-effect-DEoD96b_.js";import"./memoize-one-BAtLgO95.js";import"./recharts-BceAJRcY.js";import"./clsx-BeLtu-UY.js";import"./react-markdown-uEkr9PZa.js";import"./devlop-Cl3hj7Sz.js";import"./unified-Prs1Hanf.js";import"./bail-gCPcOVbC.js";import"./extend-C_e0Jtue.js";import"./is-plain-obj-DeEdtHJQ.js";import"./trough-zzWXwSIo.js";import"./vfile-DZOtiVP5.js";import"./vfile-message-CcBGs8D9.js";import"./unist-util-stringify-position-CvSG9YTx.js";import"./remark-parse-DY0gzotZ.js";import"./mdast-util-from-markdown-qQprfQAh.js";import"./micromark-util-decode-numeric-character-reference-DA7xEauU.js";import"./micromark-util-decode-string-DnyHiccs.js";import"./decode-named-character-reference-C-EXV6yX.js";import"./micromark-util-normalize-identifier-CzKtq1sx.js";import"./micromark-bsuYomFM.js";import"./micromark-util-combine-extensions-DQ8C0oVl.js";import"./micromark-util-chunked-3k3e5hER.js";import"./micromark-factory-space-O0Sojo8n.js";import"./micromark-util-character-DUwsRT9L.js";import"./micromark-core-commonmark-BjKFe3K_.js";import"./micromark-util-classify-character-D70wJgn_.js";import"./micromark-util-resolve-all-U8fstr8o.js";import"./micromark-util-subtokenize-C06FymM9.js";import"./micromark-factory-destination-BHH2yab9.js";import"./micromark-factory-label-DjeXs6Ea.js";import"./micromark-factory-title-BXLgJ_g7.js";import"./micromark-factory-whitespace-BkjrQByO.js";import"./micromark-util-html-tag-name-DbKNfynz.js";import"./mdast-util-to-string-Ck87fAyN.js";import"./remark-rehype-Bba-wcVv.js";import"./mdast-util-to-hast-CxG0hrDP.js";import"./@ungap-DadG6O39.js";import"./micromark-util-sanitize-uri-BWVGcVPt.js";import"./unist-util-position-CVUg9P9R.js";import"./trim-lines-C03Dth7Y.js";import"./unist-util-visit-BGZk_7Z4.js";import"./unist-util-visit-parents-DrBR4cjY.js";import"./unist-util-is-C5Jwnfs7.js";import"./hast-util-to-jsx-runtime-CDpdgdOi.js";import"./comma-separated-tokens-DIu3lqJt.js";import"./property-information-BIQMWFDR.js";import"./space-separated-tokens-C97BfSlU.js";import"./style-to-js-Cdc6ouuC.js";import"./style-to-object-Drm57gnD.js";import"./inline-style-parser-D8_Zmyug.js";import"./hast-util-whitespace-DlJMGLAz.js";import"./estree-util-is-identifier-name-0h9-8Xae.js";import"./html-url-attributes-BA_i5Yxb.js";import"./rehype-highlight-CFr_QXqA.js";import"./lowlight-C_g4LpzN.js";import"./highlight.js-BhowV8g0.js";import"./hast-util-to-text-BqqhDKvp.js";import"./hast-util-is-element-Djts9Lmg.js";import"./unist-util-find-after-DC3iJzYV.js";import"./remark-gfm-D6SFZ-yu.js";import"./micromark-extension-gfm-D6ke1pJ_.js";import"./micromark-extension-gfm-autolink-literal-CAZrQ6Ew.js";import"./micromark-extension-gfm-footnote-oiA1MrCk.js";import"./micromark-extension-gfm-strikethrough-D-1Of1Ef.js";import"./micromark-extension-gfm-table-BfKMMIFy.js";import"./micromark-extension-gfm-task-list-item-Bctfj89z.js";import"./mdast-util-gfm-Dc8WEYZO.js";import"./mdast-util-gfm-autolink-literal-CV8rYkCl.js";import"./ccount-D181NsKZ.js";import"./mdast-util-find-and-replace-CCgQ2cpI.js";import"./mdast-util-gfm-footnote-Cugz-_6P.js";import"./mdast-util-gfm-strikethrough-CppM9lzQ.js";import"./mdast-util-gfm-table-CfHUi3P6.js";import"./markdown-table-qiBROtQo.js";import"./mdast-util-to-markdown-CTgpsuc0.js";import"./longest-streak-2qYzcRvv.js";import"./mdast-util-phrasing-Bu1DMNL2.js";import"./mdast-util-gfm-task-list-item-B6deDowo.js";import"./framer-motion-DWU9UHPJ.js";import"./motion-dom-C7-7PQmT.js";import"./motion-utils-CdjEVO9u.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const a of e)if("childList"===a.type)for(const e of a.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const L=({onNewFile:a,onNewFolder:s,onUpload:r})=>{const i=e.useRef(null);return t.jsxs("div",{className:"actions-buttons",children:[t.jsxs("button",{className:"action-button",onClick:a,children:[t.jsx(c,{"aria-hidden":"true"}),"New Flow"]}),t.jsxs("button",{className:"action-button",onClick:s,children:[t.jsx(c,{"aria-hidden":"true"}),"New Folder"]}),t.jsxs("button",{"data-testid":"upload-button",className:"action-button",onClick:()=>i.current?.click(),children:[t.jsx(m,{"aria-hidden":"true"}),"Upload"]}),t.jsx("input",{title:"Upload File","data-testid":"file-input",type:"file",ref:i,style:{display:"none"},onChange:async e=>{if(!e.target.files||0===e.target.files.length)return;const t=e.target.files[0];try{await r(t)}catch(a){}finally{e.target.value=""}}})]})},O=({isSidebarVisible:e,refresh:a,loading:s,toggleSidebar:r})=>t.jsxs("div",{className:"file-browser-toggle",style:{justifyContent:e?"space-between":"center"},children:[e&&t.jsxs("div",{className:"file-browser-header",children:[t.jsx("h3",{children:"Workspace"}),t.jsx("button",{onClick:a,disabled:s,title:"Refresh","data-testid":"refresh-button","aria-label":"Refresh",className:"file-browser-refresh",style:{cursor:s?"not-allowed":"pointer",opacity:s?.7:1},children:s?t.jsx(d,{"aria-hidden":"true",className:"spinner"}):t.jsx(p,{"aria-hidden":"true"})})]}),t.jsx(u,{role:"button",className:"file-browser-toggle-icon",onClick:r,"aria-hidden":"true"})]}),W=a=>{const{item:s,currentPath:i,onDelete:o,onRename:n,onClick:l,onDownload:c}=a,[m,d]=e.useState(!1),[p,u]=e.useState(s.name),[U,D]=e.useState(!1),[M,T]=e.useState(null),$=e.useRef(null),F=(e=>{const a=e.split(".").pop(),s="path-item-icon";if(!a)return t.jsx(h,{className:s});switch(a){case"waldiez":case"waldiezModel":case"waldiezSkill":case"waldiezAgent":return t.jsx("img",{src:r,className:`${s} waldiez-file`,alt:"logo",title:"Waldiez Flow"});case"xml":return t.jsx(P,{className:s,title:"XML"});case"txt":case"doc":case"docx":return t.jsx(z,{className:s,title:"Text"});case"pdf":return t.jsx(S,{className:s,title:"PDF"});case"jpg":case"jpeg":case"png":case"gif":case"bmp":case"webp":case"svg":case"ico":case"tiff":return t.jsx(R,{className:s,title:"Image"});case"mp3":case"wav":case"ogg":case"flac":case"aac":case"wma":case"m4a":case"aiff":case"alac":return t.jsx(E,{className:s,title:"Audio"});case"mp4":case"avi":case"mov":case"wmv":case"flv":case"mkv":case"webm":case"mpeg":case"3gp":return t.jsx(I,{className:s,title:"Video"});case"zip":case"rar":case"tar":case"gz":case"bz2":case"7z":case"xz":return t.jsx(C,{className:s,title:"Archive"});case"py":case"pyc":case"pyo":case"pyd":return t.jsx(N,{className:s,title:"Python"});case"php":return t.jsx(b,{className:s,title:"PHP"});case"java":case"jar":return t.jsx(k,{className:s,title:"Java"});case"ipynb":return t.jsx(v,{className:s,title:"Jupyter Notebook"});case"json":return t.jsx(x,{className:s,title:"JSON"});case"yaml":case"yml":return t.jsx(y,{className:s,title:"YAML"});case"md":return t.jsx(g,{className:s,title:"Markdown"});case"sqlite":case"db":return t.jsx(w,{className:s,title:"SQLite"});case"js":case"jsx":case"mjs":case"cjs":return t.jsx(j,{className:s,title:"JavaScript"});case"ts":case"tsx":case"html":case"css":case"scss":case"less":case"toml":case"ini":case"env":case"sh":case"bat":case"cmd":case"ps1":case"psm1":case"bash":case"zsh":case"fish":case"kt":case"kts":case"c":case"cpp":case"h":case"hpp":case"cs":case"go":case"rb":case"rs":case"clj":case"edn":case"scala":case"groovy":case"pl":case"pm":return t.jsx(f,{className:s,title:"Code"});default:return t.jsx(h,{className:s,title:"File"})}})(s.name);e.useEffect(()=>{u(s.name)},[s]),e.useEffect(()=>{const e=e=>{U&&$.current&&!$.current.contains(e.target)&&O()};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[U]);const A=()=>{if("folder"===s.type&&".."===s.name)return!0;const e=s.path;return"folder"===s.type&&i!==e||"file"===s.type&&s.name.endsWith(".waldiez")&&i!==e},L=null!==l&&A(),O=()=>{D(!1),T(null)};return{isEditing:m,newName:p,fileIcon:F,canClick:L,contextMenuVisible:U,contextMenuPosition:M,contextMenuRef:$,setIsEditing:d,handleDelete:async()=>{o&&await o(s)},handleRename:async()=>{d(!1),p!==s.name&&n&&await n(s,p)},handleDownload:async()=>{c&&await c(s)},onNameChange:e=>{u(e.target.value)},handleCancel:()=>{d(!1),u(s.name)},canNavigate:A,handleContextMenu:e=>{e.preventDefault(),D(!0),T({x:e.clientX,y:e.clientY})},closeContextMenu:O}},q=({currentPath:e,item:a,onRename:s,onDelete:r,onClick:i,onDownload:o})=>{const{isEditing:n,newName:l,fileIcon:c,canClick:m,contextMenuVisible:d,contextMenuPosition:p,contextMenuRef:u,setIsEditing:h,handleDelete:f,handleRename:j,handleDownload:w,onNameChange:g,handleCancel:y,handleContextMenu:x,closeContextMenu:v}=W({currentPath:e,item:a,onRename:s,onDelete:r,onClick:i,onDownload:o}),k=e=>{"Enter"===e.key?j():"Escape"===e.key&&y()};return t.jsxs("div",{"data-testid":"path-item",className:`path-item ${m?"":"read-only"} ${".."===a.name?"up":""}`,onContextMenu:x,children:[d&&p&&".."!==a.name&&t.jsx("div",{ref:u,style:{top:p.y,left:p.x},className:"context-menu",children:t.jsx("button",{onClick:async()=>{await w(),v()},className:"context-menu-item","data-testid":"download-button",children:"Download"})}),n?t.jsx(U,{className:"path-item-edit",onClick:y}):"folder"===a.type?t.jsx(D,{className:"path-item-icon"}):c,n?t.jsx("input",{title:"Press Enter to save, Esc to cancel",type:"text",className:"path-name-input","data-testid":"path-name-input",value:l,onChange:g,onKeyDown:k}):m&&i?t.jsx("span",{className:"path-name clickable","data-testid":"path-navigate",onClick:i.bind(null,a),children:a.name}):t.jsx("div",{className:"path-name",children:a.name}),".."!==a.name&&s?n?t.jsx(M,{className:"path-item-edit","data-testid":"save-button",onClick:j}):t.jsx(T,{className:"path-item-edit","data-testid":"edit-button",onClick:()=>h(!0)}):null,".."!==a.name&&r?t.jsx($,{className:"path-item-delete","data-testid":"delete-button",onClick:f}):null]})},_=e.createContext(void 0),J=({children:a,initialVisible:s=!0})=>{const[r,i]=e.useState(s);return t.jsx(_.Provider,{value:{isSidebarVisible:r,toggleSidebar:()=>i(e=>!e)},children:a})},V=()=>{const{entries:a,loading:s,refresh:r,onClick:i,onCreate:o,onDelete:n,onRename:l,onUpload:c,onDownload:m,currentPath:d,error:p}=Q(),{isSidebarVisible:u,toggleSidebar:h}=(()=>{const t=e.useContext(_);if(!t)throw new Error("useSidebar must be used within a SidebarProvider");return t})();return t.jsxs("div",{className:"file-browser "+(u?"expanded":"collapsed"),children:[t.jsx(O,{isSidebarVisible:u,refresh:r,loading:s,toggleSidebar:h}),t.jsx("div",{className:"file-browser-content",children:u&&t.jsxs(t.Fragment,{children:[p&&t.jsx("p",{className:"file-browser-error","data-testid":"error",children:p}),a.map(e=>t.jsx(q,{currentPath:d,item:e,onDelete:n,onRename:l,onClick:i,onDownload:m},e.path))]})}),u&&t.jsx(L,{onNewFile:async()=>{await o("file")},onNewFolder:async()=>{await o("folder")},onUpload:c})]})};class B extends Error{constructor(e,t,a){super(t),this.status=e,this.originalError=a,this.name="ApiError"}}const G=F.create({baseURL:"/api",timeout:3e4});G.interceptors.response.use(e=>e,e=>{if("ECONNABORTED"===e.code)return Promise.reject(new B(e.response?.status||0,"Request timed out.",e));let t="An unexpected error occurred.",a=0;return F.isAxiosError(e)&&e.response&&(a=e.response.status,t=Y(e)),Promise.reject(new B(a,t,e))});const Y=e=>{let t="An unexpected error occurred.";const a=e.response?.data;return"string"==typeof a?t=a:a?.detail?t=a.detail:a?.message?t=a.message:e.response?.statusText&&(t=`Error: ${e.response.statusText}`),t},H="/workspace",X=async(e="/",t)=>{const a=new FormData;a.append("file",t),a.append("path",e);return(await G.post(`${H}/upload`,a,{headers:{"Content-Type":"multipart/form-data"}})).data},K=e.createContext(void 0),Q=()=>{const t=e.useContext(K);if(!t)throw new Error("useFileBrowser must be used within a FileBrowserProvider");return t},Z=(e,t)=>{let a=null;return(...s)=>(a&&clearTimeout(a),new Promise((r,i)=>{a=setTimeout(async()=>{try{const t=await e(...s);r(t)}catch(t){i(t)}},t)}))},ee=e=>!!e.endsWith(".waldiez")||"/"!==e&&""!==e&&!e.endsWith("/")&&e.split("/").pop()?.includes("."),te=e=>{const t=e.split("/").filter(Boolean),a=t.length>1?`/${t.slice(0,-1).join("/")}`:"/";return a===e?"/":a},ae=e=>((e=e.replace(/\/+/g,"/")).startsWith("/")||(e=`/${e}`),e.length>1&&e.endsWith("/")&&(e=e.slice(0,-1)),e),se=({children:a})=>{const s=e=>{const t=e.split("/");return t[t.length-1]||"Home"},[r,i]=e.useState((()=>{const e=window.location.hash;return e&&e.length>1?e.slice(1):"/"})()),[o,n]=e.useState(s(r)),[l,c]=e.useState([]),[m,d]=e.useState(null),[p,u]=e.useState(!1);e.useEffect(()=>{(async()=>{ee(r)?await h(te(r)):await h(r),n(s(r))})()},[r]);const h=async e=>{u(!0),d(null);try{const t=await(async(e="/")=>(await G.get(H,{params:["","/"].includes(e)?{}:{parent:e}})).data)(e),a="/"!==e?[{name:"..",path:te(e),type:"folder"}]:[];c([...a,...t.items])}catch(t){d(t instanceof Error?t.message:"An unexpected error occurred.")}finally{u(!1)}},f=Z(h,200),j=e=>{const t=ae(e);return i(t),window.location.hash=`#${t}`,t},w=async(e,t=!0)=>{if(e.path===r||`/${e.path}`===r)return;const a=j(e.path);"file"!==e.type&&(t?await h(a):await f(a))},g=async(e=!1)=>{const t=ae(r);let a=t;ee(t)&&(a=te(t)),e?await h(a):await f(a)};return t.jsx(K.Provider,{value:{currentPath:r,pathName:o,entries:l,error:m,loading:p,setError:d,refresh:g,onGoUp:async()=>{const e=te(r);await w({path:e,type:"folder"})},onClick:w,onCreate:async e=>{const t=ee(r)?te(r):r;try{"folder"===e?await(async(e="/")=>(await G.post(H,{type:"folder",parent:e})).data)(t):"file"===e&&await(async(e="/")=>(await G.post(H,{type:"file",parent:e})).data)(t)}catch(a){d(`Failed to create ${e}: ${a.message}`)}finally{await g(!0)}},onDelete:async e=>{try{await(async(e="/")=>{const t=["","/"].includes(e)?"":`?path=${encodeURIComponent(e)}`;return(await G.delete(`${H}${t}`)).data})(e.path),e.path!==r&&`/${e.path}`!==r||j(te(e.path))}catch(t){d(`Failed to delete entry: ${t.message}`)}finally{await g()}},onRename:async(e,t)=>{if(e.name!==t)try{const a=`${te(e.path)}/${t}`;await(async(e,t)=>(await G.post(`${H}/rename`,{old_path:e,new_path:t},{headers:{"Content-Type":"application/json"}})).data)(e.path,a),e.path!==r&&`/${e.path}`!==r||j(a)}catch(a){d(`Failed to rename entry: ${a.message}`)}finally{await g(!0)}},onUpload:async e=>{const t=ae(r);u(!0);try{ee(t)?await X(te(t),e):await X(t,e)}catch(a){d(`Failed to upload file: ${a.message}`)}finally{u(!1),await g()}},onDownload:async e=>{try{await(async(e,t)=>{const a=await G.get(`${H}/download?path=${encodeURIComponent(e)}`,{responseType:"blob"}),s=window.URL.createObjectURL(new Blob([a.data])),r=document.createElement("a");r.href=s;const i=e.split("/");let o=i[i.length-1];"folder"===t&&(o+=".zip"),r.download=o,r.click(),window.URL.revokeObjectURL(s)})(e.path,e.type)}catch(t){d(`Failed to download entry: ${t.message}`)}}},children:a})},re=async(e,t)=>(await G.post("/flow",{contents:t},{params:{path:e}})).data,ie=e=>{let t=0;for(let a=0;a<e.length;a++){t=(t<<5)-t+e.charCodeAt(a),t|=0}return`wf-${Math.abs(t)}`},oe=()=>{const{currentPath:t,pathName:a,refresh:s,onGoUp:r}=Q(),[l,c]=e.useState(ie(t)),m=e.useRef(null),[d,p]=e.useState(t.endsWith(".waldiez")),[u,h]=e.useState(null),f=e.useCallback(e=>{R({type:"input_response",request_id:e.request_id,data:e.data}),g(e=>({...e,activeRequest:void 0}))},[]),j=e.useCallback(()=>{try{R({action:"stop"})}catch(e){i({flowId:l,message:"Failed to stop the flow",level:"error",details:e.message})}finally{m.current="COMPLETED",g(e=>({...e,showUI:!1,activeRequest:void 0,handlers:{...e.handlers,onInterrupt:void 0}}))}},[l]),[w,g]=e.useState(()=>({showUI:!1,messages:[],timeline:void 0,userParticipants:[],activeRequest:void 0,handlers:{onInterrupt:j,onUserInput:f}})),y=async()=>{try{const e=await(async e=>(await G.get("/flow",{params:{path:e}})).data)(t),a=n(e);h(a)}catch(e){404===e?.status&&(i({flowId:u?.flowId||l,message:"Failed to load the flow",level:"error",details:e.message,duration:5e3,withCloseButton:!0}),r())}};e.useEffect(()=>{(async()=>{const e=ie(t);c(e);const a=t.endsWith(".waldiez");a||(h(null),m.current=null,g({showUI:!1,messages:[],userParticipants:[],activeRequest:void 0,handlers:{onInterrupt:j,onUserInput:f}})),p(a),a&&await y()})()},[t]),e.useEffect(()=>()=>{d||(m.current=null)},[d]);const x=e.useCallback(e=>{if("string"==typeof e||null===e){const t=m.current;m.current=e,"RUNNING"===e&&"RUNNING"!==t?g(e=>({...e,showUI:!1,handlers:{...e.handlers,onInterrupt:j}})):"COMPLETED"!==e&&"NOT_STARTED"!==e||g(e=>({...e,showUI:!1,handlers:{...e.handlers,onInterrupt:j}}))}},[j]),v=e.useCallback(e=>{const t=o.process(JSON.stringify(e));if(t)if(t.timeline)I(t.timeline);else{if(t.message&&"input_request"===t.message.type){const e=t.message.prompt||"Enter your message:",a=t.requestId||t.message?.request_id||t.message?.id,s=t.message.password||!1;return void g(r=>({...r,showUI:!0,messages:[...r.messages,t.message],activeRequest:{request_id:a,prompt:e,password:s}}))}t.message&&g(e=>({...e,showUI:!0,messages:[...e.messages,t.message]}))}},[g]),k=e.useCallback(e=>{const t=(e=>{let t={};try{t=JSON.parse(e.data)}catch(a){return}if("string"==typeof t)try{t=JSON.parse(t)}catch(a){}if("data"in t&&"string"==typeof t.data)try{t.data=JSON.parse(t.data)}catch(a){}return"type"in t&&"string"==typeof t.type&&"print"===t.type&&"data"in t?t.data:t})(e);t&&("participants"in t?(e=>{const{participants:t}=e;if(Array.isArray(t)&&t.length>0){const e=t.filter(e=>"ALWAYS"===e.humanInputMode||"user_proxy"===e.agentType).map(e=>e.name).filter(Boolean);g(t=>({...t,showUI:!0,userParticipants:e}))}})(t):"type"in t&&"string"==typeof t.type&&("data"in t||"content"in t)&&("content"in t?v(t):"data"in t&&["status","results","error","info","warning"].includes(t.type)&&("status"===t.type?x(t.data):("results"===t.type&&C(),"error"===t.type?b():"info"===t.type&&N(t.data)))))},[x,v]),b=()=>{m.current="COMPLETED",g(e=>({...e,showUI:!1,activeRequest:void 0,handlers:{...e.handlers,onInterrupt:void 0}}))},N=e=>{"data"in e&&"Task stopped"===e.data&&(m.current="COMPLETED"),g(e=>({...e,showUI:!1,activeRequest:void 0,handlers:{...e.handlers,onInterrupt:void 0}}))},C=()=>{m.current="COMPLETED",g(e=>({...e,showUI:!1,activeRequest:void 0,handlers:{...e.handlers,onInterrupt:void 0}}))},I=e=>{e&&e.metadata&&e.summary&&e.agents&&Array.isArray(e.agents)&&0!==e.agents.length&&e.cost_timeline&&Array.isArray(e.cost_timeline)&&0!==e.cost_timeline.length&&e.timeline&&Array.isArray(e.timeline)&&0!==e.timeline.length&&g(t=>({...t,showUI:!1,timeline:e}))},E=e.useMemo(()=>d&&t?window.location.origin.replace("http","ws")+`/ws?path=${t}`:null,[d,t]),{sendJsonMessage:R}=A(E,{reconnectInterval:3e3,reconnectAttempts:10,retryOnError:d,onError:e=>{i({flowId:l,message:"WebSocket error",level:"error",details:e.message||"An error occurred with the WebSocket connection",duration:3e3})},onClose:e=>{if(![1e3,1001,1005,1006].includes(e.code)){let t=e.reason;t||(t=JSON.stringify({code:e.code,wasClean:e.wasClean,reason:e.reason})),i({flowId:l,message:"WebSocket closed",level:"error",details:t,duration:3e3})}},onMessage:k,shouldReconnect:()=>Boolean(d&&t&&t.endsWith(".waldiez"))},d&&!!t&&t.endsWith(".waldiez")),S=e.useCallback(async e=>{try{await re(t,e),i({flowId:l,message:"Flow saved successfully",level:"success"}),await s()}catch(a){i({flowId:l,message:"Failed to save the flow",level:"error",details:a.message})}},[t,l,s]),z=e.useCallback(async e=>{g(e=>({showUI:!1,messages:[],userParticipants:[],activeRequest:void 0,handlers:{onInterrupt:j,onUserInput:f}})),m.current=null,R({action:"status"});try{const t=await new Promise((e,t)=>{const a=setTimeout(()=>{t(new Error("Timeout while waiting for status"))},5e3),s=m.current,r=setInterval(()=>{s===m.current&&"COMPLETED"!==m.current||(clearInterval(r),clearTimeout(a),e(m.current))},100)});"NOT_STARTED"===t||"COMPLETED"===t?(await S(e),R({action:"start"})):i({flowId:l,message:"Flow is already running",level:"info"})}catch(t){i({flowId:l,message:"Failed to start the flow",level:"error",details:t.message})}},[R,j,f,S,l]);return{flowId:l,isWaldiez:d,waldiezProps:u,status:m.current,fileName:a,chat:w,onRun:z,onConvert:async(e,a)=>{try{await(async(e,t,a)=>(await re(e,t),(await G.post("/flow/export",null,{params:{path:e,extension:a}})).data))(t,e,a),await s()}catch(r){i({flowId:l,message:"Flow conversion failed",level:"error",details:r.message})}},onSave:S,onChange:e=>{Z(async()=>{try{return await re(t,e)}catch{}},200)()},onUpload:e=>new Promise(a=>{const r=[],o=e.map(async e=>{let a=`${t}`;if(d){const e=t.split("/");e.pop(),a=e.join("/")}try{const t=await X(a,e);r.push(t.path)}catch(o){i({flowId:l,message:"Failed to upload the file",level:"error",details:o.message})}finally{await s()}});Promise.all(o).then(()=>{a(r)})}),sendMessage:R}},ne=()=>{const{flowId:e,isWaldiez:a,waldiezProps:s,chat:r,onRun:i,onConvert:o,onChange:n,onSave:c,onUpload:m}=oe();return a?s?t.jsx(l,{...s,flowId:e,storageId:e,monacoVsPath:"/monaco/vs",chat:r,onRun:i,onChange:n,onUpload:m,onSave:c,onConvert:o}):t.jsx("div",{className:"waldiez-wrapper-no-flow",children:t.jsx("p",{"data-testid":"waldiez-loading-flow",children:"Loading flow..."})}):t.jsx("div",{className:"waldiez-wrapper-no-flow",children:t.jsxs("p",{"data-testid":"waldiez-no-flow",children:["Create a new file or select an existing ",t.jsx("span",{children:".waldiez"})," file to start"]})})},le=()=>(e.useEffect(()=>{ce()},[]),t.jsx("div",{className:"app",children:t.jsx(J,{children:t.jsxs(se,{children:[t.jsx(V,{}),t.jsx("div",{className:"waldiez-wrapper",children:t.jsx(ne,{})})]})})})),ce=()=>{if(!document.body.classList.contains("waldiez-dark")&&!document.body.classList.contains("waldiez-light")){window.matchMedia("(prefers-color-scheme: dark)").matches?document.body.classList.add("waldiez-dark"):document.body.classList.add("waldiez-light")}};s.createRoot(document.getElementById("root")).render(t.jsx(a.StrictMode,{children:t.jsx(le,{})}));
