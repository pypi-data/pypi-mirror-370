# Система управления зависимостями

## Обзор

MCP Proxy Adapter включает комплексную систему управления зависимостями, которая автоматически обрабатывает зависимости плагинов в процессе загрузки удаленных команд. Эта система гарантирует, что все необходимые зависимости доступны перед загрузкой и выполнением плагина.

## Возможности

- **Автоматическое обнаружение зависимостей**: Проверяет, установлены ли уже необходимые зависимости
- **Автоматическая установка**: Устанавливает отсутствующие зависимости с помощью pip
- **Проверка зависимостей**: Проверяет, что установленные зависимости правильно импортируются
- **Настраиваемое поведение**: Может быть включено/выключено через конфигурацию
- **Обработка ошибок**: Предоставляет четкие сообщения об ошибках, когда зависимости не могут быть установлены

## Как это работает

### 1. Объявление зависимостей

Зависимости объявляются в каталоге плагинов с помощью поля `depends`:

```json
{
  "test_command": {
    "plugin": "test_command.py",
    "descr": "Команда для тестирования",
    "version": "0.1",
    "depends": ["os", "requests", "numpy"]
  }
}
```

### 2. Проверка зависимостей

При загрузке плагина система:

1. **Проверяет существующие зависимости**: Убеждается, что зависимости уже установлены и импортируемы
2. **Определяет отсутствующие зависимости**: Определяет, какие зависимости нужно установить
3. **Пытается установить**: Использует pip для установки отсутствующих зависимостей
4. **Проверяет установку**: Подтверждает, что все зависимости правильно установлены

### 3. Процесс установки

Процесс установки зависимостей:

```python
# Проверяем текущие зависимости
all_satisfied, missing_deps, installed_deps = dependency_manager.check_dependencies(deps)

if not all_satisfied:
    # Устанавливаем отсутствующие зависимости
    success, installed_deps, failed_deps = dependency_manager.install_dependencies(missing_deps)
    
    if success:
        # Проверяем установку
        all_verified, failed_verifications = dependency_manager.verify_installation(deps)
```

## Конфигурация

### Настройка автоматической установки

Управляйте автоматической установкой зависимостей через конфигурацию:

```json
{
  "commands": {
    "auto_install_dependencies": true
  }
}
```

- `true`: Автоматически устанавливать отсутствующие зависимости (по умолчанию)
- `false`: Только проверять зависимости, не устанавливать автоматически

### Переменная окружения

Вы также можете управлять этим через переменную окружения:

```bash
export SERVICE_COMMANDS_AUTO_INSTALL_DEPENDENCIES=false
```

## Примеры использования

### Базовое объявление зависимостей

```json
{
  "calculator": {
    "plugin": "calculator_command.py",
    "descr": "Продвинутый калькулятор с научными функциями",
    "version": "2.1.0",
    "depends": ["math", "numpy", "scipy"]
  }
}
```

### Одна зависимость

```json
{
  "simple_command": {
    "plugin": "simple_command.py",
    "descr": "Простая команда",
    "version": "1.0.0",
    "depends": "requests"
  }
}
```

### Без зависимостей

```json
{
  "basic_command": {
    "plugin": "basic_command.py",
    "descr": "Базовая команда без зависимостей",
    "version": "1.0.0"
  }
}
```

## Обработка ошибок

### Отсутствующие зависимости

Когда зависимости не могут быть установлены:

```
ERROR: Failed to install dependencies for test_command: ['nonexistent_package']
ERROR: Please install manually: pip install nonexistent_package
```

### Ошибки установки

Распространенные причины ошибок установки:

- **Проблемы с сетью**: Нет подключения к интернету
- **Проблемы с правами**: Недостаточно прав для установки пакетов
- **Пакет не найден**: Пакет не существует на PyPI
- **Конфликты версий**: Несовместимые версии пакетов

### Ручная установка

Когда автоматическая установка не удается, вы можете установить зависимости вручную:

```bash
pip install package_name
```

## Справочник API

### DependencyManager

Основной класс для управления зависимостями:

```python
from mcp_proxy_adapter.commands.dependency_manager import dependency_manager

# Проверяем зависимости
all_satisfied, missing_deps, installed_deps = dependency_manager.check_dependencies(["requests", "numpy"])

# Устанавливаем зависимости
success, installed_deps, failed_deps = dependency_manager.install_dependencies(["requests"])

# Проверяем установку
all_verified, failed_verifications = dependency_manager.verify_installation(["requests"])

# Получаем информацию о зависимости
info = dependency_manager.get_dependency_info("requests")
```

### Методы

#### `check_dependencies(dependencies: List[str]) -> Tuple[bool, List[str], List[str]]`

Проверяет, удовлетворены ли зависимости.

**Параметры:**
- `dependencies`: Список имен зависимостей

**Возвращает:**
- `all_satisfied`: True, если все зависимости удовлетворены
- `missing_deps`: Список отсутствующих зависимостей
- `installed_deps`: Список уже установленных зависимостей

#### `install_dependencies(dependencies: List[str], user_install: bool = False) -> Tuple[bool, List[str], List[str]]`

Устанавливает зависимости с помощью pip.

**Параметры:**
- `dependencies`: Список имен зависимостей для установки
- `user_install`: Устанавливать ли только для текущего пользователя

**Возвращает:**
- `success`: True, если все зависимости были успешно установлены
- `installed_deps`: Список успешно установленных зависимостей
- `failed_deps`: Список зависимостей, которые не удалось установить

#### `verify_installation(dependencies: List[str]) -> Tuple[bool, List[str]]`

Проверяет, что зависимости правильно установлены.

**Параметры:**
- `dependencies`: Список зависимостей для проверки

**Возвращает:**
- `all_verified`: True, если все зависимости проверены
- `failed_verifications`: Список зависимостей, которые не прошли проверку

#### `get_dependency_info(dependency: str) -> Dict[str, Any]`

Получает информацию о зависимости.

**Параметры:**
- `dependency`: Имя зависимости

**Возвращает:**
- Словарь с информацией о зависимости (установлена, версия, импортируема)

## Соображения безопасности

### Источники пакетов

- Зависимости устанавливаются из PyPI по умолчанию
- Пользовательские источники пакетов не поддерживаются
- Все пакеты подчиняются политикам безопасности PyPI

### Права установки

- Зависимости устанавливаются в текущую среду Python
- Рекомендуется использовать виртуальные окружения для изоляции
- Системная установка может потребовать повышенных прав

### Валидация пакетов

- Система проверяет, что установленные пакеты импортируемы
- Дополнительное сканирование безопасности не выполняется
- Пользователи должны проверять зависимости перед включением автоматической установки

## Лучшие практики

### Спецификация зависимостей

1. **Используйте конкретные версии** когда возможно:
   ```json
   "depends": ["requests>=2.25.0", "numpy==1.21.0"]
   ```

2. **Минимизируйте зависимости**: Включайте только необходимые пакеты

3. **Документируйте зависимости**: Предоставляйте четкие описания того, зачем нужна каждая зависимость

### Конфигурация

1. **Включайте автоматическую установку в разработке**: Быстрее итерация
2. **Отключайте автоматическую установку в продакшене**: Больше контроля над версиями пакетов
3. **Используйте виртуальные окружения**: Изолируйте зависимости плагинов

### Обработка ошибок

1. **Мониторьте логи установки**: Проверяйте неудачные установки
2. **Предоставляйте альтернативные варианты**: Инструкции по ручной установке
3. **Тестируйте зависимости**: Проверяйте совместимость перед развертыванием

## Устранение неполадок

### Распространенные проблемы

1. **ImportError после установки**: Пакет может быть установлен, но не импортируем
2. **Конфликты версий**: Несколько пакетов требуют разных версий
3. **Отказано в доступе**: Недостаточно прав для установки пакетов

### Отладка

Включите отладочное логирование для получения подробной информации о зависимостях:

```python
import logging
logging.getLogger('mcp_proxy_adapter').setLevel(logging.DEBUG)
```

### Ручная проверка

Проверьте статус зависимостей вручную:

```python
from mcp_proxy_adapter.commands.dependency_manager import dependency_manager

# Проверяем конкретную зависимость
info = dependency_manager.get_dependency_info("requests")
print(f"Информация о requests: {info}")

# Список всех установленных пакетов
packages = dependency_manager.list_installed_dependencies()
print(f"Установленные пакеты: {packages}")
``` 