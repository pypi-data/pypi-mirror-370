# ====================================================================
# JTECHâ„¢ Core Installer - Makefile
# Build, Test & Publish Automation
# ====================================================================

.PHONY: help clean install install-dev test test-fast test-cov lint format \
        check build build-clean publish publish-test version bump-patch \
        bump-minor bump-major dev-setup pre-commit docs serve-docs \
        validate-build demo install-from-build

# ====================================================================
# Configuration
# ====================================================================

PYTHON := python3.12
PIP := pip
UV := uv
PACKAGE_NAME := jtech-installer
SRC_DIR := src/jtech_installer
TESTS_DIR := tests
DIST_DIR := dist
BUILD_DIR := build
DOCS_DIR := docs

# Colors for output
BLUE := \033[36m
GREEN := \033[32m
YELLOW := \033[33m
RED := \033[31m
RESET := \033[0m

# ====================================================================
# Help
# ====================================================================

help: ## ğŸ“‹ Mostrar comandos disponÃ­veis
	@echo "$(BLUE)ğŸš€ JTECHâ„¢ Core Installer - Makefile$(RESET)"
	@echo ""
	@echo "$(GREEN)ğŸ“¦ Build & Publish:$(RESET)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		grep -E '(build|publish|version|bump)' | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(RESET) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)ğŸ§ª Development & Testing:$(RESET)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		grep -E '(dev|test|lint|format|check|install)' | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(RESET) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)ğŸ“š Documentation & Utils:$(RESET)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		grep -E '(docs|demo|clean|validate)' | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(RESET) %s\n", $$1, $$2}'

# ====================================================================
# Development Setup
# ====================================================================

dev-setup: ## ğŸ”§ Configurar ambiente de desenvolvimento completo
	@echo "$(BLUE)ğŸ”§ Configurando ambiente de desenvolvimento...$(RESET)"
	$(UV) sync --dev
	$(UV) run pre-commit install
	@echo "$(GREEN)âœ… Ambiente configurado!$(RESET)"

install: ## ğŸ“¦ Instalar pacote em modo editable
	@echo "$(BLUE)ğŸ“¦ Instalando pacote...$(RESET)"
	$(PIP) install -e .
	@echo "$(GREEN)âœ… Pacote instalado!$(RESET)"

install-dev: ## ğŸ”§ Instalar com dependÃªncias de desenvolvimento
	@echo "$(BLUE)ğŸ”§ Instalando com dependÃªncias dev...$(RESET)"
	$(UV) sync --dev
	@echo "$(GREEN)âœ… DependÃªncias dev instaladas!$(RESET)"

# ====================================================================
# Code Quality & Testing
# ====================================================================

lint: ## ğŸ” Executar linting (flake8, mypy)
	@echo "$(BLUE)ğŸ” Executando linting...$(RESET)"
	$(UV) run flake8 $(SRC_DIR) $(TESTS_DIR)
	$(UV) run mypy $(SRC_DIR)
	@echo "$(GREEN)âœ… Linting passou!$(RESET)"

format: ## ğŸ¨ Formatar cÃ³digo (black, isort)
	@echo "$(BLUE)ğŸ¨ Formatando cÃ³digo...$(RESET)"
	$(UV) run black $(SRC_DIR) $(TESTS_DIR)
	$(UV) run isort $(SRC_DIR) $(TESTS_DIR)
	@echo "$(GREEN)âœ… CÃ³digo formatado!$(RESET)"

format-fix: ## ğŸ”§ Corrigir problemas de formataÃ§Ã£o automaticamente
	@echo "$(BLUE)ğŸ”§ Corrigindo problemas de formataÃ§Ã£o...$(RESET)"
	$(UV) run black $(SRC_DIR) $(TESTS_DIR) --line-length 79
	$(UV) run isort $(SRC_DIR) $(TESTS_DIR)
	@echo "$(BLUE)ğŸ§¹ Removendo espaÃ§os em branco...$(RESET)"
	find $(SRC_DIR) $(TESTS_DIR) -name "*.py" -exec sed -i 's/[[:space:]]*$$//' {} \;
	@echo "$(BLUE)ğŸ” Corrigindo imports nÃ£o utilizados...$(RESET)"
	-$(UV) run autoflake --in-place --remove-all-unused-imports --recursive $(SRC_DIR) $(TESTS_DIR)
	@echo "$(GREEN)âœ… FormataÃ§Ã£o corrigida automaticamente!$(RESET)"

lint-relax: ## ğŸ” Linting com linha mais longa (110 chars)
	@echo "$(BLUE)ğŸ” Executando linting relaxed...$(RESET)"
	$(UV) run flake8 $(SRC_DIR) $(TESTS_DIR) --max-line-length=110 --ignore=E203,W503,F401,F841,E402,F811,F541 --exclude=$(SRC_DIR)/cli/main_backup.py
	@echo "$(GREEN)âœ… Linting relaxed passou!$(RESET)"

lint-full: lint ## ğŸ” Linting completo com mypy
	@echo "$(BLUE)ğŸ” Executando mypy...$(RESET)"
	$(UV) run mypy $(SRC_DIR)
	@echo "$(GREEN)âœ… Linting completo passou!$(RESET)"

check: lint format ## âœ… VerificaÃ§Ã£o completa de qualidade
	@echo "$(GREEN)âœ… VerificaÃ§Ã£o de qualidade completa!$(RESET)"

test: ## ğŸ§ª Executar todos os testes
	@echo "$(BLUE)ğŸ§ª Executando testes...$(RESET)"
	$(UV) run pytest -v
	@echo "$(GREEN)âœ… Testes concluÃ­dos!$(RESET)"

test-fast: ## âš¡ Executar testes rÃ¡pidos (sem coverage)
	@echo "$(BLUE)âš¡ Executando testes rÃ¡pidos...$(RESET)"
	$(UV) run pytest -v --no-cov -x
	@echo "$(GREEN)âœ… Testes rÃ¡pidos concluÃ­dos!$(RESET)"

test-cov: ## ğŸ“Š Executar testes com coverage
	@echo "$(BLUE)ğŸ“Š Executando testes com coverage...$(RESET)"
	$(UV) run pytest --cov=$(SRC_DIR) --cov-report=html --cov-report=term
	@echo "$(GREEN)âœ… Coverage gerado em htmlcov/$(RESET)"

pre-commit: ## ğŸ¯ Executar pre-commit hooks
	@echo "$(BLUE)ğŸ¯ Executando pre-commit...$(RESET)"
	$(UV) run pre-commit run --all-files
	@echo "$(GREEN)âœ… Pre-commit concluÃ­do!$(RESET)"

# ====================================================================
# Build & Package
# ====================================================================

clean: ## ğŸ§¹ Limpar arquivos de build
	@echo "$(BLUE)ğŸ§¹ Limpando arquivos de build...$(RESET)"
	rm -rf $(DIST_DIR) $(BUILD_DIR) *.egg-info
	rm -rf .pytest_cache .coverage htmlcov/
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@echo "$(GREEN)âœ… Limpeza concluÃ­da!$(RESET)"

build-clean: clean build ## ğŸ”„ Limpar e construir

build-internal: format-fix lint-relax test ## ï¿½ Build para distribuiÃ§Ã£o interna Veolia
	@echo "$(BLUE)ğŸ¢ Construindo pacote para distribuiÃ§Ã£o interna...$(RESET)"
	@echo "$(GREEN)âœ… Testes e qualidade verificados$(RESET)"
	$(UV) build --out-dir $(DIST_DIR)
	@echo "$(GREEN)âœ… Pacote construÃ­do em $(DIST_DIR)/$(RESET)"
	@echo "$(BLUE)ğŸ“‹ Arquivos gerados:$(RESET)"
	@ls -la $(DIST_DIR)/
	@echo "$(YELLOW)ğŸ’¡ Para instalar localmente: pip install dist/*.whl$(RESET)"

build: clean ## ğŸ”¨ Construir o pacote
	@echo "$(BLUE)ğŸ—ï¸ Construindo pacote...$(RESET)"
	$(UV) build
	@echo "$(GREEN)âœ… Pacote construÃ­do em $(DIST_DIR)/$(RESET)"
	@ls -la $(DIST_DIR)/

validate-build: build ## âœ… Validar build construÃ­do
	@echo "$(BLUE)âœ… Validando build...$(RESET)"
	$(UV) run twine check $(DIST_DIR)/*
	@echo "$(GREEN)âœ… Build validado!$(RESET)"

install-from-build: build ## ğŸ“¦ Instalar a partir do build
	@echo "$(BLUE)ğŸ“¦ Instalando a partir do build...$(RESET)"
	$(PIP) install $(DIST_DIR)/*.whl --force-reinstall
	@echo "$(GREEN)âœ… Instalado a partir do build!$(RESET)"

# ====================================================================
# Version Management
# ====================================================================

version: ## ğŸ“‹ Mostrar versÃ£o atual
	@echo "$(BLUE)ğŸ“‹ VersÃ£o atual:$(RESET)"
	@grep '^version = ' pyproject.toml | cut -d'"' -f2

bump-patch: ## ğŸ”¢ Incrementar versÃ£o patch (0.1.0 -> 0.1.1)
	@echo "$(BLUE)ğŸ”¢ Incrementando versÃ£o patch...$(RESET)"
	@current=$$(grep '^version = ' pyproject.toml | cut -d'"' -f2); \
	new=$$(echo $$current | awk -F. '{$$3++; print $$1"."$$2"."$$3}'); \
	sed -i 's/^version = ".*"/version = "'$$new'"/' pyproject.toml; \
	echo "$(GREEN)âœ… VersÃ£o atualizada: $$current -> $$new$(RESET)"

bump-minor: ## ğŸ”¢ Incrementar versÃ£o minor (0.1.0 -> 0.2.0)
	@echo "$(BLUE)ğŸ”¢ Incrementando versÃ£o minor...$(RESET)"
	@current=$$(grep '^version = ' pyproject.toml | cut -d'"' -f2); \
	new=$$(echo $$current | awk -F. '{$$2++; $$3=0; print $$1"."$$2"."$$3}'); \
	sed -i 's/^version = ".*"/version = "'$$new'"/' pyproject.toml; \
	echo "$(GREEN)âœ… VersÃ£o atualizada: $$current -> $$new$(RESET)"

bump-major: ## ğŸ”¢ Incrementar versÃ£o major (0.1.0 -> 1.0.0)
	@echo "$(BLUE)ğŸ”¢ Incrementando versÃ£o major...$(RESET)"
	@current=$$(grep '^version = ' pyproject.toml | cut -d'"' -f2); \
	new=$$(echo $$current | awk -F. '{$$1++; $$2=0; $$3=0; print $$1"."$$2"."$$3}'); \
	sed -i 's/^version = ".*"/version = "'$$new'"/' pyproject.toml; \
	echo "$(GREEN)âœ… VersÃ£o atualizada: $$current -> $$new$(RESET)"

# ====================================================================
# Publishing
# ====================================================================

publish-test: validate-build ## ğŸ§ª Publicar no Test PyPI
	@echo "$(BLUE)ğŸ§ª Publicando no Test PyPI...$(RESET)"
	@echo "$(YELLOW)âš ï¸  Certifique-se de ter configurado suas credenciais do Test PyPI$(RESET)"
	$(UV) run twine upload --repository testpypi $(DIST_DIR)/*
	@echo "$(GREEN)âœ… Publicado no Test PyPI!$(RESET)"
	@echo "$(BLUE)ğŸ“‹ Teste a instalaÃ§Ã£o com:$(RESET)"
	@echo "pip install --index-url https://test.pypi.org/simple/ $(PACKAGE_NAME)"

publish: validate-build ## ğŸš€ Publicar no PyPI oficial
	@echo "$(RED)âš ï¸  ATENÃ‡ÃƒO: Este Ã© um pacote PROPRIETÃRIO da Veolia$(RESET)"
	@echo "$(RED)âš ï¸  NÃƒO deve ser publicado em repositÃ³rios pÃºblicos!$(RESET)"
	@echo "$(YELLOW)ğŸ’¡ Use 'make publish-private' para repositÃ³rio interno$(RESET)"
	@read -p "Tem certeza que deseja publicar no PyPI PÃšBLICO? (y/N): " confirm && [ "$$confirm" = "y" ]
	$(UV) run twine upload $(DIST_DIR)/*
	@echo "$(GREEN)âœ… Publicado no PyPI!$(RESET)"
	@echo "$(BLUE)ğŸ“‹ Instale com:$(RESET)"
	@echo "pip install $(PACKAGE_NAME)"

publish-private: validate-build ## ğŸ¢ Publicar em repositÃ³rio privado Veolia
	@echo "$(BLUE)ğŸ¢ Publicando em repositÃ³rio privado Veolia...$(RESET)"
	@echo "$(YELLOW)âš ï¸  Configure o repositÃ³rio privado da Veolia primeiro$(RESET)"
	@echo "$(BLUE)ğŸ’¡ Exemplo de configuraÃ§Ã£o:$(RESET)"
	@echo "  twine upload --repository-url https://pypi.veolia.com/simple/ dist/*"
	@read -p "Tem certeza que deseja publicar no repositÃ³rio privado? (y/N): " confirm && [ "$$confirm" = "y" ]
	@echo "$(RED)âŒ RepositÃ³rio privado nÃ£o configurado ainda$(RESET)"
	@echo "$(BLUE)ğŸ“‹ Configure primeiro:$(RESET)"
	@echo "  1. Adicione o repositÃ³rio no ~/.pypirc"
	@echo "  2. Configure as credenciais"
	@echo "  3. Execute: twine upload --repository veolia-private dist/*"

# ====================================================================
# Documentation
# ====================================================================

docs: ## ğŸ“š Gerar documentaÃ§Ã£o
	@echo "$(BLUE)ğŸ“š Gerando documentaÃ§Ã£o...$(RESET)"
	@if [ -d "$(DOCS_DIR)" ]; then \
		cd $(DOCS_DIR) && make html; \
		echo "$(GREEN)âœ… DocumentaÃ§Ã£o gerada!$(RESET)"; \
	else \
		echo "$(YELLOW)âš ï¸  DiretÃ³rio docs nÃ£o encontrado$(RESET)"; \
	fi

serve-docs: docs ## ğŸŒ Servir documentaÃ§Ã£o localmente
	@echo "$(BLUE)ğŸŒ Servindo documentaÃ§Ã£o...$(RESET)"
	@if [ -d "$(DOCS_DIR)/_build/html" ]; then \
		cd $(DOCS_DIR)/_build/html && $(PYTHON) -m http.server 8000; \
	else \
		echo "$(RED)âŒ DocumentaÃ§Ã£o nÃ£o encontrada. Execute 'make docs' primeiro$(RESET)"; \
	fi

# ====================================================================
# Demo & Utilities
# ====================================================================

demo: ## ğŸ¬ Executar demonstraÃ§Ã£o da CLI
	@echo "$(BLUE)ğŸ¬ Executando demonstraÃ§Ã£o...$(RESET)"
	$(PYTHON) demo.py
	@echo "$(GREEN)âœ… DemonstraÃ§Ã£o concluÃ­da!$(RESET)"

# ====================================================================
# Workflows Completos
# ====================================================================

prepare-release: clean format-fix lint-relax test build validate-build ## ğŸ¯ Preparar para release
	@echo "$(GREEN)ğŸ¯ PreparaÃ§Ã£o para release concluÃ­da!$(RESET)"
	@echo "$(BLUE)ğŸ“‹ PrÃ³ximos passos:$(RESET)"
	@echo "1. make bump-patch|minor|major"
	@echo "2. make publish-test (para testar)"
	@echo "3. make publish (para produÃ§Ã£o)"

quick-test: format test-fast ## âš¡ Teste rÃ¡pido com formataÃ§Ã£o

full-check: clean format lint test-cov build validate-build ## ğŸ” VerificaÃ§Ã£o completa

# ====================================================================
# Development Shortcuts
# ====================================================================

dev: install-dev ## ğŸ”§ Alias para install-dev
test-w: ## ğŸ”„ Executar testes em modo watch (requer pytest-watch)
	@echo "$(BLUE)ğŸ”„ Executando testes em modo watch...$(RESET)"
	$(UV) run ptw -- --no-cov

# ====================================================================
# Status & Info
# ====================================================================

status: ## ğŸ“Š Mostrar status do projeto
	@echo "$(BLUE)ğŸ“Š Status do Projeto JTECHâ„¢ Core Installer$(RESET)"
	@echo ""
	@echo "$(GREEN)ğŸ“¦ Pacote:$(RESET) $(PACKAGE_NAME)"
	@echo "$(GREEN)ğŸ“‹ VersÃ£o:$(RESET) $$(grep '^version = ' pyproject.toml | cut -d'"' -f2)"
	@echo "$(GREEN)ğŸ Python:$(RESET) $$($(PYTHON) --version)"
	@echo "$(GREEN)ğŸ“ DiretÃ³rio:$(RESET) $$(pwd)"
	@echo ""
	@echo "$(GREEN)ğŸ“Š EstatÃ­sticas:$(RESET)"
	@find $(SRC_DIR) -name "*.py" | wc -l | awk '{print "  Arquivos Python:", $$1}'
	@find $(TESTS_DIR) -name "*.py" | wc -l | awk '{print "  Arquivos de Teste:", $$1}'
	@find $(SRC_DIR) -name "*.py" -exec wc -l {} + | tail -1 | awk '{print "  Linhas de CÃ³digo:", $$1}'
