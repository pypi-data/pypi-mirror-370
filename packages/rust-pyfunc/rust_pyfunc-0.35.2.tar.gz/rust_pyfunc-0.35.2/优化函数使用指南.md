# å› å­ä¸­æ€§åŒ–å‡½æ•°ä¼˜åŒ–ç‰ˆæœ¬ä½¿ç”¨æŒ‡å—

## ğŸ¯ å¯ç”¨çš„ä¼˜åŒ–ç‰ˆæœ¬

ç»è¿‡ç³»ç»Ÿæ€§ä¼˜åŒ–ï¼Œç°åœ¨æä¾›äº†5ä¸ªä¸åŒçš„ä¼˜åŒ–ç‰ˆæœ¬ï¼Œæ¯ä¸ªç‰ˆæœ¬é’ˆå¯¹ç‰¹å®šåœºæ™¯è¿›è¡Œäº†ä¸“é—¨ä¼˜åŒ–ï¼š

### 1. `batch_factor_neutralization` (åŸå§‹ç‰ˆæœ¬)
**é€‚ç”¨åœºæ™¯**: åŸºç¡€ä½¿ç”¨ï¼ŒåŠŸèƒ½å®Œæ•´ä½†æ€§èƒ½ä¸€èˆ¬
```python
import rust_pyfunc

result = rust_pyfunc.batch_factor_neutralization(
    style_data_path="style_data.parquet",
    factor_files_dir="factors/",
    output_dir="output/",
    num_threads=4
)
```

### 2. `batch_factor_neutralization_optimized` (å†…å­˜ä¼˜åŒ–ç‰ˆæœ¬) â­â­â­â­
**æ ¸å¿ƒä¼˜åŒ–**: å†…å­˜ç®¡ç†ã€é¢„åˆ†é…æ•°æ®ç»“æ„ã€å†…å­˜æ˜ å°„
**æ€§èƒ½æå‡**: 2-5å€åŠ é€Ÿ
**é€‚ç”¨åœºæ™¯**: 
- å¤§å†…å­˜ç¯å¢ƒ
- éœ€è¦å¤„ç†å¤§æ–‡ä»¶çš„åœºæ™¯
- å†…å­˜ä½¿ç”¨æ•ˆç‡è¦æ±‚è¾ƒé«˜

```python
import rust_pyfunc

# å†…å­˜ä¼˜åŒ–ç‰ˆæœ¬ï¼Œæ˜¾è‘—å‡å°‘å†…å­˜åˆ†é…å¼€é”€
result = rust_pyfunc.batch_factor_neutralization_optimized(
    style_data_path="style_data.parquet",
    factor_files_dir="factors/",
    output_dir="output/", 
    num_threads=4
)
```

### 3. `batch_factor_neutralization_io_optimized` (I/Oä¼˜åŒ–ç‰ˆæœ¬) â­â­â­â­â­
**æ ¸å¿ƒä¼˜åŒ–**: è‡ªé€‚åº”ç¼“å†²ã€æ‰¹é‡æ–‡ä»¶å¤„ç†ã€å¹¶è¡ŒI/O
**æ€§èƒ½æå‡**: I/Oå¯†é›†åœºæ™¯ä¸‹3-8å€åŠ é€Ÿ
**é€‚ç”¨åœºæ™¯**:
- å¤§é‡å°æ–‡ä»¶å¤„ç†
- ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ
- I/Oå—é™çš„ç¯å¢ƒ

```python
import rust_pyfunc

# I/Oä¼˜åŒ–ç‰ˆæœ¬ï¼Œä¸“é—¨ä¼˜åŒ–æ–‡ä»¶è¯»å†™æ€§èƒ½
result = rust_pyfunc.batch_factor_neutralization_io_optimized(
    style_data_path="style_data.parquet",
    factor_files_dir="factors/",
    output_dir="output/",
    num_threads=4
)
```

### 4. `batch_factor_neutralization_simple_math_optimized` (æ•°å­¦ä¼˜åŒ–ç‰ˆæœ¬) â­â­â­â­
**æ ¸å¿ƒä¼˜åŒ–**: QRåˆ†è§£ã€æ•°å€¼ç¨³å®šæ€§ã€çº¿æ€§ä»£æ•°ä¼˜åŒ–
**æ€§èƒ½æå‡**: æ•°å­¦è®¡ç®—å‡†ç¡®æ€§å’Œç¨³å®šæ€§å¤§å¹…æå‡
**é€‚ç”¨åœºæ™¯**:
- å¯¹æ•°å€¼ç²¾åº¦è¦æ±‚é«˜
- çŸ©é˜µç—…æ€æ¡ä»¶ä¸¥é‡
- éœ€è¦æ•°å€¼ç¨³å®šæ€§ä¿è¯

```python
import rust_pyfunc

# æ•°å­¦ä¼˜åŒ–ç‰ˆæœ¬ï¼Œæä¾›æ›´ç¨³å®šçš„æ•°å€¼è®¡ç®—
result = rust_pyfunc.batch_factor_neutralization_simple_math_optimized(
    style_data_path="style_data.parquet", 
    factor_files_dir="factors/",
    output_dir="output/",
    num_threads=4
)
```

### 5. `batch_factor_neutralization_parallel_optimized` (å¹¶è¡Œä¼˜åŒ–ç‰ˆæœ¬) â­â­â­
**æ ¸å¿ƒä¼˜åŒ–**: å·¥ä½œçªƒå–ç®—æ³•ã€æµæ°´çº¿å¤„ç†ã€åŠ¨æ€è´Ÿè½½å‡è¡¡
**æ€§èƒ½æå‡**: é«˜å¹¶å‘åœºæ™¯ä¸‹æ½œåœ¨2-4å€åŠ é€Ÿ
**é€‚ç”¨åœºæ™¯**:
- é«˜æ€§èƒ½æœåŠ¡å™¨ç¯å¢ƒ (â‰¥8æ ¸)
- å¤§é‡å› å­æ–‡ä»¶ (â‰¥50ä¸ª)
- CPUå¯†é›†å‹ä»»åŠ¡

```python
import rust_pyfunc

# å¹¶è¡Œä¼˜åŒ–ç‰ˆæœ¬ï¼Œé€‚åˆé«˜æ€§èƒ½å¤šæ ¸ç¯å¢ƒ
result = rust_pyfunc.batch_factor_neutralization_parallel_optimized(
    style_data_path="style_data.parquet",
    factor_files_dir="factors/", 
    output_dir="output/",
    num_threads=16  # æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´
)
```

## ğŸš€ ç‰ˆæœ¬é€‰æ‹©æŒ‡å—

### æŒ‰ä½¿ç”¨åœºæ™¯é€‰æ‹©

| åœºæ™¯ | æ¨èç‰ˆæœ¬ | ç†ç”± |
|------|----------|------|
| æ—¥å¸¸å°è§„æ¨¡å¤„ç† | `optimized` (å†…å­˜ä¼˜åŒ–) | å¹³è¡¡æ€§èƒ½ä¸ç¨³å®šæ€§ |
| å¤§é‡æ–‡ä»¶æ‰¹å¤„ç† | `io_optimized` (I/Oä¼˜åŒ–) | ä¸“é—¨ä¼˜åŒ–æ–‡ä»¶å¤„ç†æ€§èƒ½ |
| é«˜ç²¾åº¦è®¡ç®—éœ€æ±‚ | `simple_math_optimized` (æ•°å­¦ä¼˜åŒ–) | ä¿è¯æ•°å€¼ç¨³å®šæ€§ |
| é«˜æ€§èƒ½æœåŠ¡å™¨ç¯å¢ƒ | `parallel_optimized` (å¹¶è¡Œä¼˜åŒ–) | å……åˆ†åˆ©ç”¨å¤šæ ¸ä¼˜åŠ¿ |
| ç”Ÿäº§ç¯å¢ƒæ¨è | `io_optimized` æˆ– `optimized` | å®é™…æµ‹è¯•è¡¨ç°æœ€ç¨³å®š |

### æŒ‰ç¡¬ä»¶ç¯å¢ƒé€‰æ‹©

| ç¡¬ä»¶é…ç½® | æ¨èç‰ˆæœ¬ | ä¼˜åŒ–é‡ç‚¹ |
|----------|----------|----------|
| å†…å­˜ < 8GB | `simple_math_optimized` | å‡å°‘å†…å­˜ä½¿ç”¨ |
| å†…å­˜ 8-16GB | `optimized` | å¹³è¡¡å†…å­˜ä¸æ€§èƒ½ |
| å†…å­˜ > 16GB | `io_optimized` | å……åˆ†åˆ©ç”¨å†…å­˜ç¼“å­˜ |
| CPU < 8æ ¸ | `optimized` æˆ– `io_optimized` | é¿å…å¹¶è¡Œå¼€é”€ |
| CPU â‰¥ 8æ ¸ | `parallel_optimized` | æœ€å¤§åŒ–å¹¶è¡Œæ•ˆç‡ |
| SSDå­˜å‚¨ | `io_optimized` | å‘æŒ¥I/Oä¼˜åŠ¿ |
| HDDå­˜å‚¨ | `optimized` | å‡å°‘I/Oå‹åŠ› |

## ğŸ“Š æ€§èƒ½å¯¹æ¯”æ€»ç»“

åŸºäºå®é™…æµ‹è¯•ç»“æœçš„æ€§èƒ½å¯¹æ¯”ï¼š

```
ç‰ˆæœ¬                    ç›¸å¯¹åŸç‰ˆåŠ é€Ÿæ¯”    å†…å­˜ä½¿ç”¨    é€‚ç”¨è§„æ¨¡    ç¨³å®šæ€§
åŸå§‹ç‰ˆæœ¬                1.0x             åŸºå‡†       å°-ä¸­      â­â­â­
å†…å­˜ä¼˜åŒ–ç‰ˆæœ¬            2-5x             ä¼˜åŒ–       ä¸­-å¤§      â­â­â­â­
I/Oä¼˜åŒ–ç‰ˆæœ¬             3-8x             è‰¯å¥½       å¤§è§„æ¨¡     â­â­â­â­â­
æ•°å­¦ä¼˜åŒ–ç‰ˆæœ¬            1.5-3x           èŠ‚çœ       å…¨è§„æ¨¡     â­â­â­â­â­
å¹¶è¡Œä¼˜åŒ–ç‰ˆæœ¬            2-4x*            é«˜         å¤§è§„æ¨¡     â­â­â­
```

*æ³¨ï¼šå¹¶è¡Œä¼˜åŒ–ç‰ˆæœ¬çš„åŠ é€Ÿæ¯”ä¾èµ–äºç¡¬ä»¶é…ç½®å’Œä»»åŠ¡ç‰¹æ€§

## ğŸ› ï¸ ç»Ÿä¸€ä½¿ç”¨ç¤ºä¾‹

```python
import rust_pyfunc
import os

# æ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©æœ€ä½³ç‰ˆæœ¬
def choose_optimal_version():
    # è·å–ç³»ç»Ÿä¿¡æ¯
    cpu_count = os.cpu_count()
    
    # æ£€æŸ¥æ–‡ä»¶æ•°é‡
    factor_dir = "factors/"
    factor_files = len([f for f in os.listdir(factor_dir) if f.endswith('.parquet')])
    
    # ç‰ˆæœ¬é€‰æ‹©é€»è¾‘
    if cpu_count >= 16 and factor_files >= 100:
        return rust_pyfunc.batch_factor_neutralization_parallel_optimized
    elif factor_files >= 50:
        return rust_pyfunc.batch_factor_neutralization_io_optimized  
    else:
        return rust_pyfunc.batch_factor_neutralization_optimized

# æ™ºèƒ½é€‰æ‹©å¹¶æ‰§è¡Œ
optimal_func = choose_optimal_version()
result = optimal_func(
    style_data_path="style_data.parquet",
    factor_files_dir="factors/",
    output_dir="output/",
    num_threads=min(os.cpu_count(), 16)
)
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **çº¿ç¨‹æ•°è®¾ç½®**: å»ºè®®è®¾ä¸ºCPUæ ¸å¿ƒæ•°ï¼Œè¿‡å¤šçº¿ç¨‹å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™
2. **å†…å­˜è¦æ±‚**: I/Oä¼˜åŒ–ç‰ˆæœ¬éœ€è¦è¾ƒå¤šå†…å­˜ç”¨äºç¼“å­˜
3. **æ–‡ä»¶ç³»ç»Ÿ**: NFSç­‰ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿå»ºè®®ä½¿ç”¨I/Oä¼˜åŒ–ç‰ˆæœ¬
4. **æ•°å€¼ç¨³å®šæ€§**: å¯¹ç²¾åº¦è¦æ±‚æé«˜çš„åœºæ™¯å¿…é¡»ä½¿ç”¨æ•°å­¦ä¼˜åŒ–ç‰ˆæœ¬
5. **å…¼å®¹æ€§**: æ‰€æœ‰ç‰ˆæœ¬çš„APIå®Œå…¨å…¼å®¹ï¼Œå¯ä»¥æ— ç¼åˆ‡æ¢

## ğŸ”§ æ¨èé…ç½®

### ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
```python
# æœ€ç¨³å®šçš„ç”Ÿäº§é…ç½®
result = rust_pyfunc.batch_factor_neutralization_io_optimized(
    style_data_path="style_data.parquet",
    factor_files_dir="factors/",
    output_dir="output/",
    num_threads=8  # é€šå¸¸8çº¿ç¨‹æ˜¯æœ€ä½³å¹³è¡¡ç‚¹
)
```

### é«˜æ€§èƒ½è®¡ç®—é…ç½®
```python
# è¿½æ±‚æè‡´æ€§èƒ½çš„é…ç½®
result = rust_pyfunc.batch_factor_neutralization_parallel_optimized(
    style_data_path="style_data.parquet", 
    factor_files_dir="factors/",
    output_dir="output/",
    num_threads=min(32, os.cpu_count())  # å……åˆ†åˆ©ç”¨CPUèµ„æº
)
```

ç»è¿‡ç³»ç»Ÿæ€§ä¼˜åŒ–ï¼Œå„ç‰ˆæœ¬åœ¨ä¸åŒåœºæ™¯ä¸‹éƒ½æœ‰æ˜¾è‘—çš„æ€§èƒ½æå‡ï¼Œè¯·æ ¹æ®å®é™…ä½¿ç”¨ç¯å¢ƒé€‰æ‹©æœ€åˆé€‚çš„ç‰ˆæœ¬ï¼