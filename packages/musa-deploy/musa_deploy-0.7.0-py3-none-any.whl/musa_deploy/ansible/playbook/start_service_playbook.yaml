---
- name: Initialize Docker Swarm Cluster
  hosts: leader
  gather_facts: no
  become: yes
  vars:
    host_ip: "0.0.0.0"  # 默认值
    task_name: "vllm-musa"
    model_path: "/data"
    musa_deploy_arguments: ""
    disable_kuae_chat: ""
    worker_num: "3"
    tp_size: 8
    pp_size: 4
    pp_layer_partition: '16,15,15,15'
    max_model_len: 1024

  tasks:
    - name: Copy stack.yaml to /tmp/
      command: sudo musa-deploy-ansible --generate-stack-yaml {{ musa_deploy_arguments }}
      register: swarm_status
      changed_when: false
      ignore_errors: yes

    - name: Copy shell script to /tmp/
      command: sudo musa-deploy-ansible --generate-shell-script
      register: swarm_status
      changed_when: false
      ignore_errors: yes

    - name: generate kuae-chat models.json to /tmp/
      command: sudo musa-deploy-ansible {{ disable_kuae_chat }} --host-leader-ip {{ host_ip }} --task {{ task_name }}
      register: swarm_status
      changed_when: false
      ignore_errors: yes

    - name: Check Swarm status
      shell: docker stack rm {{ task_name }} && MODEL_NAME={{ task_name }} MAX_MODEL_LEN={{ max_model_len }} TP_SIZE={{ tp_size }} PP_SIZE={{ pp_size }} PP_LAYER_PARTITION={{ pp_layer_partition }} WORKER_NUM={{ worker_num }} MODEL_PATH={{ model_path }} HOST_IP={{ host_ip }} docker stack deploy -c /tmp/stack_template.yaml {{ task_name }}
      changed_when: false
      ignore_errors: yes
