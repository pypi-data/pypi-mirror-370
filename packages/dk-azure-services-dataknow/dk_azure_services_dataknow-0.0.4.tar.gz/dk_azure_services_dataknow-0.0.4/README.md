# DK Azure Services Package

Paquete Python para facilitar la integraciÃ³n con servicios de Azure, proporcionando conectores seguros y fÃ¡ciles de usar para los principales servicios de Azure.

## Servicios Soportados

- **Azure Cosmos DB** - Base de datos NoSQL distribuida globalmente
- **Azure Cognitive Search** - BÃºsqueda semÃ¡ntica y texto completo
- **Azure Data Lake Storage Gen2** - Data Lake para analÃ­tica a escala
- **Azure Blob Storage** - Almacenamiento de objetos en la nube
- **Azure Key Vault** - GestiÃ³n segura de secretos y certificados
- **Azure OpenAI** - Servicios de inteligencia artificial (prÃ³ximamente)

## CaracterÃ­sticas Principales

âœ… **AutenticaciÃ³n Centralizada** - Usa `DefaultAzureCredential` para autenticaciÃ³n segura  
âœ… **ConfiguraciÃ³n por Entornos** - Soporte para mÃºltiples entornos (dev, prod, etc.)  
âœ… **GestiÃ³n de Secretos** - IntegraciÃ³n automÃ¡tica con Azure Key Vault  
âœ… **Manejo de Errores** - Excepciones personalizadas para mejor debugging  
âœ… **DocumentaciÃ³n Completa** - Docstrings en espaÃ±ol  
âœ… **Type Hints** - Compatibilidad completa con tipado estÃ¡tico  
ðŸš€ **100% AsÃ­ncrono** - Operaciones concurrentes de alto rendimiento por defecto  
âš¡ **Operaciones Bulk** - Procesamiento masivo optimizado (10-50x mÃ¡s rÃ¡pido)  
ðŸ”§ **Context Managers** - GestiÃ³n automÃ¡tica de recursos  
ðŸŽ¯ **API Simple** - Una sola forma de hacer las cosas, bien hecha  

## InstalaciÃ³n

```bash
pip install dk-azure-services
```

### InstalaciÃ³n para Desarrollo

```bash
git clone https://github.com/yourusername/dk-azure-services.git
cd dk-azure-services
pip install -e .[dev]
```

## Uso RÃ¡pido

### Cliente Simplificado (AsyncCosmosDBClient)

```python
import asyncio
from dk_azure_services.cosmos import AsyncCosmosDBClient
from dotenv import load_dotenv

# Requieres tu archivo .env con la variable de entorno: KEY_VAULT_NAME=your-key-vault-name
# En tu Key Vault requieres los secretos:
# cosmos-uri="your-cosmos-uri"
# cosmos-key=your-cosmos-key


load_dotenv(override=True)

async def main():
    async with AsyncCosmosDBClient(partition_key_path="/partition_key") as client:
        # Crear una base de datos
        await client.create_database("mi_base_de_datos")

        # Crear un contenedor
        await client.create_container("mi_base_de_datos", "mi_contenedor", "/partition_key")

        # Crear un documento
        documento = {"id": "user123", "name": "Juan", "role": "Developer", "partition_key": "user123"}
        await client.create_document("mi_base_de_datos", "mi_contenedor", documento)

        # Leer un documento
        doc = await client.read_document("mi_base_de_datos", "mi_contenedor", "user123", partition_key="user123")
        print("Documento leÃ­do:", doc)

asyncio.run(main())
```

### Azure Data Lake (AsyncDataLake)

```python
import asyncio
from dk_azure_services import AsyncDataLake
from dotenv import load_dotenv

load_dotenv(override=True)

async def main():
    async with AsyncDataLake() as dl:
        # Listar archivos CSV en una carpeta
        files = await dl.list_files("datos/", suffix=".csv")
        print(files)

        # Subir archivo grande en chunks
        await dl.upload_large_file(
            file_name="datos/grande.csv",
            file_path="./local_grande.csv",
            chunk_size=4 * 1024 * 1024
        )

        # Generar SAS para un path
        sas_url = await dl.generate_sas_for_path("datos/grande.csv", permission_str="r", expiry_hours=2)
        print("SAS:", sas_url)

asyncio.run(main())
```

### Azure Blob Storage (AsyncBlobStorage)

```python
import asyncio
from dk_azure_services import AsyncBlobStorage
from dotenv import load_dotenv

load_dotenv(override=True)

async def main():
    async with AsyncBlobStorage() as storage:
        # Subir JSON
        await storage.upload_data("ejemplos/demo.json", {"ok": True})

        # Listar blobs por prefijo
        blobs = await storage.list_blobs(prefix="ejemplos/")
        print(blobs)

        # Generar SAS de lectura por 1 hora
        url = await storage.generate_sas_for_blob("ejemplos/demo.json", permission_str="r", expiry_hours=1)
        print("URL SAS:", url)

asyncio.run(main())
```

### Azure Cognitive Search (AsyncSearchEngine)

```python
import asyncio
from dk_azure_services import AsyncSearchEngine
from dotenv import load_dotenv

load_dotenv(override=True)

async def main():
    async with AsyncSearchEngine() as search:
        # Subir documentos
        await search.upload_documents([
            {"id": "1", "title": "Hola", "content": "Documento de prueba"},
            {"id": "2", "title": "Mundo", "content": "Otro documento"}
        ])

        # Buscar
        results = await search.search("prueba", top=3)
        print(results)

asyncio.run(main())
```

---

## Ejemplo Avanzado: Clientes Especializados

Puedes usar clientes especializados para un control mÃ¡s granular sobre bases de datos, contenedores y documentos.

```python
import asyncio
from dk_azure_services.cosmos.database_manager import AsyncDatabaseManager
from dk_azure_services.cosmos.container_manager import AsyncContainerManager
from dk_azure_services.cosmos.documents_manager import AsyncDocumentsManager

async def main():
    # Crear base de datos
    db_manager = AsyncDatabaseManager(environment="dev")
    await db_manager.create_database("ejemplo_db")

    # Crear contenedor
    container_manager = AsyncContainerManager(environment="dev")
    await container_manager.create_container_simple(
        database_name="ejemplo_db",
        container_name="ejemplo_contenedor",
        partition_key_path="/partition_key"
    )

    # Crear documento
    client = AsyncDocumentsManager(environment="dev")
    doc = {"id": "user1", "nombre": "Ana", "edad": 28, "partition_key": "user1"}
    await client.create_document(doc, "ejemplo_db", "ejemplo_contenedor", partition_key="user1")

    # Consultar documentos
    docs = await client.query_documents(
        "SELECT * FROM c WHERE c.edad >= @edad",
        [{"name": "@edad", "value": 18}],
        database_name="ejemplo_db",
        container_name="ejemplo_contenedor"
    )
    print("Documentos encontrados:", docs)

    # Cerrar conexiones
    await client.close()
    await container_manager.close()
    await db_manager.close()

asyncio.run(main())
```

> **Nota:** Puedes encontrar ejemplos completos y scripts de prueba en la carpeta `examples/02_cosmos` del repositorio.

---

## ConfiguraciÃ³n

### ðŸŽ¯ **Variables Estandarizadas Entre Ambientes**

âœ… **Mismos nombres** en DEV y PROD  
âœ… **Solo cambian** valores y Key Vault  
âœ… **Deployment simplificado**

El paquete busca la configuraciÃ³n en este orden:

1. **Variables de entorno** (ej: `COSMOS_URI`)
2. **Azure Key Vault** (ej: `cosmos-uri`)
3. **Valor por defecto**

### Variables de Entorno (Desarrollo Local)

#### ConfiguraciÃ³n EstÃ¡ndar:
```bash
# Variables sin prefijo de ambiente
COSMOS_URI=https://your-cosmos-dev.documents.azure.com:443/
COSMOS_KEY=your-cosmos-dev-key
COSMOS_DATABASE=myapp-dev
COSMOS_CONTAINER=documents
COSMOS_PARTITION=/id

# ConfiguraciÃ³n del entorno
APP_ENV=dev
KEY_VAULT_NAME=your-keyvault-dev

# Azure Data Lake
DATALAKE_ACCOUNT_NAME=your-adls-account
DATALAKE_FILE_SYSTEM_NAME=your-filesystem
DATALAKE_ACCOUNT_KEY=your-adls-key

# Azure Blob Storage
BLOB_STORAGE_ACCOUNT_NAME=your-blob-account
BLOB_STORAGE_FILE_SYSTEM_NAME=your-container
BLOB_STORAGE_ACCOUNT_KEY=your-blob-key

# Azure Cognitive Search
SEARCH_ENDPOINT=https://your-search-service.search.windows.net
SEARCH_API_KEY=your-search-api-key
SEARCH_INDEX_NAME=your-index
```

### Azure Key Vault (ProducciÃ³n)

#### Secretos por Ambiente:

**DESARROLLO** - Key Vault: `your-keyvault-dev`
- `cosmos-uri`
- `cosmos-key`
- `cosmos-database`
- `cosmos-container`
- `datalake-account-name`
- `datalake-file-system-name`
- `datalake-account-key`
- `blob-storage-account-name`
- `blob-storage-file-system-name`
- `blob-storage-account-key`
- `search-endpoint`
- `search-api-key`
- `search-index-name`

**PRODUCCIÃ“N** - Key Vault: `your-keyvault-prod`
- `cosmos-uri` (mismos nombres!)
- `cosmos-key`
- `cosmos-database`
- `cosmos-container`
- `datalake-account-name`
- `datalake-file-system-name`
- `datalake-account-key`
- `blob-storage-account-name`
- `blob-storage-file-system-name`
- `blob-storage-account-key`
- `search-endpoint`
- `search-api-key`
- `search-index-name`

> ðŸ”„ **Para cambiar ambiente**: Solo actualiza `KEY_VAULT_NAME=your-keyvault-prod`

## AutenticaciÃ³n con Azure

El paquete utiliza `DefaultAzureCredential` que soporta mÃºltiples mÃ©todos:

- âœ… Azure CLI (`az login`)
- âœ… Visual Studio Code
- âœ… Managed Identity (en Azure)
- âœ… Variables de entorno
- âœ… Interactive browser

### Configurar Azure CLI (Recomendado para desarrollo)

```bash
az login
```

## Estructura del Proyecto

```
dk_azure_services/
â”œâ”€â”€ __init__.py              # Exportaciones principales
â”œâ”€â”€ common/                  # Utilidades compartidas
â”‚   â”œâ”€â”€ auth.py             # AutenticaciÃ³n centralizada
â”‚   â”œâ”€â”€ config.py           # GestiÃ³n de configuraciÃ³n
â”‚   â””â”€â”€ exceptions.py       # Excepciones personalizadas
â”œâ”€â”€ cosmos/                  # Azure Cosmos DB
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ simple_client.py    # Cliente simplificado principal
â”‚   â”œâ”€â”€ database_manager.py # GestiÃ³n de bases de datos (avanzado)
â”‚   â”œâ”€â”€ container_manager.py# GestiÃ³n de contenedores (avanzado)
â”‚   â””â”€â”€ documents_manager.py# GestiÃ³n de documentos (avanzado)
â”œâ”€â”€ datalake/                # Azure Data Lake Storage Gen2
â”‚   â””â”€â”€ async_datalake.py
â”œâ”€â”€ blob_storage/            # Azure Blob Storage
â”‚   â””â”€â”€ async_blob_storage.py
â”œâ”€â”€ searchai/                # Azure Cognitive Search
â”‚   â””â”€â”€ async_search.py
â””â”€â”€ keyvault/               # Azure Key Vault (gestiÃ³n vÃ­a common/config)
```

## Ejemplos Avanzados

### Uso con ConfigManager Personalizado

```python
from dk_azure_services.common.config import ConfigManager
from dk_azure_services import CosmosDBClient

# ConfiguraciÃ³n personalizada
config = ConfigManager(environment="production", key_vault_name="my-vault")
client = CosmosDBClient(config_manager=config)
```

### Operaciones en Lote

```python
# Crear mÃºltiples documentos
documentos = [
    {"id": "user1", "name": "Ana", "role": "Manager"},
    {"id": "user2", "name": "Carlos", "role": "Developer"},
    {"id": "user3", "name": "MarÃ­a", "role": "Designer"}
]

resultados = client.bulk_create_documents(documentos)
print(f"Creados {len(resultados)} documentos")
```

### InformaciÃ³n del Contenedor

```python
info = client.get_container_info()
print(f"Entorno: {info['environment']}")
print(f"Base de datos: {info['database_name']}")
print(f"Contenedor: {info['container_name']}")
```

## Desarrollo

### Configurar Entorno de Desarrollo

```bash
# Clonar el repositorio
git clone https://github.com/yourusername/dk-azure-services.git
cd dk-azure-services

# Instalar dependencias de desarrollo
pip install -e .[dev]

# Configurar pre-commit hooks
pre-commit install
```

### Ejecutar Tests

```bash
pytest
```

### Formatear CÃ³digo

```bash
black dk_azure_services/
isort dk_azure_services/
```

### Verificar Tipado

```bash
mypy dk_azure_services/
```

## Â¿Por quÃ© 100% AsÃ­ncrono? ðŸ¤”

Este paquete fue diseÃ±ado desde cero para ser **completamente asÃ­ncrono** por estas razones:

### **ðŸŽ¯ Rendimiento Superior**
- **10-50x mÃ¡s rÃ¡pido** para operaciones en lote
- **Concurrencia nativa** - mÃºltiples operaciones simultÃ¡neas
- **Eficiencia de recursos** - menos uso de CPU y memoria

### **ðŸš€ Ideal para Servicios de Azure**
- **Azure Cosmos DB** - Base de datos distribuida (I/O intensivo)
- **Azure OpenAI** - Llamadas a LLMs con alta latencia
- **Azure Blob Storage** - Transferencia de archivos grandes
- **Azure Key Vault** - Operaciones de red para secretos

### **ðŸ“± Perfecto para Apps Modernas**
- **FastAPI** - Framework asÃ­ncrono por excelencia  
- **Starlette** - Base asÃ­ncrona sÃ³lida
- **Microservicios** - Escalabilidad superior
- **APIs REST** - Mejor throughput

### **ðŸ§  API MÃ¡s Simple**
- **Una sola forma** de hacer las cosas (bien hecha)
- **Context managers** automÃ¡ticos
- **Menos decisiones** que tomar al desarrollar

> ðŸ’¡ **Tip**: Si necesitas compatibilidad sÃ­ncrona, puedes usar `asyncio.run()` o bibliotecas como `asgiref.sync.sync_to_async()`.

## Roadmap

- [x] Azure Cosmos DB - Cliente asÃ­ncrono completo
- [x] Azure Data Lake - Cliente asÃ­ncrono
- [x] Azure Blob Storage - Cliente asÃ­ncrono
- [x] Azure Cognitive Search - Cliente asÃ­ncrono
- [ ] Azure OpenAI - Cliente para chat y embeddings
- [ ] Azure Key Vault - Cliente extendido
- [ ] Azure Service Bus - MensajerÃ­a
- [ ] Ejemplos con FastAPI
- [ ] Template de Docker
- [ ] CI/CD con GitHub Actions

## Contribuir

Las contribuciones son bienvenidas. Por favor:

1. Fork el proyecto
2. Crea una branch para tu feature (`git checkout -b feature/amazing-feature`)
3. Commit tus cambios (`git commit -m 'feat: add amazing feature'`)
4. Push a la branch (`git push origin feature/amazing-feature`)
5. Abre un Pull Request

## Licencia

Este proyecto estÃ¡ bajo la Licencia MIT. Ver el archivo `LICENSE` para mÃ¡s detalles.

## Autor

**Leonar Santiago Castro** - *Desarrollo inicial* - [GitHub](https://github.com/yourusername)

## Agradecimientos

- Equipo de Azure SDK para Python
- Comunidad de desarrolladores de Azure
- Contribuidores del proyecto 