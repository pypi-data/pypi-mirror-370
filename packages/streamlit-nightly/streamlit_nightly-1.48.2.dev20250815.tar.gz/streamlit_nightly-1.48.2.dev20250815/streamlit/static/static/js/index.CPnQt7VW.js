import{r,E as j,_ as k,u as B,aJ as R,aK as G,m as x,aL as X,aM as $,aN as z,aO as L,aP as K,aQ as Q,o as F,aR as M,x as _,aS as Y,aT as Z,aU as q,J as ee,aV as te,j as N,e as ne,aW as se,aX as re,aY as ae}from"./index.Dd6t8viw.js";import{w as oe,E as ie}from"./withFullScreenWrapper.DO6Lv2t_.js";import{a as I,S as H,T as ce}from"./Toolbar.CRanrSsg.js";import{R as le}from"./index.D0SK_gOf.js";import{u as ue}from"./FormClearHelper.CdPDlJPQ.js";import"./sprintf.D7DtBTRn.js";import"./checkbox.DcA-U3pK.js";import"./createDownloadLinkElement.ZaXNnPK4.js";import"./toConsumableArray.CRNt08cC.js";import"./possibleConstructorReturn.CyDaXnG6.js";import"./createSuper.BqfCBVAH.js";import"./FileDownload.esm.CM0FMi6m.js";var J=r.forwardRef(function(n,t){var a={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return r.createElement(j,k({iconAttrs:a,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},n,{ref:t}),r.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),r.createElement("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"}))});J.displayName="InsertChart";var P=r.forwardRef(function(n,t){var a={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return r.createElement(j,k({iconAttrs:a,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},n,{ref:t}),r.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),r.createElement("path",{d:"M20 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 2v3H5V5h15zm-5 14h-5v-9h5v9zM5 10h3v9H5v-9zm12 9v-9h3v9h-3z"}))});P.displayName="TableChart";const fe=20;function de(n){"params"in n&&"encoding"in n&&n.params.forEach(t=>{"select"in t&&(["interval","point"].includes(t.select)&&(t.select={type:t.select}),"type"in t.select&&t.select.type==="point"&&!("encodings"in t.select)&&x(t.select.encodings)&&(t.select.encodings=Object.keys(n.encoding)))})}const me=(n,t,a,s,o,f,l,h)=>{const e=JSON.parse(n);if(a==="streamlit"?e.config=R(e.config,o):e.usermeta?.embedOptions?.theme==="streamlit"?(e.config=R(e.config,o),e.usermeta.embedOptions.theme=void 0):e.config=G(e.config,o),e.title&&(typeof e.title=="string"&&(e.title={text:e.title}),e.title.limit=e.title.limit??Math.max(l-40,0)),f?(e.width=l,e.height=h,"vconcat"in e&&e.vconcat.forEach(u=>{u.width=l})):t&&(e.width=l,"vconcat"in e&&e.vconcat.forEach(u=>{u.width=l})),e.padding||(e.padding={}),x(e.padding.bottom)&&(e.padding.bottom=fe),e.datasets)throw new Error("Datasets should not be passed as part of the spec");return s.length>0&&de(e),e},he=(n,t,a,s)=>{const o=B(),{id:f,formId:l,spec:h,data:e,datasets:u,useContainerWidth:i,vegaLiteTheme:p,selectionMode:c}=n,S=r.useMemo(()=>c,[JSON.stringify(c)]),y=r.useMemo(()=>me(h,i,p,S,o,t,a||0,s),[h,i,p,S,o,t,a,s]);return{id:f,formId:l,vegaLiteTheme:p,spec:y,selectionMode:S,data:e,datasets:u,useContainerWidth:i}},pe={DATAFRAME_INDEX:"(index)"};function ge(n){return!n||n.dimensions.numDataRows===0?null:A(n)}function Se(n){const t=D(n);if(x(t))return null;const a={};for(const[s,o]of Object.entries(t))a[s]=A(o);return a}function D(n){if(n?.length===0)return null;const t={};return n.forEach(a=>{if(!a)return;const s=a.hasName?a.name:null;t[s]=a.data}),t}function A(n,t=0){if(n.dimensions.numDataRows===0)return[];const a=[],{numDataRows:s,numDataColumns:o,numIndexColumns:f}=n.dimensions,l=n.columnTypes[0]??void 0,h=l&&l.type===X.INDEX&&($(l)||z(l)||L(l));for(let e=t;e<s;e++){const u={};if(h){const{content:i}=n.getCell(e,0);u[pe.DATAFRAME_INDEX]=typeof i=="bigint"?Number(i):i}for(let i=0;i<o;i++){const p=i+f,{content:c,contentType:S}=n.getCell(e,p);if((c instanceof Date||typeof c=="number"&&Number.isFinite(c))&&(z(S)||L(S))&&!K(S)){const y=new Date(c).getTimezoneOffset()*60*1e3;u[n.columnNames[0][p]]=c.valueOf()+y}else u[n.columnNames[0][p]]=typeof c=="bigint"?Number(c):c}a.push(u)}return a}const ye=150,we=_.getLogger("useVegaLiteSelections"),be=(n,t,a)=>{const{id:s,formId:o,selectionMode:f}=n,l=r.useCallback(e=>{f.forEach(i=>{e.addSignalListener(i,Q(ye,(p,c)=>{const S=e.getState({data:(w,b)=>f.some(v=>`${v}_store`===w),recurse:!1});F(S)&&t.setElementState(s,"viewState",S);let y=c;"vlPoint"in c&&"or"in c.vlPoint&&(y=c.vlPoint.or);const E={id:s,formId:o},g=JSON.parse(t.getStringValue(E)||"{}"),d={selection:{...g?.selection||{},[p]:y||{}}};M(g,d)||t.setStringValue(E,JSON.stringify(d),{fromUi:!0},a)}))});const u=t.getElementState(s,"viewState");if(F(u))try{return e.setState(u)}catch(i){we.warn("Failed to restore view state",i)}return e},[s,f,t,o,a]),h=r.useCallback(()=>{const e={selection:{}};f.forEach(c=>{e.selection[c]={}});const u={id:s,formId:o},i=t.getStringValue(u),p=i?JSON.parse(i):e;M(p,e)||t.setStringValue(u,JSON.stringify(e),{fromUi:!0},a)},[s,o,a,f,t]);return{maybeConfigureSelections:l,onFormCleared:h}},W="source",Ce=_.getLogger("useVegaEmbed");function Ee(n,t,a){const s=r.useRef(null),o=r.useRef(null),f=r.useRef(W),l=r.useRef(null),h=r.useRef([]),{maybeConfigureSelections:e,onFormCleared:u}=be(n,t,a);ue({widgetMgr:t,element:n,onFormCleared:u});const{data:i,datasets:p}=n;r.useEffect(()=>{s.current===null&&(l.current=i,h.current=p)},[i,p]);const c=r.useCallback(()=>{o.current&&o.current(),o.current=null,s.current=null},[]),S=r.useCallback(async(g,d)=>{if(g.current===null)throw new Error("Element missing.");c();const w={ast:!0,expr:Z,tooltip:{disableDefaultStyle:!0},defaultStyle:!1,forceActionsMenu:!0},{vgSpec:b,view:v,finalize:C}=await Y(g.current,d,w);s.current=e(v),o.current=C;const m=Se(h.current),V=m?Object.keys(m):[];if(V.length===1){const[T]=V;f.current=T}else V.length===0&&b.data&&(f.current=W);const O=ge(l.current);if(O&&s.current.insert(f.current,O),m)for(const[T,U]of Object.entries(m))s.current.insert(T,U);return await s.current.runAsync(),await s.current.resize().runAsync(),s.current},[c,e]),y=r.useCallback((g,d,w,b)=>{if(!b||b.dimensions.numDataRows===0){try{g.remove(d,q)}finally{}return}if(!w||w.dimensions.numDataRows===0){g.insert(d,A(b));return}b.hash!==w.hash&&(g.data(d,A(b)),Ce.info(`Had to clear the ${d} dataset before inserting data through Vega view.`))},[]),E=r.useCallback(async(g,d)=>{if(s.current===null)return null;const w=l.current,b=h.current;(w||g)&&y(s.current,f.current,w,g);const v=D(b)??{},C=D(d)??{};for(const[m,V]of Object.entries(C)){const O=m||f.current,T=v[O];y(s.current,O,T,V)}for(const m of Object.keys(v))!Object.hasOwn(C,m)&&m!==f.current&&y(s.current,m,null,null);return await s.current?.resize().runAsync(),l.current=g,h.current=d,s.current},[y]);return{createView:S,updateView:E,finalizeView:c}}function ve(n){try{const t=typeof n=="string"?JSON.parse(n):n;return!!(t.facet||t.encoding?.row||t.encoding?.column||t.encoding?.facet)}catch{return!1}}const Ve=({disableFullscreenMode:n,element:t,fragmentId:a,widgetMgr:s})=>{const[o,f]=r.useState(!1),[l,h]=r.useState(!1),{expanded:e,height:u,width:i,expand:p,collapse:c}=ee(ie),{values:[S,y],elementRef:E}=te(r.useMemo(()=>["width","height"],[]),[o]),g=ve(t.spec),d=he(t,e,g?i??0:S,u??0),{createView:w,updateView:b,finalizeView:v}=Ee(d,s,a),{data:C,datasets:m,spec:V}=d;return r.useLayoutEffect(()=>(E.current!==null&&w(E,V),v),[w,v,V,i,u,o,E]),r.useEffect(()=>{b(C,m)},[C,m,b]),r.useEffect(()=>{C||m&&m[0]?.data?h(!0):h(!1)},[C,m]),o?N(le,{data:C??m[0]?.data,height:y??void 0,customToolbarActions:[N(I,{label:"Show chart",icon:J,onClick:()=>{f(!1)}},"show-chart")]}):ne(H,{height:u,useContainerWidth:d.useContainerWidth,children:[N(ce,{target:H,isFullScreen:e,onExpand:p,onCollapse:c,disableFullscreenMode:n,children:l&&N(I,{label:"Show data",icon:P,onClick:()=>{f(!0)}})}),N(re,{styles:[se]}),N(ae,{"data-testid":"stVegaLiteChart",className:"stVegaLiteChart",useContainerWidth:d.useContainerWidth,isFullScreen:e,ref:E})]})},Ne=oe(Ve),We=r.memo(Ne);export{se as StyledVegaLiteChartTooltips,R as applyStreamlitTheme,We as default};
