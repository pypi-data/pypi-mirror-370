name: Dependabot Auto-merge

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  auto-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
    - name: Check if PR is from Dependabot
      id: check-author
      run: |
        if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
          echo "is_dependabot=true" >> $GITHUB_OUTPUT
        else
          echo "is_dependabot=false" >> $GITHUB_OUTPUT
        fi

    - uses: actions/checkout@v4
      if: steps.check-author.outputs.is_dependabot == 'true'

    - name: Set up Python
      if: steps.check-author.outputs.is_dependabot == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies and run tests
      if: steps.check-author.outputs.is_dependabot == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        
        # Run quick test suite to ensure changes don't break anything
        pytest tests/ -x --tb=short

    - name: Check PR metadata
      if: steps.check-author.outputs.is_dependabot == 'true'
      id: check-pr
      run: |
        # Get PR title and determine if it's a minor/patch update
        PR_TITLE="${{ github.event.pull_request.title }}"
        echo "PR Title: $PR_TITLE"
        
        # Check if it's a patch or minor version update (auto-mergeable)
        if echo "$PR_TITLE" | grep -E "(patch|minor|Bump.*from.*to)" > /dev/null; then
          echo "auto_merge=true" >> $GITHUB_OUTPUT
          echo "This appears to be a patch/minor update - eligible for auto-merge"
        else
          echo "auto_merge=false" >> $GITHUB_OUTPUT
          echo "This appears to be a major update - manual review required"
        fi

    - name: Auto-approve and merge
      if: steps.check-author.outputs.is_dependabot == 'true' && steps.check-pr.outputs.auto_merge == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Approve the PR
        gh pr review ${{ github.event.pull_request.number }} --approve \
          --body "Auto-approved by workflow: Dependabot patch/minor update passed tests ‚úÖ"
        
        # Enable auto-merge
        gh pr merge ${{ github.event.pull_request.number }} --auto --squash

    - name: Add comment for manual review
      if: steps.check-author.outputs.is_dependabot == 'true' && steps.check-pr.outputs.auto_merge == 'false'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh pr comment ${{ github.event.pull_request.number }} \
          --body "üîç **Manual Review Required**
          
          This Dependabot PR appears to be a major version update and requires manual review before merging.
          
          **Before merging, please:**
          - Review the changelog for breaking changes
          - Run the full test suite locally
          - Test the application manually if needed
          - Update any code that might be affected by the changes
          
          Once reviewed, you can merge this PR manually."
