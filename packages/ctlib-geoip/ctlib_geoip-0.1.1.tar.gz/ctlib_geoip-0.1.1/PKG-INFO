Metadata-Version: 2.4
Name: ctlib-geoip
Version: 0.1.1
Summary: A GeoIP SDK supporting both sync and async operations
Author-email: jimin <jimin@codetech.top>
License: MIT
Keywords: codetech,ctlib
Classifier: Development Status :: 4 - Beta
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: OS Independent
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Requires-Python: >=3.8
Requires-Dist: cachetools>=5.0.0
Requires-Dist: httpx>=0.24.0
Requires-Dist: pydantic>=2.0.0
Description-Content-Type: text/markdown

# ctlib-geoip

ä¸€ä¸ªæ”¯æŒåŒæ­¥å’Œå¼‚æ­¥æ“ä½œçš„GeoIP SDKï¼ŒåŸºäºhttpxæ„å»ºï¼Œæä¾›é«˜æ•ˆçš„IPåœ°ç†ä½ç½®æŸ¥è¯¢æœåŠ¡ã€‚

## ç‰¹æ€§

- ğŸš€ æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥æ“ä½œ
- ğŸ’¾ å†…ç½®LRUç¼“å­˜
- ğŸ”„ æ™ºèƒ½é‡è¯•æœºåˆ¶ï¼Œæ”¯æŒæŒ‡æ•°é€€é¿
- ğŸ“Š æ”¯æŒå¤šç§æ•°æ®æºï¼ˆipinfo.io, ip-api.com, ip.sb, iplocate.ioï¼‰
- ğŸ¯ ç±»å‹å®‰å…¨ï¼Œå®Œæ•´çš„ç±»å‹æç¤ºå’Œæ³›å‹æ”¯æŒ
- ğŸ“ è¯¦ç»†çš„æ—¥å¿—è®°å½•
- ğŸŒ çµæ´»çš„URLæ¨¡æ¿ç³»ç»Ÿï¼Œæ”¯æŒå¤æ‚APIç«¯ç‚¹
- ğŸ”§ æ¸…æ™°çš„å‚æ•°è¯­ä¹‰ï¼šUnsetè¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼ï¼ŒNoneè¡¨ç¤ºä¸å‘é€å‚æ•°
- ğŸŒ å†…ç½®åœ°ç†ä½ç½®æ ‘ç®¡ç†ï¼Œæ”¯æŒé«˜æ•ˆçš„åœ°ç†ä½ç½®åŒ¹é…å’Œè®¿é—®æ§åˆ¶

## å®‰è£…

```bash
pip install ctlib-geoip
```

## å¿«é€Ÿå¼€å§‹

### åŒæ­¥ä½¿ç”¨

```python
from ctlib_geoip import GeoIPClient

# åˆ›å»ºå®¢æˆ·ç«¯
client = GeoIPClient(url="https://geoip.example.com/api/{ip}")

# æŸ¥è¯¢IPåœ°å€
result = client.lookup("8.8.8.8")
if result:
    print(f"IP: {result.ip}")
    print(f"å›½å®¶: {result.country}")
    print(f"åœ°åŒº: {result.region}")
    print(f"åŸå¸‚: {result.city}")
    print(f"æ•°æ®æº: {result.source}")
    print(f"æ›´æ–°æ—¶é—´: {result.updated_at}")
```

### å¼‚æ­¥ä½¿ç”¨

```python
import asyncio
from ctlib_geoip import AsyncGeoIPClient


async def main():
    # åˆ›å»ºå¼‚æ­¥å®¢æˆ·ç«¯
    client = AsyncGeoIPClient(url="https://geoip.example.com/api/{ip}")

    # å¼‚æ­¥æŸ¥è¯¢IPåœ°å€
    result = await client.lookup("1.1.1.1")
    if result:
        print(f"IP: {result.ip}")
        print(f"å›½å®¶: {result.country}")
        print(f"åœ°åŒº: {result.region}")
        print(f"åŸå¸‚: {result.city}")


# è¿è¡Œå¼‚æ­¥å‡½æ•°
asyncio.run(main())
```

### è‡ªå®šä¹‰å‚æ•°

```python
from ctlib_geoip import GeoIPClient

client = GeoIPClient(
    url="https://geoip.example.com/api/{ip}",
    source="ipinfo.io",
    ttl=86400,  # 24å°æ—¶
    max_retries=5,
    max_wait_time=15,
    headers={"User-Agent": "MyApp/1.0"}
)

# ä½¿ç”¨é»˜è®¤å‚æ•°
result1 = client.lookup("8.8.8.8")

# è¦†ç›–ç‰¹å®šå‚æ•°
result2 = client.lookup("8.8.8.8", source="ip-api.com")
result3 = client.lookup("8.8.8.8", ttl=3600)

# ä¸æºå¸¦sourceå‚æ•°ï¼ˆåç«¯ä¸å¤„ç†sourceï¼‰
result4 = client.lookup("8.8.8.8", source=None)
```

## APIå‚è€ƒ

### GeoIPClient

åŒæ­¥å®¢æˆ·ç«¯ç±»ã€‚

#### å‚æ•°

- `url: str` - GeoIPæœåŠ¡URLæ¨¡æ¿ï¼Œæ”¯æŒ `{ip}` å ä½ç¬¦ï¼Œå¦‚ `https://geoip.example.com/api/{ip}`
- `source: Union[DataSource, str, None] = None` - æ•°æ®æºï¼ŒNoneè¡¨ç¤ºä¸æŒ‡å®šæ•°æ®æº
- `ttl: int = 2592000` - æ•°æ®æœ‰æ•ˆæœŸï¼ˆç§’ï¼Œé»˜è®¤30å¤©ï¼‰
- `cache_len: int = 256` - ç¼“å­˜æœ€å¤§æ¡æ•°
- `max_retries: int = 3` - æœ€å¤§é‡è¯•æ¬¡æ•°
- `max_wait_time: int = 10` - æœ€é•¿ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰
- `headers: Dict[str, str] = None` - HTTPè¯·æ±‚å¤´

#### æ–¹æ³•

- `lookup(ip: Union[str, IPv4Address], source: SourceType = Unset, ttl: TTLType = Unset, **extra) -> Optional[GeoIP]`

### AsyncGeoIPClient

å¼‚æ­¥å®¢æˆ·ç«¯ç±»ï¼Œå‚æ•°å’Œæ–¹æ³•ä¸åŒæ­¥å®¢æˆ·ç«¯ç›¸åŒï¼Œä½†æ‰€æœ‰æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ã€‚

### GeoIP

æ•°æ®æ¨¡å‹ç±»ã€‚

#### å­—æ®µ

- `ip: str` - IPåœ°å€
- `country: str` - å›½å®¶ä»£ç 
- `region: str` - åœ°åŒº
- `city: str` - åŸå¸‚
- `updated_at: datetime` - æ•°æ®æ›´æ–°æ—¶é—´
- `source: str` - æ•°æ®æ¥æº

### GeoInfo

åœ°ç†ä½ç½®ä¿¡æ¯æ¨¡å‹ç±»ã€‚

#### å­—æ®µ

- `name: Optional[str]` - åœ°ç†ä½ç½®åç§°
- `country: str` - å›½å®¶ä»£ç 
- `region: Optional[str]` - åœ°åŒºåç§°
- `city: Optional[str]` - åŸå¸‚åç§°
- `detail: Optional[str]` - è¯¦ç»†æè¿°
- `geo_id: Optional[int]` - åœ°ç†ä½ç½®ID
- `geo_code: Optional[str]` - åœ°ç†ä½ç½®ä»£ç ï¼ˆæ ¼å¼ï¼šå›½å®¶-åœ°åŒº-åŸå¸‚ï¼‰

#### ç±»æ–¹æ³•

- `from_geo_id(geo_id: int)` - æ ¹æ®åœ°ç†ä½ç½®IDæŸ¥æ‰¾
- `from_geo_code(geo_code: str)` - æ ¹æ®åœ°ç†ä½ç½®ä»£ç æŸ¥æ‰¾
- `from_name(name: str)` - æ ¹æ®åç§°æŸ¥æ‰¾

### GeoTree

åœ°ç†ä½ç½®æ ‘ç®¡ç†ç±»ï¼Œç”¨äºé«˜æ•ˆçš„åœ°ç†ä½ç½®åŒ¹é…å’Œè®¿é—®æ§åˆ¶ã€‚

#### åŠŸèƒ½ç‰¹æ€§

- **ä¸‰å±‚åµŒå¥—ç»“æ„**: å›½å®¶(Country) â†’ åœ°åŒº(Region) â†’ åŸå¸‚(City)
- **é«˜æ•ˆæŸ¥è¯¢**: ä½¿ç”¨å­—å…¸ç»“æ„ï¼ŒæŸ¥è¯¢æ—¶é—´å¤æ‚åº¦O(1)
- **çµæ´»åŒ¹é…**: æ”¯æŒä¸åŒçº§åˆ«çš„æ¨¡ç³ŠåŒ¹é…
- **è®¿é—®æ§åˆ¶**: é€‚ç”¨äºåŸºäºåœ°ç†ä½ç½®çš„æƒé™æ§åˆ¶

#### ä¸»è¦æ–¹æ³•

- `add(geo: GeoInfo)` - æ·»åŠ åœ°ç†ä½ç½®ä¿¡æ¯åˆ°æ ‘ä¸­
- `contains(geoip: GeoIP) -> bool` - åˆ¤æ–­GeoIPæ˜¯å¦åœ¨æ ‘ä¸­

#### ä½¿ç”¨ç¤ºä¾‹

```python
from ctlib_geoip import GeoTree, GeoInfo

# åˆ›å»ºåœ°ç†ä½ç½®æ ‘
geo_tree = GeoTree([
    GeoInfo(country="HK", region="Central and Western"),
    GeoInfo(country="CN", region="Guangdong", city="Shenzhen")
])

# æ£€æŸ¥GeoIPæ˜¯å¦åœ¨å…è®¸çš„åœ°ç†ä½ç½®èŒƒå›´å†…
geoip = GeoIP(ip="8.8.8.8", country="HK", region="Central and Western", city="Central")
is_allowed = geo_tree.contains(geoip)  # True
```

### Unset

ç‰¹æ®Šæ ‡è®°ç±»ï¼Œç”¨äºè¡¨ç¤ºä½¿ç”¨å®¢æˆ·ç«¯åˆ›å»ºæ—¶çš„é»˜è®¤å‚æ•°ã€‚

### å‚æ•°è¯­ä¹‰è¯´æ˜

- **`Unset`**: ä½¿ç”¨å®¢æˆ·ç«¯åˆ›å»ºæ—¶è®¾ç½®çš„é»˜è®¤å€¼
- **`None`**: ä¸å‘åç«¯å‘é€è¯¥å‚æ•°
- **å…·ä½“å€¼**: ä½¿ç”¨æŒ‡å®šçš„å€¼è¦†ç›–é»˜è®¤å€¼

### URLæ¨¡æ¿ç³»ç»Ÿ

æ”¯æŒçµæ´»çš„URLæ¨¡æ¿ï¼Œä¾‹å¦‚ï¼š

```python
# åŸºæœ¬æ¨¡æ¿
url = "https://geoip.example.com/{ip}"

# å¸¦æŸ¥è¯¢å‚æ•°çš„æ¨¡æ¿
url = "https://geoip.example.com/api/{ip}?key=value"

# å¤æ‚æ¨¡æ¿
url = "https://geoip.example.com/v1/geoip/{ip}?format=json&lang=zh"
```

ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç† `{ip}` å ä½ç¬¦å’ŒæŸ¥è¯¢å‚æ•°çš„ç®¡ç†ã€‚

## æ•°æ®æº

æ”¯æŒçš„æ•°æ®æºï¼š

- `ipinfo.io` - IPInfoæœåŠ¡
- `ip-api.com` - IP-APIæœåŠ¡
- `ip.sb` - IP.SBæœåŠ¡
- `iplocate.io` - IPLocateæœåŠ¡

ä¹Ÿæ”¯æŒè‡ªå®šä¹‰æ•°æ®æºã€‚

## åœ°ç†ä½ç½®æ•°æ®

SDKå†…ç½®äº†ä¸°å¯Œçš„åœ°ç†ä½ç½®æ•°æ®ï¼Œæ”¯æŒä»¥ä¸‹åœ°åŒºï¼š

- **ä¸­å›½ (CN)**: åŒ…å«420ä¸ªåœ°ç†ä½ç½®è®°å½•ï¼Œæ¶µç›–æ‰€æœ‰çœä»½å’Œä¸»è¦åŸå¸‚
- **é¦™æ¸¯ (HK)**: åŒ…å«20ä¸ªåœ°åŒºè®°å½•ï¼Œæ¶µç›–æ‰€æœ‰è¡Œæ”¿åŒº
- **å°æ¹¾ (TW)**: åŒ…å«32ä¸ªåœ°ç†ä½ç½®è®°å½•
- **æ¾³é—¨ (MO)**: åŒ…å«10ä¸ªåœ°ç†ä½ç½®è®°å½•

åœ°ç†ä½ç½®æ•°æ®ä½¿ç”¨æ ‡å‡†åŒ–çš„æ ¼å¼ï¼š
- **geo_codeæ ¼å¼**: `å›½å®¶-åœ°åŒº-åŸå¸‚`ï¼Œå¦‚ `HK-NCW---`ï¼ˆé¦™æ¸¯-ä¸­è¥¿åŒºï¼‰
- **æ”¯æŒæŸ¥è¯¢æ–¹å¼**: æŒ‰IDã€ä»£ç ã€åç§°ç­‰å¤šç§æ–¹å¼æŸ¥æ‰¾åœ°ç†ä½ç½®ä¿¡æ¯

## ç¼“å­˜ç­–ç•¥

- ä½¿ç”¨LRUç¼“å­˜
- ç¼“å­˜ç»“æ„ï¼š`{ip: {source: GeoIP}}`ï¼Œæ”¯æŒåŒä¸€IPçš„å¤šä¸ªæ•°æ®æºç»“æœ
- TTLè¿‡æœŸæ£€æŸ¥åœ¨ä¸šåŠ¡å±‚è¿›è¡Œï¼Œç¼“å­˜ç®¡ç†å™¨ä¸“æ³¨äºå­˜å‚¨ç®¡ç†
- æ™ºèƒ½ç¼“å­˜ç­–ç•¥ï¼šä¼˜å…ˆè¿”å›æŒ‡å®šæ•°æ®æºçš„ç»“æœï¼Œå…¶æ¬¡è¿”å›æœ€æ–°ç»“æœ

## é‡è¯•æœºåˆ¶

- æ”¯æŒæŒ‡æ•°é€€é¿é‡è¯•
- ä»1ç§’å¼€å§‹ç­‰å¾…ï¼Œæœ€å¤§ç­‰å¾…æ—¶é—´å¯é…ç½®
- é‡è¯•æ¬¡æ•°å¯é…ç½®

## æ—¥å¿—

ä½¿ç”¨Pythonæ ‡å‡†loggingæ¨¡å—ï¼š

- DEBUGçº§åˆ«ï¼šè®°å½•æŸ¥è¯¢æ“ä½œ
- ERRORçº§åˆ«ï¼šè®°å½•é”™è¯¯ä¿¡æ¯

## é«˜çº§åŠŸèƒ½

### åœ°ç†ä½ç½®è®¿é—®æ§åˆ¶

ä½¿ç”¨GeoTreeå®ç°åŸºäºåœ°ç†ä½ç½®çš„è®¿é—®æ§åˆ¶ï¼š

```python
from ctlib_geoip import GeoTree, GeoInfo, GeoIP

# å®šä¹‰ç¦æ­¢è®¿é—®çš„åœ°ç†ä½ç½®
blocked_regions = GeoTree([
    GeoInfo(country="US", region="Texas"),  # ç¦æ­¢ç¾å›½å¾·å…‹è¨æ–¯å·
    GeoInfo(country="US", region="Florida"),  # ç¦æ­¢ç¾å›½ä½›ç½—é‡Œè¾¾å·
    GeoInfo(country="HK", region="Yau Tsim Mong"),  # ç¦æ­¢é¦™æ¸¯æ²¹å°–æ—ºåŒº
])

def check_access(geoip: GeoIP) -> bool:
    """æ£€æŸ¥IPåœ°å€æ˜¯å¦è¢«ç¦æ­¢è®¿é—®"""
    return not blocked_regions.contains(geoip)

# ä½¿ç”¨ç¤ºä¾‹
geoip = GeoIP(ip="1.2.3.4", country="US", region="Texas", city="Houston")
if check_access(geoip):
    print("å…è®¸è®¿é—®")
else:
    print("æ‹’ç»è®¿é—® - è¯¥åœ°åŒºè¢«ç¦æ­¢è®¿é—®")
```

### åœ°ç†ä½ç½®æ•°æ®åˆ†æ

åˆ©ç”¨å†…ç½®çš„åœ°ç†ä½ç½®æ•°æ®è¿›è¡ŒåŒºåŸŸåˆ†æï¼š

```python
from ctlib_geoip import GeoInfo

# æŸ¥æ‰¾ç‰¹å®šåœ°ç†ä½ç½®ä¿¡æ¯
shenzhen = GeoInfo.from_name("Shenzhen")
print(f"æ·±åœ³: {shenzhen.detail}")

# æ ¹æ®åœ°ç†ä½ç½®ä»£ç æŸ¥æ‰¾
hk_central = GeoInfo.from_geo_code("HK-HCW---")
print(f"é¦™æ¸¯ä¸­è¥¿åŒº: {hk_central.name}")
```

## è®¸å¯è¯

MIT License
