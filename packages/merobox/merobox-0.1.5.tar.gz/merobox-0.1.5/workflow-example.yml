description: A sample workflow that demonstrates the bootstrap functionality with dynamic value capture
name: Sample Calimero Workflow

nodes:
  chain_id: testnet-1
  count: 2
  image: ghcr.io/calimero-network/merod:6a47604
  prefix: calimero-node

steps:
  # Step 1: Install the application on the first node
  # This captures the application ID for use in subsequent steps
  - name: Install Application on Node 1
    type: install_application
    node: calimero-node-1
    path: ./kv_store.wasm
    dev: true

  # Step 2: Create a context using the installed application
  # Uses the captured application ID from step 1
  - name: Create Context on Node 1
    type: create_context
    node: calimero-node-1
    application_id: '{{install.calimero-node-1}}'

  # Step 3: Generate an identity on the second node
  # This captures the public key for use in invitation and joining
  - name: Create Identity on Node 2
    type: create_identity
    node: calimero-node-2

  # Step 4: Wait for identity creation to complete
  - name: Wait for Identity Creation
    type: wait
    seconds: 5

  # Step 5: Invite the second node to join the context
  # Uses captured values: context ID, member public key, and identity public key
  - name: Invite Node 2 from Node 1
    type: invite_identity
    node: calimero-node-1
    context_id: '{{context.calimero-node-1}}'
    grantee_id: '{{identity.calimero-node-2}}'
    granter_id: '{{context.calimero-node-1.memberPublicKey}}'
    capability: member

  # Step 6: Join the context from the second node
  # Uses captured values: context ID, invitee identity, and invitation data
  - name: Join Context from Node 2
    type: join_context
    node: calimero-node-2
    context_id: '{{context.calimero-node-1}}'
    invitee_id: '{{identity.calimero-node-2}}'
    invitation: '{{invite.calimero-node-1_identity.calimero-node-2}}'

  # Step 7: Execute a contract call to set a key-value pair
  # Automatically detects and uses the executor public key from the context
  - name: Execute Contract Call - Set Key-Value
    type: call
    node: calimero-node-1
    context_id: '{{context.calimero-node-1}}'
    method: set
    args:
      key: hello
      value: world

  # Step 8: Wait for the set operation to complete and propagate
  - name: Wait for Set Operation
    type: wait
    seconds: 3

  # Step 9: Execute a view call to retrieve the stored value
  # Demonstrates cross-node execution using the joined context
  - name: Execute View Call - Get Value
    type: call
    node: calimero-node-2
    context_id: '{{context.calimero-node-1}}'
    method: get
    args:
      key: hello

  # Step 10: Repeat a set of operations multiple times
  # Demonstrates the new repeat step functionality
  - name: Repeat Operations Multiple Times
    type: repeat
    count: 3
    steps:
      - name: Set Key-Value Pair
        type: call
        node: calimero-node-1
        context_id: '{{context.calimero-node-1}}'
        method: set
        args:
          key: "iteration_{{iteration}}"
          value: "value_{{iteration}}"
      
      - name: Wait for Set Operation
        type: wait
        seconds: 2
      
      - name: Get Key-Value Pair
        type: call
        node: calimero-node-2
        context_id: '{{context.calimero-node-1}}'
        method: get
        args:
          key: "iteration_{{iteration}}"

# Configuration options
stop_all_nodes: true   # Stop all nodes at the end of workflow
restart: false          # Don't restart nodes at the beginning of workflow
wait_timeout: 60
