import jax.numpy as jnp

from ..._problem import AbstractBoundedMinimisation


class KOEBHELB(AbstractBoundedMinimisation):
    """An exponential fitting problem arising in the study of the
    Koebl-Helbling conjecture on energy/time budgets and travel mode.
    This is the raw data (KHb4).

    This is the least-squares version of KOEBHELBNE.

    Source:
    J. P. Hubert and Ph. L . Toint, Summer 2005.
    SIF input: Ph. Toint, June 2005.

    classification SBR2-RN-3-0
    """

    y0_iD: int = 0
    provided_y0s: frozenset = frozenset({0})

    def _get_data(self):
        """Get the data points and values."""
        # X data points (budget values) - same as KOEBHELBNE
        x_data = jnp.array(
            [
                0.0311817898,
                0.0467726848,
                0.0623635797,
                0.0935453695,
                0.1091362644,
                0.1247271593,
                0.1403180543,
                0.1559089492,
                0.1714998441,
                0.187090739,
                0.2026816339,
                0.2182725288,
                0.2338634238,
                0.2494543187,
                0.2650452136,
                0.2806361085,
                0.2962270034,
                0.3118178983,
                0.3274087933,
                0.3585905831,
                0.374181478,
                0.3897723729,
                0.4053632679,
                0.4209541628,
                0.4365450577,
                0.4521359526,
                0.4677268475,
                0.4833177424,
                0.4989086374,
                0.5144995323,
                0.5300904272,
                0.5456813221,
                0.561272217,
                0.5768631119,
                0.5924540069,
                0.6080449018,
                0.6236357967,
                0.6392266916,
                0.6548175865,
                0.6704084814,
                0.6859993764,
                0.7015902713,
                0.7171811662,
                0.7327720611,
                0.748362956,
                0.763953851,
                0.7795447459,
                0.7951356408,
                0.8107265357,
                0.8263174306,
                0.8419083255,
                0.8574992205,
                0.8730901154,
                0.8886810103,
                0.9042719052,
                0.9198628001,
                0.935453695,
                0.9666354849,
                0.9978172747,
                1.0134081696,
                1.0289990645,
                1.0445899595,
                1.0601808544,
                1.0757717493,
                1.0913626442,
                1.1069535391,
                1.1225444341,
                1.138135329,
                1.1537262239,
                1.1693171188,
                1.1849080137,
                1.2004989086,
                1.2160898036,
                1.2472715934,
                1.2628624883,
                1.2784533832,
                1.2940442781,
                1.325226068,
                1.3408169629,
                1.3564078578,
                1.3719987527,
                1.3875896476,
                1.4031805426,
                1.4187714375,
                1.4343623324,
                1.4811350171,
                1.4967259121,
                1.5279077019,
                1.5434985968,
                1.5590894917,
                1.5746803867,
                1.5902712816,
                1.6214530714,
                1.6370439663,
                1.6526348612,
                1.6682257562,
                1.6838166511,
                1.699407546,
                1.7149984409,
                1.7305893358,
                1.7461802307,
                1.7617711257,
                1.7929529155,
                1.8085438104,
                1.8241347053,
                1.8397256002,
                1.8553164952,
                1.8709073901,
                1.886498285,
                1.9020891799,
                1.9332709698,
                1.9488618647,
                1.9644527596,
                2.0268163393,
                2.0579981291,
                2.0891799189,
                2.1515434986,
                2.1827252884,
                2.1983161833,
                2.260679763,
                2.3230433427,
                2.3386342376,
                2.3698160274,
                2.4165887122,
                2.4321796071,
                2.447770502,
                2.4945431868,
                2.5413158715,
                2.5724976614,
                2.650452136,
                2.7284066105,
                2.7439975055,
                2.7751792953,
                2.8063610851,
                2.8843155597,
                2.9622700343,
                3.0402245089,
                3.0869971936,
                3.1961334581,
                3.2740879326,
                3.5391331462,
                3.585905831,
                3.8977237293,
                4.0068599938,
                4.2095416277,
                4.2874961023,
                4.4434050514,
                5.1449953227,
                5.3788587465,
                5.5347676957,
                5.7062675398,
                5.9245400686,
                6.5325849704,
                6.5481758653,
                6.9067664484,
                10.289990645,
            ]
        )

        # Y data values (budget frequency in sample) - same as KOEBHELBNE
        y_data = jnp.array(
            [
                1.3956745794,
                0.0384714261,
                0.3193189404,
                0.5457529491,
                0.0883981929,
                0.162971961,
                0.5158295749,
                3.0658172906,
                0.0617811148,
                0.4223486827,
                0.3487897418,
                1.2541371542,
                0.8066406155,
                0.297642996,
                0.6365466443,
                0.7314860091,
                0.1788114646,
                5.8490190447,
                0.211425133,
                0.0990105163,
                0.5138185043,
                0.6597743452,
                0.4394819543,
                0.2870924367,
                0.4275199289,
                0.9889318261,
                4.5672071694,
                0.1438254325,
                0.2308134346,
                0.6534769505,
                0.3490464548,
                0.6583892973,
                0.2433901866,
                0.198643958,
                0.1130796292,
                0.0273247242,
                3.309046781,
                0.1149290926,
                0.6052801272,
                0.2745202396,
                0.3180914914,
                0.7664361487,
                0.8697382728,
                0.1393734929,
                0.0849025959,
                0.1816229186,
                1.7967266481,
                0.2437414589,
                0.2933083901,
                0.042250701,
                0.3265409757,
                0.6153127055,
                0.2089602142,
                0.1724364547,
                0.2969836316,
                0.309713792,
                2.7249193336,
                0.3298656736,
                0.1186460567,
                0.9386359319,
                0.1939123488,
                0.0467489182,
                0.3046529561,
                0.1286775419,
                1.4518449932,
                0.3585947583,
                0.0895309004,
                0.061870937,
                0.7399141765,
                2.1553128432,
                0.1747927852,
                0.2304228081,
                0.1697233861,
                1.275355242,
                0.0712896998,
                0.0612039204,
                0.1071958176,
                0.5106876621,
                0.2669877437,
                0.1639490738,
                0.2165907312,
                0.1169831612,
                0.4807615549,
                0.1103499808,
                0.1174473945,
                0.5438601232,
                0.0883981929,
                0.0187544445,
                0.0883981929,
                0.70860539,
                0.0597855309,
                0.2098301963,
                0.0335213649,
                0.4866382609,
                0.0382484192,
                0.0956645016,
                0.0543774309,
                0.0391123888,
                0.3967863326,
                0.4353064048,
                0.0712896998,
                0.2150814262,
                0.1271957484,
                0.0883981929,
                0.0918354874,
                0.4377997461,
                0.032532956,
                1.0291751004,
                0.0670427298,
                0.0533462061,
                0.2390568561,
                0.1410516929,
                0.0970719594,
                0.2000191673,
                0.0729323716,
                0.0883981929,
                0.0360908637,
                0.3245393793,
                0.1608286168,
                0.1734383461,
                0.164108859,
                0.2549304302,
                0.0196000124,
                0.050492665,
                0.0509505215,
                0.0724721466,
                0.2696880586,
                0.0309187066,
                0.2193032532,
                0.1351492974,
                0.4301613948,
                0.0617811148,
                0.1805670975,
                0.1960626165,
                0.0592515167,
                0.0813769367,
                0.1659411961,
                0.0670427298,
                0.1158213024,
                0.0913643306,
                0.0229555012,
                0.0387518245,
                0.0558193237,
                0.4043876983,
                0.0770268442,
                0.050492665,
                0.0360205364,
                0.1309783028,
                0.0314900707,
                0.0314900707,
                0.1477355235,
                0.0758846626,
                0.1453159714,
                0.8371665092,
                0.0355012801,
                0.0391123888,
            ]
        )

        return x_data, y_data

    def objective(self, y, args):
        """Compute the objective function value.

        Sum of squared residuals for the model: N * exp(-A/x - x/B)
        """
        n_val, a, b = y[0], y[1], y[2]

        x_data, y_data = self._get_data()

        # Model: N * exp(-A/x - x/B)
        model = n_val * jnp.exp(-a / x_data - x_data / b)

        # Sum of squared residuals
        residuals = model - y_data
        return jnp.sum(residuals**2)

    @property
    def y0(self):
        """Initial guess for the optimization problem."""
        # Using the "not so reasonable" starting point from SIF
        return jnp.array([10.0, 0.01, 0.01])

    @property
    def bounds(self):
        """Variable bounds.

        From SIF:
        - N: no explicit bounds (defaults to lower bound 0.0 in SIF)
        - A: FR (free, no bounds)
        - B: LO 0.001 (lower bound 0.001)
        """
        lower = jnp.array([0.0, -jnp.inf, 0.001])
        upper = jnp.array([jnp.inf, jnp.inf, jnp.inf])
        return lower, upper

    @property
    def args(self):
        """Additional arguments for the objective function."""
        return None

    @property
    def expected_result(self):
        """Expected result of the optimization problem."""
        # From the original problem, a reasonable solution is around:
        # N = 2.5, A = 0.2, B = 0.7
        return jnp.array([2.5, 0.2, 0.7])

    @property
    def expected_objective_value(self):
        """Expected value of the objective at the solution."""
        # From SIF comment: solution around 77.516347286
        return jnp.array(77.516347286)
