import jax.numpy as jnp

from ..._problem import AbstractNonlinearEquations


class VESUVIOU(AbstractNonlinearEquations):
    """ISIS Data fitting problem VESUVIO given as an inconsistent set of
    nonlinear equations (unweighted version).

    Fit: y = b1 + b2 * x + b3 * exp[ -0.5*( ( b4 - x ) / b5 )**2 ]
                         + b6 * exp[ -0.5*( ( b7 - x ) / b8 )**2 ] + e

    Source: fit to a sum of a linear background and two Gaussians using data
    EVS14188-90 from Mantid (http://www.mantidproject.org)

    SIF input: Nick Gould and Tyrone Rees, Oct 2015

    classification NOR2-MN-8-1025
    """

    y0_iD: int = 0
    provided_y0s: frozenset = frozenset({0})

    n: int = 8  # Number of variables
    m: int = 1025  # Number of data points

    def residual(self, y):
        """Compute the residuals for the system."""
        b1, b2, b3, b4, b5, b6, b7, b8 = y

        # X data points (1025 values from 5e-05 to 0.000562)
        x_data = jnp.linspace(5e-05, 0.000562, 1025)

        # Y data points (1025 observed values - same as VESUVIO)
        y_data = jnp.array(
            [
                -0.043818,
                -0.0374639,
                0.000431594,
                -0.0104384,
                -0.0181576,
                -0.0108962,
                0.0491521,
                -0.00611904,
                0.0364192,
                -0.0244793,
                0.0268059,
                -0.0285219,
                -0.016472,
                -0.042737,
                0.00969073,
                0.00661254,
                -0.0326679,
                -0.0277833,
                0.0230731,
                -0.0021438,
                0.0335214,
                -0.0111762,
                -0.00842102,
                -0.0131027,
                0.0045568,
                0.0133449,
                -0.045149,
                0.0408543,
                0.0185121,
                0.0441349,
                0.00696307,
                -0.0742796,
                -0.0504155,
                0.00943794,
                -0.0164604,
                -0.00097137,
                0.0308067,
                0.0158623,
                -0.00204966,
                -0.00333032,
                -0.0291396,
                -0.0260522,
                0.00509382,
                -0.0144775,
                0.0202525,
                0.00950817,
                0.0261544,
                -0.0131126,
                0.0407359,
                -0.00826466,
                0.0240619,
                -0.00182438,
                0.00987082,
                -0.0330236,
                0.0384621,
                0.0226427,
                -0.00596073,
                -0.0590399,
                0.0204211,
                -0.0451219,
                0.00585252,
                0.0120189,
                -0.0448687,
                0.00345542,
                0.0210157,
                0.00819559,
                -0.0345383,
                -0.0122425,
                0.00324275,
                -0.0339446,
                0.0481686,
                -0.0147045,
                0.0193092,
                -0.0264435,
                0.0120728,
                0.00437327,
                0.0046033,
                0.0372026,
                0.0216476,
                0.0536252,
                0.0699235,
                -0.00494973,
                0.00551705,
                0.0208186,
                0.0223953,
                -0.0056318,
                0.00788353,
                0.0298081,
                0.015891,
                0.00988867,
                -0.0290219,
                0.0197523,
                0.0151485,
                0.0180058,
                0.0157787,
                -0.00535445,
                0.0204222,
                -0.0208278,
                0.0302433,
                0.0311677,
                -0.00266134,
                0.0321104,
                0.0415269,
                0.0226116,
                0.0128861,
                0.0120574,
                0.00939962,
                -0.0154602,
                -0.0192974,
                -0.0300028,
                -0.017951,
                0.00956859,
                0.0525651,
                0.00508547,
                0.0112612,
                0.0379798,
                0.0425881,
                0.00635024,
                0.0232108,
                0.0211423,
                0.0465961,
                -0.00186809,
                -0.00141523,
                -0.01053,
                0.0670444,
                0.00236076,
                0.028184,
                0.0327376,
                0.0475456,
                0.0538893,
                0.0232553,
                0.00526164,
                0.0532656,
                -0.0145954,
                0.0510802,
                0.026314,
                0.0331227,
                0.0166741,
                0.0152719,
                0.0284559,
                0.0916947,
                0.0194785,
                0.0497031,
                0.0785525,
                0.0457128,
                0.0580151,
                0.0463735,
                0.0354371,
                0.044241,
                0.0162445,
                0.0586063,
                0.0251801,
                0.0790944,
                0.0618635,
                0.0671038,
                0.0327571,
                0.0794554,
                0.0856043,
                0.0525939,
                0.0544387,
                0.0650262,
                0.068626,
                0.0738347,
                0.0895067,
                0.0658615,
                0.0914702,
                0.0609357,
                0.081834,
                0.063857,
                0.125279,
                0.0683318,
                0.0857297,
                0.0804291,
                0.0731582,
                0.045416,
                0.039823,
                0.127126,
                0.0751748,
                0.061808,
                0.0842774,
                0.0885304,
                0.100646,
                0.0900689,
                0.112349,
                0.0626914,
                0.115407,
                0.0844166,
                0.0960295,
                0.0802212,
                0.0731888,
                0.116035,
                0.0807037,
                0.092657,
                0.143151,
                0.0674344,
                0.114121,
                0.136928,
                0.105858,
                0.151119,
                0.109554,
                0.139918,
                0.126496,
                0.119158,
                0.131296,
                0.134124,
                0.0971755,
                0.161449,
                0.138164,
                0.131791,
                0.127854,
                0.098511,
                0.138888,
                0.113476,
                0.110613,
                0.0879691,
                0.140605,
                0.104704,
                0.0958282,
                0.118659,
                0.106919,
                0.117291,
                0.136775,
                0.14102,
                0.156534,
                0.145159,
                0.133253,
                0.125528,
                0.162623,
                0.151437,
                0.160015,
                0.12091,
                0.101873,
                0.149158,
                0.133798,
                0.176973,
                0.126043,
                0.138557,
                0.1672,
                0.0994593,
                0.116623,
                0.167826,
                0.114384,
                0.120186,
                0.154502,
                0.128844,
                0.0919119,
                0.1624,
                0.138149,
                0.136329,
                0.100788,
                0.132021,
                0.146725,
                0.110689,
                0.142163,
                0.124735,
                0.101792,
                0.0886751,
                0.114114,
                0.110118,
                0.136007,
                0.0795715,
                0.112341,
                0.111941,
                0.114744,
                0.104852,
                0.0907259,
                0.118165,
                0.104074,
                0.0977936,
                0.072903,
                0.109739,
                0.120898,
                0.102786,
                0.0922942,
                0.140367,
                0.090055,
                0.0973907,
                0.107985,
                0.0851051,
                0.0884115,
                0.108974,
                0.096536,
                0.0913291,
                0.0824352,
                0.111778,
                0.0745343,
                0.121377,
                0.0921086,
                0.0713587,
                0.0946596,
                0.116034,
                0.0736795,
                0.0760301,
                0.0584058,
                0.0578472,
                0.0507647,
                0.0898665,
                0.117975,
                0.0492809,
                0.0910802,
                0.0721345,
                0.0833121,
                0.0633919,
                0.0726774,
                0.0793411,
                0.0298914,
                0.0181227,
                0.0563252,
                0.0573376,
                0.0488994,
                0.0494608,
                0.0717029,
                0.0773525,
                0.0744368,
                0.0522949,
                0.0385736,
                0.0880253,
                0.0387927,
                0.0266954,
                0.0767808,
                0.0189931,
                0.0617196,
                0.0230641,
                0.0225687,
                0.0824231,
                0.062153,
                0.0834503,
                0.055,
                0.0135058,
                0.0627533,
                0.0411534,
                0.0184196,
                0.0451215,
                0.0384641,
                0.053943,
                0.0165014,
                0.0408713,
                0.058608,
                0.0544348,
                0.018852,
                0.0117,
                0.0157153,
                0.019341,
                0.0250259,
                0.00591113,
                -0.00609515,
                0.00815597,
                0.029844,
                0.0164819,
                0.0385856,
                -0.00246766,
                0.0372864,
                -0.00269409,
                -0.00636251,
                0.020693,
                0.0222975,
                0.00986804,
                0.0364596,
                0.0393466,
                0.0436376,
                0.0173226,
                -0.0202508,
                0.0743308,
                0.0172391,
                0.0207598,
                -0.020454,
                0.00488474,
                0.0406745,
                0.0321333,
                0.0123634,
                0.0552421,
                0.016853,
                -0.0160711,
                0.00650595,
                -0.0175865,
                0.0549646,
                0.0341869,
                0.0108916,
                0.00202561,
                -0.0449102,
                0.0349201,
                0.0167157,
                0.00236894,
                0.0291692,
                0.00979011,
                0.0349145,
                0.0405205,
                0.0109501,
                0.00682423,
                0.000195658,
                -0.00872146,
                0.0242649,
                0.0249386,
                -0.0036175,
                -0.00245472,
                0.0101613,
                -0.0262679,
                0.0106865,
                0.0143873,
                -0.00429679,
                -0.00165476,
                0.0269997,
                0.0146583,
                0.0296008,
                -0.0180255,
                -0.0115518,
                0.000797839,
                0.0234705,
                0.0128162,
                -0.0121448,
                -0.00698516,
                0.00475114,
                0.00541832,
                0.0132552,
                0.0258294,
                -0.0496059,
                0.010707,
                -0.0302248,
                -0.00922442,
                0.0281132,
                -8.5067e-06,
                0.0121518,
                0.00137972,
                0.00678428,
                -0.00504567,
                0.00627951,
                -0.00716149,
                -0.0234996,
                -0.00298732,
                0.000371008,
                0.027447,
                0.00935411,
                0.0315321,
                -0.0120852,
                0.00807623,
                0.0526476,
                0.0081671,
                -0.0445566,
                -0.0252898,
                0.00835358,
                -0.00373996,
                -0.0116808,
                0.0060169,
                0.0270461,
                0.0155121,
                0.00721307,
                -0.0183799,
                -0.0453742,
                -0.00293263,
                0.0232422,
                -0.00948229,
                -0.00631143,
                0.0179425,
                0.0209761,
                -0.0713078,
                0.00166836,
                -0.0107119,
                0.0427997,
                -0.030493,
                0.0173125,
                -0.0213661,
                0.00553178,
                -0.016031,
                0.0191882,
                -0.00343691,
                0.0192536,
                0.00781084,
                -0.0167119,
                0.0334007,
                0.0457505,
                -0.00721731,
                0.0336781,
                0.0220064,
                -0.00538441,
                -0.00290971,
                -0.0293038,
                0.0149695,
                0.00650988,
                0.00819231,
                -0.0147292,
                0.0201632,
                -0.00661203,
                0.0360328,
                0.023942,
                -0.00687104,
                0.0153841,
                -0.00617226,
                -0.00677542,
                0.0147168,
                0.00996546,
                -0.00320737,
                0.0118976,
                0.0276725,
                -0.0175624,
                -0.0145427,
                -0.0011166,
                -0.0159023,
                0.0222753,
                -0.00288254,
                -0.00883099,
                -0.0108512,
                0.0294486,
                -0.0106035,
                0.0496593,
                0.00712957,
                -0.0111927,
                -0.011189,
                -0.0162317,
                0.0373467,
                0.00274109,
                0.0286728,
                0.0216368,
                -0.0113653,
                0.0053543,
                -0.00467352,
                0.0378432,
                -0.018803,
                0.0136006,
                0.0297811,
                0.0228667,
                0.0142086,
                0.00103852,
                0.00585841,
                0.000415705,
                -0.0138921,
                0.017743,
                -0.00486836,
                0.0272743,
                -0.0244101,
                0.0111004,
                0.0209111,
                0.00949311,
                -0.0074557,
                0.0233776,
                0.0149032,
                -0.00412979,
                -0.0037326,
                0.00236796,
                0.00814009,
                0.0279842,
                -0.00277497,
                -0.0235433,
                -0.022607,
                0.0244551,
                -0.00531205,
                -0.00750302,
                0.00406808,
                0.01586,
                -0.00428942,
                -0.0127935,
                -0.0149055,
                -0.0293664,
                0.0180168,
                0.00807722,
                0.0316073,
                -0.0178555,
                -0.00437734,
                -0.0193014,
                0.0462101,
                -0.0143664,
                -0.0487604,
                0.042654,
                0.0483388,
                0.0197354,
                0.00514375,
                0.0658946,
                0.0163994,
                -0.00790463,
                -0.0233706,
                0.0247587,
                0.0320276,
                -0.000607085,
                -0.0222794,
                0.0244681,
                0.012524,
                0.0260698,
                0.0108322,
                -0.00632354,
                -0.0189405,
                -0.0118498,
                0.00687154,
                -0.0249075,
                0.0135178,
                0.0163936,
                -0.00530828,
                -0.0207742,
                -0.0053204,
                0.00720096,
                0.0117713,
                0.0178552,
                -0.036769,
                -0.0126599,
                -0.005918,
                0.0263491,
                0.0151557,
                0.00584057,
                0.0264419,
                0.0180603,
                0.0175713,
                0.0187721,
                -0.00559971,
                -0.0270261,
                -0.0259273,
                -0.00640704,
                0.0373987,
                -0.0238755,
                0.00731606,
                -0.000808467,
                -0.00475702,
                0.00261306,
                0.0164558,
                -0.0243441,
                0.0221129,
                0.0300992,
                -0.0122144,
                -0.0204902,
                0.0055195,
                0.00355038,
                0.0472522,
                0.0154036,
                0.0319775,
                0.0427468,
                0.0157395,
                -0.00322947,
                -0.00243507,
                0.0331217,
                0.0201169,
                0.0251419,
                0.00642998,
                0.0456459,
                0.0706617,
                0.0601188,
                0.0419572,
                0.0648266,
                0.0652339,
                0.0456719,
                0.0753397,
                0.0835274,
                0.105146,
                0.0372931,
                0.0942968,
                0.0975799,
                0.080092,
                0.0793876,
                0.104039,
                0.106851,
                0.137539,
                0.141646,
                0.101833,
                0.125147,
                0.137782,
                0.111339,
                0.0979306,
                0.111258,
                0.115163,
                0.07558,
                0.0684921,
                0.106816,
                0.0440877,
                0.0181681,
                0.0742093,
                0.0500213,
                0.0310634,
                0.0182645,
                0.0362954,
                0.0224729,
                0.0487861,
                0.0412359,
                0.0424126,
                0.00882773,
                -0.00910196,
                0.0133665,
                0.0296499,
                -0.0289228,
                -0.00599789,
                0.00722044,
                -0.0036843,
                -0.00879759,
                -0.0136455,
                -0.0166205,
                -0.0144574,
                -0.00582893,
                -0.0352583,
                0.0132347,
                -0.0409682,
                0.0203784,
                -0.0028195,
                -0.00735174,
                -0.00887274,
                0.00794329,
                -0.00233979,
                0.00068274,
                0.0044977,
                -0.0325032,
                -0.0139795,
                0.011465,
                -0.0578308,
                -0.0445345,
                -0.0189526,
                -0.0309265,
                0.00615967,
                0.0146202,
                0.0150062,
                0.00533007,
                -0.0109738,
                -0.0193777,
                0.0152883,
                0.0223457,
                0.017496,
                -0.0118285,
                0.0491794,
                -0.0152295,
                0.0133655,
                -0.00428582,
                0.0275972,
                0.0155036,
                -0.00698254,
                0.0136226,
                -0.0322545,
                -0.0271394,
                0.0213109,
                0.00397427,
                0.010511,
                -0.020946,
                -0.00452699,
                -0.0281119,
                -0.01101,
                0.0315402,
                -0.015971,
                -0.00198156,
                0.000250178,
                -0.0307502,
                0.0204358,
                0.0255398,
                -0.0241773,
                -0.00949277,
                0.0158581,
                -0.00209666,
                -0.0115269,
                -0.00131896,
                -0.0123909,
                -0.0124131,
                0.0230685,
                0.0106678,
                0.001735,
                0.0380713,
                -0.0140584,
                0.0017851,
                -0.00650184,
                0.00233915,
                -0.0351804,
                -0.00805248,
                -0.0180034,
                0.00602787,
                -0.0252027,
                0.00918121,
                -0.00465142,
                -0.00559791,
                0.0261718,
                0.00214055,
                0.00826992,
                0.0323178,
                0.0236681,
                0.0254998,
                -0.0289787,
                -0.00365564,
                -0.00348488,
                -0.00805903,
                -0.0209488,
                0.0282681,
                3.58623e-05,
                -0.0199047,
                -0.0369519,
                0.0152539,
                0.0192063,
                -0.0175968,
                -0.0340288,
                -0.0121895,
                0.0240866,
                0.00947444,
                -0.0284117,
                -0.0115223,
                -0.0212225,
                0.0153867,
                0.00922951,
                -0.00196862,
                0.00386195,
                0.0190727,
                -0.0154291,
                0.0498791,
                0.00821147,
                -0.0197582,
                0.0157356,
                -0.00949277,
                -0.00804691,
                -0.0245707,
                -0.0247081,
                -0.0129457,
                0.00451341,
                0.0178152,
                -0.00243442,
                -0.00514603,
                -0.0099345,
                -0.00168554,
                0.00085154,
                -0.0232521,
                -0.00409459,
                0.0432152,
                -0.0136668,
                0.00241151,
                -0.00881249,
                -0.0312615,
                -0.0196319,
                -0.00577064,
                -0.0321477,
                0.0384444,
                -0.0321376,
                -0.0142041,
                -0.0134469,
                0.00168212,
                0.0102456,
                -0.00575198,
                -0.00737695,
                -0.020056,
                0.0392017,
                -0.03369,
                0.00635647,
                -0.00633664,
                0.0180417,
                -0.00403516,
                -0.0358337,
                0.0269401,
                -0.0096226,
                -0.00206882,
                -2.25875e-05,
                -0.0217644,
                0.00155228,
                -0.0154532,
                0.0233061,
                -0.0162327,
                0.00546466,
                -0.0228549,
                -0.00570745,
                -0.0266308,
                -0.00402223,
                -0.016306,
                -0.0169481,
                -0.0201516,
                0.0129683,
                0.0124542,
                -0.024154,
                0.00102885,
                -0.0304875,
                -0.0223008,
                0.0183673,
                -0.0172451,
                -0.00224974,
                -0.0142421,
                0.0379619,
                0.025177,
                -0.0178549,
                -0.0158086,
                -0.0177537,
                0.0107078,
                0.0222288,
                -0.0604662,
                -0.012401,
                0.0254368,
                0.0119141,
                -0.0438302,
                -0.0326998,
                -0.00384491,
                0.000470225,
                0.0185474,
                0.0162998,
                -0.0159506,
                0.0295005,
                -6.1554e-05,
                0.0160622,
                0.000288326,
                -0.000648999,
                -0.0267923,
                0.00723158,
                0.00941976,
                -0.0164452,
                -0.0122785,
                -0.0182622,
                0.000552742,
                0.0437182,
                -0.00503372,
                0.0190309,
                -0.0181843,
                -0.0240844,
                0.0490329,
                0.0138741,
                -0.00334751,
                0.0138657,
                0.0210437,
                0.0176121,
                0.0373755,
                0.0207821,
                -0.0321746,
                -0.0183207,
                0.0184417,
                -0.0277861,
                -0.0172915,
                0.0221156,
                -0.0284727,
                -0.00542797,
                0.0153098,
                -0.0210349,
                -0.00358868,
                -0.00621761,
                -0.0318144,
                0.00610236,
                0.0303712,
                -0.0081422,
                0.0332183,
                -0.0111367,
                0.0256367,
                0.0327637,
                0.0114784,
                -0.0151734,
                0.0339256,
                -0.03822,
                0.0237457,
                0.0214239,
                0.0167199,
                -0.0569272,
                -0.030408,
                0.0260472,
                0.014218,
                0.0636447,
                -0.0124654,
                -0.0128375,
                0.000845648,
                -0.0111793,
                -0.0391962,
                0.0190694,
                -0.00809652,
                0.00798635,
                0.0137909,
                0.0201022,
                -0.0214635,
                -0.00852646,
                0.0153451,
                0.0016777,
                -0.00383181,
                -0.0228454,
                0.00309375,
                0.0253748,
                -0.00784078,
                -0.00844395,
                0.00863846,
                0.0347038,
                -0.00104701,
                0.00571712,
                0.0209463,
                -0.00305707,
                0.0012859,
                0.022858,
                0.009184,
                -0.0141735,
                -0.0054838,
                -0.035572,
                -0.0252546,
                -0.0101812,
                0.0132625,
                0.0158869,
                -0.0165408,
                -0.000378034,
                0.00669881,
                -0.00658714,
                0.00185845,
                0.0255008,
                0.0254312,
                -0.0136121,
                -0.0297164,
                -0.021049,
                0.0101649,
                3.12782e-05,
                0.0160056,
                -0.000428134,
                0.00772701,
                -0.014219,
                0.0168167,
                0.0126584,
                -0.0184312,
                -0.00279822,
                0.00939455,
                -0.0246969,
                -0.0098528,
                -0.0269946,
                -0.0459563,
                -0.0105255,
                -0.0145345,
                -0.01605,
                0.0366831,
                -0.0228725,
                0.0159332,
                -0.0208152,
                0.00881005,
                0.0234657,
                0.0139409,
                -0.00487048,
                0.01975,
                0.0114501,
                0.00979551,
                -0.0261557,
                -0.0387643,
                0.0064362,
                0.0168157,
                0.0626361,
                0.00476391,
                0.0285697,
                -0.0208412,
                0.0245134,
                0.000865457,
                -0.0316652,
                0.0184202,
                0.0152929,
                -0.017068,
                -0.00895919,
                0.0344911,
                0.0292035,
            ]
        )

        # Model: y = b1 + b2*x + b3*exp[-0.5*((b4-x)/b5)^2] + b6*exp[-0.5*((b7-x)/b8)^2]
        # Using standard Gaussian (division in exponent) - same as VESUVIO
        model = (
            b1
            + b2 * x_data
            + b3 * jnp.exp(-0.5 * ((b4 - x_data) / b5) ** 2)
            + b6 * jnp.exp(-0.5 * ((b7 - x_data) / b8) ** 2)
        )

        # Residuals: (model - observed) - NO E-value scaling (unweighted)
        return model - y_data

    def constraint(self, y):
        """Return the equality constraints (residuals) for the nonlinear system."""
        residuals = self.residual(y)
        # Return (equality_constraints, inequality_constraints)
        # For nonlinear equations, we have only equality constraints
        return residuals, None

    @property
    def y0(self):
        """Starting point."""
        return jnp.array([0.0, 0.0, 0.01, 0.00037, 1.0e-5, 0.0979798, 0.000167, 1.0e-5])

    @property
    def args(self):
        """Additional arguments (none for this problem)."""
        return None

    @property
    def bounds(self):
        """No bounds for this problem."""
        return None

    @property
    def expected_result(self):
        """Expected solution (not available for this problem)."""
        return None

    @property
    def expected_objective_value(self):
        """Expected objective value (not available for this problem)."""
        return None
