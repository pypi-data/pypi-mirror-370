[tox]
env_list =
# Everything should work for python 39 310 311 but the pytester plugin
# used to test this plugin loses this plugin after the first test run.
    py{312,313}{,-coverage}{,-pytestdev}{,-oldasdf}
    downstream-{standard,transform,wcs,coordinates,astropy,rad,stdatamodels,sunpy,dkist,weldx}

[testenv]
deps =
    coverage: coverage
    pytestdev: git+https://github.com/pytest-dev/pytest
# Install a version of asdf that doesn't have any checks for this new pytest plugin
# This should result in the test suite in this package running using the plugin
# that is bundled with asdf. At the moment the goal is to make everything pass
# for both plugins (to show this external package plugin is the same). At some point
# we will add new features and tests here that will require either removing this
# test or skipping some tests for old asdf versions.
    oldasdf: asdf==4.3.0
extras = all,tests
package = editable
commands_pre =
    pip freeze
# coverage run must be used because the pytest-asdf plugin will interfere
# with proper coverage measurement due to the order pytest loads its
# entry points.
commands =
    coverage: coverage run --source=pytest-asdf-plugin --rcfile={tox_root}/pyproject.toml -m \
    pytest \
    --durations=10 \
# the OpenAstronomy workflow appends `--cov-report` in `{posargs}`, which `coverage` doesn't recognize
    !coverage: {posargs}
    coverage:
    coverage: coverage xml -o {tox_root}/coverage.xml
    coverage: coverage report


[testenv:downstream-{standard,transform,wcs,coordinates,astropy,rad,stdatamodels,sunpy,dkist,weldx}]
change_dir = {env_tmp_dir}
allowlist_externals =
    git
    bash
commands_pre =
    rad: git clone https://github.com/spacetelescope/rad.git .
    dkist: git clone https://github.com/DKISTDC/dkist.git .

    bash -c "pip freeze -q | grep 'pytest-asdf-plugin @' > {env_tmp_dir}/_asdf_requirements.txt"

    standard: git clone https://github.com/asdf-format/asdf-standard.git
    standard: pip install ./asdf-standard[test]
    transform: git clone https://github.com/asdf-format/asdf-transform-schemas.git
    transform: pip install ./asdf-transform-schemas[test]
    wcs: git clone https://github.com/asdf-format/asdf-wcs-schemas.git
    wcs: pip install ./asdf-wcs-schemas[test]
    coordinates: git clone https://github.com/asdf-format/asdf-coordinates-schemas.git
    coordinates: pip install ./asdf-coordinates-schemas[test]
    astropy: git clone https://github.com/astropy/asdf-astropy.git
    astropy: pip install ./asdf-astropy[test]
    rad: pip install -e .[test]
    stdatamodels: git clone https://github.com/spacetelescope/stdatamodels.git
    stdatamodels: pip install ./stdatamodels[test]
    sunpy: git clone https://github.com/sunpy/sunpy.git
    sunpy: pip install -e ./sunpy[tests,all]
    dkist: pip install .[tests]
    weldx: git clone https://github.com/BAMWelDX/weldx.git
    weldx: pip install weldx[test,media]

    pip install -r {env_tmp_dir}/_asdf_requirements.txt
    pip freeze
commands =
    pytest \
    standard: asdf-standard
    transform: asdf-transform-schemas
    wcs: asdf-wcs-schemas
    coordinates: asdf-coordinates-schemas
    astropy: asdf-astropy
    rad: .
    stdatamodels: stdatamodels --no-crds
    sunpy: sunpy/sunpy/io
    dkist: --benchmark-skip
    weldx: weldx/weldx/tests/asdf_tests weldx/weldx/schemas --asdf-tests
