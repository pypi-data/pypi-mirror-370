import{r as n,v as Y,_ as Z,e as m,p as ss,f as es,ap as as,aq as ns,a as b,j as s,I as is,g as ts,B as t,o as j,m as ls,P as g}from"./index-k5nYwGaK.js";import{P as rs,s as os,r as cs}from"./index-D20mueBH.js";import{A as ds}from"./index-D9MAPMHg.js";import{C as us}from"./index-uY4zMwKa.js";import{F as ms,S as ps}from"./Table-B22HuOla.js";import{T as ys}from"./index-BR1XWe93.js";var fs={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M888 792H200V168c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v688c0 4.4 3.6 8 8 8h752c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM305.8 637.7c3.1 3.1 8.1 3.1 11.3 0l138.3-137.6L583 628.5c3.1 3.1 8.2 3.1 11.3 0l275.4-275.3c3.1-3.1 3.1-8.2 0-11.3l-39.6-39.6a8.03 8.03 0 00-11.3 0l-230 229.9L461.4 404a8.03 8.03 0 00-11.3 0L266.3 586.7a8.03 8.03 0 000 11.3l39.5 39.7z"}}]},name:"line-chart",theme:"outlined"},xs=function(v,w){return n.createElement(Y,Z({},v,{ref:w,icon:fs}))},hs=n.forwardRef(xs);const Fs=n.forwardRef(({title:E,form:v,appendSampleColumns:w=[],setResultTableList:C,cleanDom:_s,analysisType:js,setRecord:k,setTableLoading:gs,setTabletData:vs,shouldTrigger:ws,columnsParamsALL:Cs,project:M,software:ks,component_id:B,component_ids:T,operatePipeline:F,editParams:A},O)=>{n.useImperativeHandle(O,()=>({reload:l}));const[p,D]=n.useState(),[As,P]=m.useMessage(),{modal:i,openModal:y,closeModal:c}=ss(),[Ss,Is]=n.useState(!1),$=es(),H=as(),{eventSourceRef:d,status:zs,reconnect:Ls}=ns(),[r,N]=n.useState([]),f=n.useRef([]),x=n.useRef(null),h=n.useRef(null),[V,S]=n.useState(!1),[q,J]=n.useState();n.useEffect(()=>{if(r&&Array.isArray(r)&&r.length>0&&i.visible&&i.params){const a=r.find(e=>e.analysis_id==i.params.analysis_id);a&&J(a)}},[r,i.params]),n.useEffect(()=>{var a;if(d){const e=o=>{var L,R;const _=JSON.parse(o.data);console.log("analysisId",f.current),f.current.includes(_.analysis_id)&&(_.event=="analysis_complete"||_.event=="analysis_failed")&&(l(),x.current&&((L=x.current)==null||L.relaod()),h.current&&((R=h.current)==null||R.relaod()))};return(a=d.current)==null||a.addEventListener("message",e),()=>{var o;console.log("removeEventListener"),(o=d.current)==null||o.removeEventListener("message",e)}}},[d.current]);const K=a=>{k&&k(a),D(a)},l=async()=>{S(!0);let a=await b.post("/list-analysis",{component_id:B,component_ids:T,project:M});C&&C(a.data),N(a.data);const e=a.data.map(o=>o.analysis_id);f.current=e,S(!1)},G=async a=>{await b.delete(`/fast-api/analysis/${a}`),m.success("删除成功!"),l()},I=(a,e)=>i.params?a.analysis_id==i.params.analysis_id&&e==i.key:!1,Q=async a=>{await cs(a.analysis_id),m.success("运行成功"),l()},U=async a=>{await os(a.analysis_id),m.success("停止成功"),l()};let W=[{title:"project_name",dataIndex:"project_name",key:"project_name",ellipsis:!0,render:(a,e)=>s.jsx(j,{title:e.project,children:s.jsx("span",{style:{cursor:"pointer"},children:a})})},{title:"analysis_status",dataIndex:"analysis_status",key:"analysis_status",ellipsis:!0,render:a=>s.jsx(ys,{color:a==="success"?"green":a==="failed"?"red":"blue",children:a})},{title:"分析名称",dataIndex:"analysis_name",key:"analysis_name",ellipsis:!0},{title:"analysis_id",dataIndex:"analysis_id",key:"analysis_id",ellipsis:!0,render:(a,e)=>s.jsx(ls,{title:s.jsx(s.Fragment,{children:s.jsxs("ul",{children:[s.jsxs("li",{children:["analysis_name:",e.analysis_name]}),s.jsxs("li",{children:["pipeline_script:",e.pipeline_script]}),s.jsxs("li",{children:["work_dir:",e.work_dir]}),s.jsxs("li",{children:["output_dir:",e.output_dir]}),s.jsxs("li",{children:["command_log_path:",e.command_log_path]}),s.jsxs("li",{children:["trace_file:",e.trace_file]}),s.jsxs("li",{children:["executor_log_file:",e.executor_log_file]}),s.jsxs("li",{children:["workflow_log_file:",e.workflow_log_file]})]})}),children:s.jsx("span",{style:{cursor:"pointer"},children:a})})},{title:"组件名称",dataIndex:"component_name",key:"component_name",ellipsis:!0,render:(a,e)=>s.jsx(j,{title:e.component_id,children:s.jsx("span",{style:{cursor:"pointer"},children:a})})},{title:"容器",dataIndex:"container_name",key:"container_name",ellipsis:!0,render:(a,e)=>s.jsx(j,{title:s.jsx(s.Fragment,{children:s.jsxs("ul",{children:[s.jsx("li",{children:e.container_id}),s.jsx("li",{children:e.container_image})]})}),children:s.jsx("span",{style:{cursor:"pointer"},children:a})})},{title:"操作",key:"action",fixed:"right",ellipsis:!0,width:200,render:(a,e)=>s.jsxs(ps,{size:"middle",children:[s.jsx(t,{size:"small",color:"cyan",variant:"solid",onClick:()=>{$(`/software-analysis-editor/${e.analysis_id}`,{state:{location:H.pathname}})},children:"编辑"}),s.jsx(g,{title:"是否停止!",onConfirm:()=>{U(e)},children:s.jsx(t,{disabled:e.analysis_status!="running",size:"small",color:"cyan",variant:"solid",children:"停止"})}),s.jsx(g,{title:"是否运行!",onConfirm:()=>{Q(e),y("modalA",e),K(e)},children:s.jsx(t,{disabled:e.analysis_status=="running",size:"small",color:"cyan",variant:"solid",children:e.analysis_status=="created"?"运行":"重新运行"})}),A&&s.jsx(t,{size:"small",color:"cyan",variant:"solid",onClick:()=>A(e),children:"编辑参数"}),I(e,"modalA")?s.jsx(t,{size:"small",color:"cyan",variant:"solid",onClick:()=>{c()},children:"关闭"}):s.jsx(t,{size:"small",color:"cyan",variant:"solid",onClick:()=>{y("modalA",e)},children:"查看结果"}),I(e,"modalB")?s.jsx(t,{size:"small",color:"cyan",variant:"solid",onClick:()=>{c()},children:"关闭"}):s.jsx(t,{size:"small",color:"cyan",variant:"solid",onClick:()=>{y("modalB",e)},children:"详情"}),s.jsx(g,{title:"是否删除!",onConfirm:async()=>{await G(e.id),l()},children:s.jsx(t,{size:"small",color:"danger",variant:"solid",children:"删除"})})]})}];n.useEffect(()=>{l()},[]);const[u,X]=n.useState(""),z=n.useMemo(()=>u?r.filter(a=>Object.values(a).some(e=>String(e).toLowerCase().includes(u.toLowerCase()))):r,[r,u]);return s.jsxs(s.Fragment,{children:[P,s.jsx(us,{size:"small",title:s.jsxs(s.Fragment,{children:[s.jsx(hs,{})," 分析记录"]}),extra:s.jsx(ts,{gap:"small",children:s.jsx(t,{size:"small",type:"primary",onClick:l,children:"刷新"})}),children:s.jsx(ms,{title:()=>s.jsx(is.Search,{size:"small",placeholder:"搜索结果...",allowClear:!0,enterButton:!0,value:u,onChange:a=>X(a.target.value),style:{width:300}}),rowKey:"analysis_id",size:"small",bordered:!0,pagination:!1,loading:V,scroll:{x:"max-content",y:55*5},columns:W,footer:()=>`一共${z.length}条记录`,dataSource:z})}),s.jsx("div",{style:{marginBottom:"1rem"}}),s.jsx(ds,{ref:x,visible:i.key=="modalA"&&i.visible,params:i.params,currentAnalysis:q,status:p==null?void 0:p.analysis_status,operatePipeline:F,onClose:c}),s.jsx(rs,{ref:h,visible:i.key=="modalB"&&i.visible,params:i.params,onClose:c,callback:l})]})});export{Fs as R};
