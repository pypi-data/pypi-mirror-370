import{r as reactExports,v as Icon,_ as _extends,j as jsxRuntimeExports,g as Flex,B as Button,a as axios,d as useOutletContext,b as Row,C as Col,P as Popconfirm,w as RefIcon$1,F as Form,e as staticMethods,M as Modal,i as Collapse,I as Input,c as Typography,R as React,o as Tooltip}from"./index-k5nYwGaK.js";import{R as ResultList}from"./index-Cq6_VI_o.js";import{F as FormJsonComp,A as AnalysisForm}from"./index-DEdTZVoa.js";import{R as ResultList$1}from"./index-DbTe9uIt.js";import{A as AnalysisResultView}from"./index-D9MAPMHg.js";import{C as Card}from"./index-uY4zMwKa.js";import{S as Spin}from"./index-7-CCDVgE.js";var CloseCircleOutlined$1={icon:{tag:"svg",attrs:{"fill-rule":"evenodd",viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64c247.4 0 448 200.6 448 448S759.4 960 512 960 64 759.4 64 512 264.6 64 512 64zm0 76c-205.4 0-372 166.6-372 372s166.6 372 372 372 372-166.6 372-372-166.6-372-372-372zm128.01 198.83c.03 0 .05.01.09.06l45.02 45.01a.2.2 0 01.05.09.12.12 0 010 .07c0 .02-.01.04-.05.08L557.25 512l127.87 127.86a.27.27 0 01.05.06v.02a.12.12 0 010 .07c0 .03-.01.05-.05.09l-45.02 45.02a.2.2 0 01-.09.05.12.12 0 01-.07 0c-.02 0-.04-.01-.08-.05L512 557.25 384.14 685.12c-.04.04-.06.05-.08.05a.12.12 0 01-.07 0c-.03 0-.05-.01-.09-.05l-45.02-45.02a.2.2 0 01-.05-.09.12.12 0 010-.07c0-.02.01-.04.06-.08L466.75 512 338.88 384.14a.27.27 0 01-.05-.06l-.01-.02a.12.12 0 010-.07c0-.03.01-.05.05-.09l45.02-45.02a.2.2 0 01.09-.05.12.12 0 01.07 0c.02 0 .04.01.08.06L512 466.75l127.86-127.86c.04-.05.06-.06.08-.06a.12.12 0 01.07 0z"}}]},name:"close-circle",theme:"outlined"},CloseCircleOutlined=function(a,t){return reactExports.createElement(Icon,_extends({},a,{ref:t,icon:CloseCircleOutlined$1}))},RefIcon=reactExports.forwardRef(CloseCircleOutlined);const BioDatabaseForm=({formJson:e,operatePipeline:a,software:t})=>{if(!e)return null;const[r,c]=reactExports.useState([]),h=async()=>{const d=e.map(p=>p.dataKey),x=((await axios.post("/list-bio-database",{type_list:d})).data||[]).reduce((p,n)=>{const l=n.type;p[l]||(p[l]=[]);const{name:y,database_id:i,...s}=n;return p[l].push({label:y,value:i,...s}),p},{});c(x),console.log(x)};return reactExports.useEffect(()=>{h()},[e]),jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsxs(Flex,{gap:"small",children:[jsxRuntimeExports.jsx("div",{style:{flex:1},children:jsxRuntimeExports.jsx(FormJsonComp,{formJson:e,dataMap:r})}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{a.openModal("modalE",t.databases)},children:"配置数据库"}),jsxRuntimeExports.jsx(Button,{onClick:h,size:"small",type:"primary",children:"刷新"})]})})},AnalysisSoftwarePanel=({inputFile:e,outputFile:a,pipeline:t,wrapAnalysisPipeline:r,analysisPipline:c,inputAnalysisMethod:h,analysisMethod:d,appendSampleColumns:m,analysisType:x="nonSample",children:p,cardExtra:n,upstreamFormJson:l,downstreamAnalysis:y,operatePipeline:i,...s})=>{const{project:_}=useOutletContext();reactExports.useEffect(()=>{},[]),reactExports.useRef(null);const[C,E]=reactExports.useState(),R=f=>f&&Array.isArray(f)&&f.length>0;return jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsx(Row,{children:jsxRuntimeExports.jsxs(Col,{lg:24,sm:24,xs:24,children:[jsxRuntimeExports.jsx(Card,{size:"small",style:{marginBottom:"1rem"},children:jsxRuntimeExports.jsxs(Flex,{gap:"small",style:{marginBottom:"1rem",flexWrap:"wrap"},children:[t&&jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("modalC",{data:void 0,structure:{component_type:"software",relation_type:"pipeline_software",parent_component_id:t.component_id}})},children:"新增软件"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("modalC",{data:s,structure:{component_type:"software"}})},children:"更新软件"}),t&&jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:"pipeline_software",parent_component_id:t.component_id}})},children:"添加软件"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("modalA",{data:s,pipelineStructure:{relation_type:"pipeline_software"}})},children:"替换软件"}),jsxRuntimeExports.jsx(Popconfirm,{title:"是否移除文件?",onConfirm:()=>{i.deletePipelineRelation(s.relation_id)},children:jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",children:"移除软件"})})]}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("modalB",{module_type:"nextflow",file_type:"nf",module_name:c,component_id:s.component_id})},children:"组件代码"}),s.databases&&jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("modalE",s.databases)},children:"配置数据库"}),jsxRuntimeExports.jsx(RefIcon$1,{onClick:()=>{i.openModal("descriptionModal",s.description)},style:{cursor:"pointer"}})]})}),R(e)?jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsx(UpstreamAnalysisInput,{...s,pipeline:t,record:C,onClickItem:E,project:_,operatePipeline:i,cardExtra:n,upstreamFormJson:l,analysisPipline:c,analysisMethod:d,inputAnalysisMethod:e})}):jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsxs(Flex,{justify:"center",style:{margin:"2rem"},gap:"small",children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("modalC",{data:void 0,structure:{relation_type:"software_input_file",parent_component_id:s.component_id,component_type:"file"}})},children:"新增文件"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:"software_input_file",parent_component_id:s.component_id}})},children:"添加文件"})]})}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),R(a)?jsxRuntimeExports.jsx(UpstreamAnalysisOutput,{...s,pipeline:t,software:{pipeline_id:s.pipeline_id,component_id:s.component_id},children:p,onClickItem:E,downstreamAnalysis:y,operatePipeline:i,project:_,analysisType:x,analysisMethod:a,appendSampleColumns:m}):jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsxs(Flex,{justify:"center",style:{margin:"2rem"},gap:"small",children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("modalC",{data:void 0,structure:{relation_type:"software_output_file",parent_component_id:s.component_id,component_type:"file"}})},children:"新增文件"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:"software_output_file",parent_component_id:s.component_id}})},children:"添加文件"})]})})]})})})},UpstreamAnalysisInput=({record:e,pipeline:a,operatePipeline:t,project:r,markdown:c,analysisPipline:h,upstreamFormJson:d,inputAnalysisMethod:m,onClickItem:x,cardExtra:p,...n})=>{const[l]=Form.useForm(),[y,i]=reactExports.useState(),[s,_]=staticMethods.useMessage(),[C,E]=reactExports.useState(!1),R=Form.useWatch(o=>o==null?void 0:o.analysis_id,l),[f,S]=reactExports.useState(),[w,b]=reactExports.useState(),[D,B]=Modal.useModal(),{projectObj:T}=useOutletContext(),v=reactExports.useRef(null),M=o=>{const u=m.map(g=>g.component_id);return{...o,project:r,component_id:n.component_id,data_component_ids:JSON.stringify(u)}},F=async o=>{var g;const u=await l.validateFields(),A=M(u);E(!0);try{const j=await axios.post(`/fast-api/analysis-controller?save=${o}`,A);console.log(j),o?(s.success("执行成功!"),v.current&&v.current.reload()):t.openModal("modalF",j.data)}catch(j){console.log(j),(g=j.response)!=null&&g.data&&s.error(j.response.data.detail)}E(!1)},I={host_genome_index:[{label:"人类",value:"/data/metagenome_data/bowtie2_index/human/human38"},{label:"小鼠",value:"/data/databases/mouse/bowtie2/Mus_musculus.GRCm39.dna_sm.toplevel.fa"}]};return jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[_,B,!(n!=null&&n.hiddenUpstreamAnalysis)&&jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx(Form,{form:l,children:jsxRuntimeExports.jsx(Collapse,{style:{marginTop:"1rem"},size:"small",items:[{key:"1",label:`执行分析 (${n.component_name})`,children:jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[m&&jsxRuntimeExports.jsx(ResultList,{...n,pipeline:a,software:n,currentAnalysisMethod:w,setCurrentAnalysisMethod:b,operatePipeline:t,relationType:"software_input_file",cardExtra:p,title:`输入文件 ${m.length>0?"":m.map(o=>o.label)}`,activeTabKey:f,setActiveTabKey:S,shouldTrigger:!0,analysisType:"sample",analysisMethod:m,setResultTableList:i}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),jsxRuntimeExports.jsxs(Spin,{spinning:C,children:[jsxRuntimeExports.jsx(Form.Item,{name:"analysis_id",label:"分析ID",children:jsxRuntimeExports.jsx(Input,{disabled:!0})}),jsxRuntimeExports.jsx(Form.Item,{initialValue:`${n.component_name}`,name:"analysis_name",label:"分析名称",rules:[{required:!0,message:"该字段不能为空!"}],children:jsxRuntimeExports.jsx(Input,{})}),jsxRuntimeExports.jsx(FormJsonComp,{formJson:[{name:"group_field",label:"分组列",rules:[{required:!0,message:"该字段不能为空!"}],type:"GroupFieldSelect"}],dataMap:[]}),jsxRuntimeExports.jsx(FormJsonComp,{formJson:m,dataMap:y}),jsxRuntimeExports.jsx(BioDatabaseForm,{software:n,operatePipeline:t,formJson:n.databases}),d&&jsxRuntimeExports.jsx(FormJsonComp,{formJson:d,dataMap:I}),jsxRuntimeExports.jsxs(Flex,{gap:"small",children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{F(!1)},children:"查看参数"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>F(!0),children:R?jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:"更新分析"}):jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:"保存分析"})}),R&&jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>l.setFieldValue("analysis_id",void 0),children:"取消更新"})]}),jsxRuntimeExports.jsx(Collapse,{ghost:!0,items:[{key:"1",label:"更多",children:jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsx(Form.Item,{noStyle:!0,shouldUpdate:!0,children:()=>jsxRuntimeExports.jsx(Typography,{children:jsxRuntimeExports.jsx("pre",{children:JSON.stringify(M(l.getFieldsValue()),null,2)})})})})}]}),jsxRuntimeExports.jsx(AnalysisResultView,{plotLoading:!1,markdown:c})]})]})}]})}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),jsxRuntimeExports.jsx(ResultList$1,{project:r,ref:v,shouldTrigger:!0,software:n,component_id:n==null?void 0:n.component_id,operatePipeline:t,editParams:o=>{const u=JSON.parse(o.request_param);console.log(u),l.resetFields(),l.setFieldsValue(u),o!=null&&o.id&&l.setFieldValue("analysis_id",o==null?void 0:o.analysis_id),o.dataType="analysis",x(o)}}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}})]})]})},UpstreamAnalysisOutput=({pipeline,operatePipeline,children,project,onClickItem,analysisType,analysisMethod,appendSampleColumns,script,...rest})=>{const[form]=Form.useForm(),[record,setRecord]=reactExports.useState(),[filePlot,setFilePlot]=reactExports.useState(),[plotLoading,setPlotLoading]=reactExports.useState(!1),[formDom,setFormDom]=reactExports.useState(),[formJson,setFormJson]=reactExports.useState(),[sampleSelectComp,setSampleSelectComp]=reactExports.useState(!1),{Search}=Input,[messageApi,contextHolder]=staticMethods.useMessage(),[moduleName,setModuleName]=reactExports.useState(),[params,setParams]=reactExports.useState(),[downstreamData,setDownstreamData]=reactExports.useState(),[resultTableList,setResultTableList]=reactExports.useState([]),[saveAnalysisMethod,setSaveAnalysisMethod]=reactExports.useState(),[collapseActiveKey,setCollapseActiveKey]=reactExports.useState("1"),[activeTabKey,setActiveTabKey]=reactExports.useState(),[currentAnalysisMethod,setCurrentAnalysisMethod]=reactExports.useState(),[sampleGroupJSON,setSampleGroupJSON]=reactExports.useState(),[btnName,setBtnName]=reactExports.useState(),[origin,setOrigin]=reactExports.useState(!1),tableRef=reactExports.useRef(null),[sampleGroupApI,setSampleGroupApI]=reactExports.useState(!1),plot=async({name,origin=!1,url,moduleName,params,paramsFun,formDom,formJson,saveAnalysisMethod,sampleSelectComp=!1,sampleGroupJSON=!0,sampleGroupApI=!1,...rest})=>{if(cleanDom(),setCollapseActiveKey("1"),setDownstreamData({...rest,moduleName}),setFormDom(formDom),setModuleName(moduleName),setParams(params),setSampleGroupApI(sampleGroupApI),setFilePlot(void 0),setOrigin(origin),form.resetFields(),form.setFieldValue("analysis_name",name),setFormJson(formJson),setSampleSelectComp(sampleSelectComp),setSampleGroupJSON(sampleGroupJSON),paramsFun&&(paramsFun=eval(paramsFun),params=paramsFun(record),console.log(params),setParams(params)),saveAnalysisMethod&&setSaveAnalysisMethod(saveAnalysisMethod),origin){const e=await axios.post(`/fast-api/file-parse-plot/${moduleName}`,{...params,is_save_analysis_result:!1,origin:!0});console.log(e),setFilePlot(e.data)}},cleanDom=()=>{setFormDom(void 0),setFilePlot(void 0),setDownstreamData(void 0),setSaveAnalysisMethod(void 0)},getScript=e=>{const{name:a,analysisType:t,...r}=e;return record&&t=="one"?jsxRuntimeExports.jsxs(Button,{size:"small",color:"purple",variant:(downstreamData==null?void 0:downstreamData.component_id)==r.component_id?"solid":"filled",onClick:()=>plot({...r,name:r.component_name}),children:[r.component_name,"(",record.sample_name,")"]}):jsxRuntimeExports.jsx(Button,{size:"small",color:"primary",variant:(downstreamData==null?void 0:downstreamData.component_id)==r.component_id?"solid":"filled",onClick:()=>plot({...r,name:r.component_name}),children:r.component_name})},[componentIds,setComponentIds]=reactExports.useState();reactExports.useEffect(()=>{const e=analysisMethod.filter(t=>t.downstreamAnalysis).map(t=>t.downstreamAnalysis).flat();console.log(e);const a=e.map(t=>t.component_id);a.length>0&&setComponentIds(a)},[analysisMethod]),reactExports.useEffect(()=>{script&&(plot({...script,name:script.name}),setComponentIds([script.component_id]))},[script]);const[scriptMap,setScriptMap]=reactExports.useState();return reactExports.useEffect(()=>{const a=analysisMethod.filter(t=>"downstreamAnalysis"in t).map(t=>t.downstreamAnalysis).flat(1/0).reduce((t,r)=>(t[r.component_id]=r,t),{});setScriptMap(a)},[analysisMethod]),jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[contextHolder,analysisMethod&&Array.isArray(analysisMethod)&&analysisMethod.length>0&&jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsx(ResultList,{...rest,pipeline,software:rest,currentAnalysisMethod,setCurrentAnalysisMethod,operatePipeline,relationType:"software_output_file",title:`输出文件 ${analysisMethod.length>0?"":analysisMethod.map(e=>e.name)}`,appendSampleColumns,activeTabKey,setActiveTabKey,cleanDom,analysisType:"sample",analysisMethod,shouldTrigger:!0,form,setResultTableList,setRecord:e=>{setRecord(e)}})}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),jsxRuntimeExports.jsxs(Flex,{style:{marginBottom:"1rem"},gap:"small",children:[(currentAnalysisMethod==null?void 0:currentAnalysisMethod.downstreamAnalysis)&&(currentAnalysisMethod==null?void 0:currentAnalysisMethod.downstreamAnalysis.map((e,a)=>jsxRuntimeExports.jsx("span",{children:getScript(e)},a))),script?jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{}):jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{operatePipeline.openModal("modalC",{data:void 0,structure:{relation_type:"file_script",parent_component_id:currentAnalysisMethod.component_id,component_type:"script"}})},children:"新增分析"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{operatePipeline.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:"file_script",parent_component_id:currentAnalysisMethod.component_id}})},children:"添加分析"}),(downstreamData==null?void 0:downstreamData.component_id)&&jsxRuntimeExports.jsx(RefIcon,{onClick:()=>{setDownstreamData(void 0)}})]})]}),children&&React.cloneElement(children,{record,plot,cleanDom,form,activeTabKey,resultTableList}),jsxRuntimeExports.jsx("div",{children:downstreamData&&jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsx(Collapse,{style:{marginTop:"1rem"},defaultActiveKey:["1"],size:"small",items:[{key:"1",label:jsxRuntimeExports.jsxs(Tooltip,{title:jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsxs("ul",{children:[jsxRuntimeExports.jsxs("li",{children:["software:",rest==null?void 0:rest.component_id]}),jsxRuntimeExports.jsxs("li",{children:["file:",currentAnalysisMethod==null?void 0:currentAnalysisMethod.component_id]}),jsxRuntimeExports.jsxs("li",{children:["script:",downstreamData==null?void 0:downstreamData.component_id]})]})}),children:["执行分析",downstreamData?`(${downstreamData.component_name})`:""]}),children:jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsxs(Flex,{gap:"small",children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{operatePipeline.openModal("modalB",{component_id:downstreamData.component_id})},children:"组件代码"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{operatePipeline.openModal("modalC",{data:downstreamData,structure:{component_type:"script"}})},children:"更新分析"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{operatePipeline.openModal("modalA",{data:downstreamData,pipelineStructure:{relation_type:"file_script",pipeline_id:pipeline.component_id}})},children:"替换分析"}),jsxRuntimeExports.jsx(Popconfirm,{title:"确认删除!",onConfirm:()=>{operatePipeline.deletePipelineRelation(downstreamData.relation_id),setBtnName(void 0)},children:jsxRuntimeExports.jsx(Button,{size:"small",color:"danger",variant:"solid",children:"删除分析"})}),jsxRuntimeExports.jsx(RefIcon$1,{onClick:()=>{operatePipeline.openModal("descriptionModal",downstreamData.description)},style:{cursor:"pointer"}})]}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),jsxRuntimeExports.jsx(AnalysisForm,{...downstreamData,pipeline,form,resultTableList,formJson,formDom,sampleGroupApI,operatePipeline,params,name:btnName,setPlotLoading,dataComponentIds:[currentAnalysisMethod==null?void 0:currentAnalysisMethod.component_id],inputAnalysisMethod:currentAnalysisMethod,saveAnalysisMethod,project,setFilePlot,callback:()=>{tableRef.current&&tableRef.current.reload()},plotReloadTable:()=>{tableRef.current&&tableRef.current.reload()}})]})}]})})}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),componentIds&&jsxRuntimeExports.jsx(ResultList$1,{project,ref:tableRef,shouldTrigger:!0,software:downstreamData,component_ids:componentIds,operatePipeline,editParams:e=>{if(e.component_id in scriptMap){plot({...scriptMap[e.component_id]});const a=JSON.parse(e.request_param);console.log(a),form.resetFields(),form.setFieldsValue(a),e!=null&&e.analysis_id&&form.setFieldValue("analysis_id",e==null?void 0:e.analysis_id)}},setRecord:e=>{}})]})};export{AnalysisSoftwarePanel as A,UpstreamAnalysisOutput as U,UpstreamAnalysisInput as a};
